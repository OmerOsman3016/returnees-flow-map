<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  <title>Sudan | Displacement Tracking Matrix - Returnees Flow</title>

  <!-- External CSS libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    /* CSS Variables for consistent colors and styling */
    :root {
      /* Primary color palette */
      --primary-color: #418FDE;
      --primary-dark: #2a6fbb;
      --primary-light: #82C4FF;
      --primary-very-light: #d9e0f1;
      
      /* Secondary color palette */
      --secondary-color: #FF671F;
      --secondary-dark: #d22630;
      --secondary-light: #ffb81c;
      
      /* Neutral colors */
      --neutral-dark: #333333;
      --neutral-medium: #555555;
      --neutral-light: #f8f9fa;
      --white: #FFFFFF;
      
      /* Visualization specific colors */
      --idp-color: var(--primary-color);
      --returnee-color: var(--secondary-color);
      
      /* Spacing variables */
      --spacing-xs: 5px;
      --spacing-sm: 10px;
      --spacing-md: 15px;
      --spacing-lg: 20px;
      --spacing-xl: 30px;
      
      /* Border radius */
      --border-radius-sm: 4px;
      --border-radius-md: 8px;
      
      /* Box shadow */
      --box-shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
      --box-shadow-md: 0 4px 8px rgba(0, 0, 0, 0.1);
      --box-shadow-lg: 0 6px 12px rgba(0, 0, 0, 0.15);
      
      /* Font sizes */
      --font-size-xs: 12px;
      --font-size-sm: 14px;
      --font-size-md: 16px;
      --font-size-lg: 18px;
      --font-size-xl: 24px;
      --font-size-xxl: 30px;
      
      /* Animation durations */
      --animation-short: 0.3s;
      --animation-medium: 0.8s;
      --animation-long: 1.5s;
    }

    /* Loading spinner styles */
    #loading-spinner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity var(--animation-short) ease-out;
    }
    
    .spinner {
      width: 80px;
      height: 80px;
      position: relative;
      margin-bottom: var(--spacing-lg);
    }
    
    .spinner-dot {
      position: absolute;
      width: 16px;
      height: 16px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: spinner-animation 2s infinite ease-in-out;
    }
    
    .spinner-dot:nth-child(1) {
      top: 0;
      left: 32px;
      animation-delay: 0s;
    }
    
    .spinner-dot:nth-child(2) {
      top: 8px;
      left: 8px;
      animation-delay: -0.4s;
    }
    
    .spinner-dot:nth-child(3) {
      top: 32px;
      left: 0;
      animation-delay: -0.8s;
    }
    
    .spinner-dot:nth-child(4) {
      top: 56px;
      left: 8px;
      animation-delay: -1.2s;
    }
    
    .spinner-dot:nth-child(5) {
      top: 64px;
      left: 32px;
      animation-delay: -1.6s;
    }
    
    .spinner-dot:nth-child(6) {
      top: 56px;
      left: 56px;
      animation-delay: -2s;
    }
    
    .spinner-dot:nth-child(7) {
      top: 32px;
      left: 64px;
      animation-delay: -2.4s;
    }
    
    .spinner-dot:nth-child(8) {
      top: 8px;
      left: 56px;
      animation-delay: -2.8s;
    }
    
    @keyframes spinner-animation {
      0%, 100% {
        transform: scale(0.1);
        opacity: 0.5;
      }
      50% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .loading-text {
      font-size: var(--font-size-lg);
      color: var(--primary-color);
      font-weight: bold;
      margin-top: var(--spacing-lg);
      text-align: center;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
    }
    
    .loading-progress {
      width: 200px;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 15px;
      overflow: hidden;
    }
    
    .loading-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    /* General body styling */
    body {
      margin: var(--spacing-lg);
      padding: 0;
      font-family: Arial, sans-serif;
      background: var(--white);
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.6;
      letter-spacing: 0.5px;
      font-size: var(--font-size-md);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      opacity: 0;
      animation: fadeIn var(--animation-long) ease-in-out forwards;
      color: var(--neutral-medium);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    *, *::before, *::after { box-sizing: inherit; }

    a {
      color: var(--primary-dark);
      text-decoration: none;
      transition: color var(--animation-short) ease;
    }

    a:hover { color: var(--primary-color); }

    /* Custom scrollbar */
    body::-webkit-scrollbar { width: 10px; }
    body::-webkit-scrollbar-track { background: var(--neutral-light); }
    body::-webkit-scrollbar-thumb { background: #888; border-radius: 5px; }
    body::-webkit-scrollbar-thumb:hover { background: #555; }
  
    /* Slideshow container */
    .slideshow-container {
      max-width: 100%;
      position: relative;
      margin: var(--spacing-lg) 0;
    }

    /* Slides */
    .slide {
      display: none;
      width: 100%;
      text-align: center;
    }

    .slide img {
      width: 100%;
      max-height: 500px;
      object-fit: cover;
      border-radius: var(--border-radius-md);
      box-shadow: var(--box-shadow-md);
    }

    /* Next & previous buttons */
    .prev, .next {
      cursor: pointer;
      position: absolute;
      top: 50%;
      width: auto;
      padding: 16px;
      margin-top: -22px;
      color: var(--white);
      font-weight: bold;
      font-size: var(--font-size-lg);
      transition: 0.6s ease;
      border-radius: 0 3px 3px 0;
      background-color: rgba(0,0,0,0.3);
    }

    /* Position the "next button" to the right */
    .next {
      right: 0;
      border-radius: 3px 0 0 3px;
    }

    /* On hover, add a black background color with a little bit see-through */
    .prev:hover, .next:hover {
      background-color: rgba(0,0,0,0.8);
    }

    /* The dots/bullets/indicators */
    .dots {
      text-align: center;
      margin-top: var(--spacing-md);
    }

    .dot {
      cursor: pointer;
      height: 13px;
      width: 13px;
      margin: 0 2px;
      background-color: #bbb;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.6s ease;
    }

    .active, .dot:hover {
      background-color: #717171;
    }

    /* Fading animation */
    .fade {
      animation-name: fade;
      animation-duration: 1.5s;
    }

    @keyframes fade {
      from {opacity: .4} 
      to {opacity: 1}
    }

    /* Title Container with Logo, Title, and Info Card */
    #title-container {
      display: flex;
      align-items: center;
      background-color: var(--primary-color);
      padding: var(--spacing-sm) var(--spacing-lg);
      color: var(--white);
      margin-bottom: var(--spacing-lg);
      border-radius: var(--border-radius-md);
      box-shadow: var(--box-shadow-sm);
      flex-wrap: wrap;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp var(--animation-medium) ease-in-out forwards;
      animation-delay: 0.2s;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .title-image {
      width: 220px;
      height: 90px;
      margin-right: var(--spacing-xs);
      border-radius: 5px;
    }

    #title {
      flex: 1;
      text-align: left;
    }

    #title h1 {
      margin: 0;
      font-size: var(--font-size-xxl);
      font-weight: bold;
      border-bottom: 3px solid var(--white);
      padding-bottom: var(--spacing-xs);
      display: inline-block;
    }

    #title h2 {
      margin: 0;
      font-size: var(--font-size-xl);
      font-weight: normal;
      color: #f0f0f0;
    }

    /* Consistent title styling for all sections */
    h2 {
      color: var(--primary-light);
      font-size: var(--font-size-lg);
      font-weight: bold;
      text-align: left;
      border-bottom: 2px solid var(--primary-color);
      margin-bottom: var(--spacing-md);
    }

    /* Description container styling */
    #description-container {
      display: flex;
      background-color: var(--white);
      border: 1px solid var(--primary-very-light);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-sm) var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--box-shadow-sm);
      font-family: Arial, sans-serif;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp var(--animation-medium) ease-in-out forwards;
      animation-delay: 0.4s;
    }

    #description-container p {
      font-size: var(--font-size-sm);
      line-height: 1.6;
      color: var(--neutral-medium);
      margin-bottom: var(--spacing-md);
    }

    #description-container strong { color: var(--neutral-dark); font-weight: 600; }
    #description-container .data-point { color: var(--primary-color); font-weight: 600; }

    /* Dashboard Cards Styling */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp var(--animation-medium) ease-in-out forwards;
      animation-delay: 0.6s;
    }

    .dashboard-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: var(--border-radius-md);
      box-shadow: var(--box-shadow-md);
      padding: var(--spacing-sm);
      transition: transform var(--animation-short) ease, box-shadow var(--animation-short) ease;
      height: 100px;
      background: var(--white);
      opacity: 0;
      transform: scale(0.9);
      animation: cardEntrance 0.5s ease-in-out forwards;
    }

    @keyframes cardEntrance {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .dashboard-card:hover { 
      transform: translateY(-3px); 
      box-shadow: var(--box-shadow-lg); 
    }

    .card-content { flex: 1; }
    .card-content h2 { 
      margin: 0; 
      font-size: 2em; 
      color: var(--white); 
      border-bottom: none;
    }
    .card-content p { margin: 4px 0 0; color: var(--white); font-size: 1em; }
    .card-image { display: flex; align-items: center; justify-content: flex-end; width: 60px; margin-left: var(--spacing-sm); }
    .card-icon { width: 40px; height: 40px; }

    /* Staggered delays for dashboard cards */
    .dashboard-card:nth-child(1) { animation-delay: 0.7s; }
    .dashboard-card:nth-child(2) { animation-delay: 0.8s; }
    .dashboard-card:nth-child(3) { animation-delay: 0.9s; }
    .dashboard-card:nth-child(4) { animation-delay: 1.0s; }
    .dashboard-card:nth-child(5) { animation-delay: 1.1s; }

    /* Parent Container for Text and Map */
    .idps-frame-container {
      display: flex;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp var(--animation-medium) ease-in-out forwards;
      animation-delay: 0.8s;
    }

    /* Text Container for Total Number of IDPs by STATE */
    #idps-text-container {
      flex: 1;
      background-color: var(--white);
      border: 1px solid var(--primary-very-light);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-sm);
      box-shadow: var(--box-shadow-sm);
    }

    #idps-text-container p {
      font-size: var(--font-size-sm);
      line-height: 1.6;
      color: var(--neutral-medium);
      margin-bottom: var(--spacing-md);
    }

    #idps-text-container ul {
      list-style-type: disc;
      margin-left: var(--spacing-lg);
      color: var(--neutral-medium);
    }

    #idps-text-container ul li {
      margin-bottom: var(--spacing-xs);
    }

    #idps-text-container strong {
      color: var(--neutral-dark);
      font-weight: 600;
    }

    /* Map Container for Total Number of IDPs by STATE */
    #map-container-3 {
      flex: 2;
      background-color: var(--white);
      border: 1px solid var(--primary-very-light);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-sm);
      box-shadow: var(--box-shadow-sm);
    }

    #map3 {
      width: 100%;
      height: 80vh;
      border-radius: var(--border-radius-md);
    }

    /* Maps container styling */
    .maps-container {
      display: flex;
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp var(--animation-medium) ease-in-out forwards;
      animation-delay: 0.8s;
    }

    #map-container, #map-container-2, #map-container-4 {
      flex: 1;
      background-color: var(--white);
      border: 1px solid var(--primary-very-light);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-sm);
      box-shadow: var(--box-shadow-sm);
    }

    #map, #map2, #map4 {
      width: 100%;
      height: 80vh;
      border-radius: var(--border-radius-md);
    }

    /* Mobility in Sudan Text Container */
    #mobility-text-container {
      flex: 1;
      background-color: var(--white);
      border: 1px solid var(--primary-very-light);
      border-radius: var(--border-radius-md);
      padding: var(--spacing-lg);
      box-shadow: var(--box-shadow-sm);
      font-size: var(--font-size-sm);
      line-height: 1.6;
      color: var(--neutral-medium);
    }

    #mobility-text-container h2 {
      color: var(--primary-light);
      font-size: var(--font-size-lg);
      font-weight: bold;
      text-align: left;
      border-bottom: 2px solid var(--primary-color);
      margin-bottom: var(--spacing-xs);
    }

    #mobility-text-container p {
      margin-bottom: var(--spacing-md);
    }

    #mobility-text-container strong {
      color: var(--neutral-dark);
      font-weight: 600;
    }

    #mobility-text-container .data-point {
      color: var(--primary-color);
      font-weight: 600;
    }

    /* Pie Chart Map Showing Displacement Proportions */
    #map5 {
      height: 600px;
      border-radius: var(--border-radius-md);
      margin: var(--spacing-lg) 0;
    }
    
    .legend {
      background: var(--white);
      padding: var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }

    /* Country Circle Map Styles */
    #country-circle-map {
      height: 600px;
      border-radius: var(--border-radius-md);
      margin: var(--spacing-lg) 0;
      margin-top: var(--spacing-lg);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xl);
    }

    /* Drill-down back button */
    .drilldown-back {
      position: absolute;
      top: var(--spacing-sm);
      left: var(--spacing-sm);
      z-index: 1000;
      background: var(--primary-color);
      color: var(--white);
      border: none;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      display: none;
    }

    .drilldown-back:hover {
      background: var(--primary-dark);
    }

    /* Heatmap controls styling */
    .heatmap-control-button {
      background-color: var(--primary-color);
      color: var(--white);
      border: none;
      padding: 8px 15px;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: var(--font-size-sm);
      transition: background-color var(--animation-short);
    }

    .heatmap-control-button:hover {
      background-color: var(--primary-dark);
    }

    #heatmap-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: var(--spacing-md);
    }

    #heatmap-slider {
      flex-grow: 1;
      margin: 0 var(--spacing-md);
    }

    #heatmap-time-display {
      min-width: 80px;
      text-align: center;
    }
    
    /* Footer styling */
    footer {
      background-color: var(--primary-color);
      color: var(--white);
      text-align: center;
      padding: var(--spacing-sm);
      margin-top: var(--spacing-lg);
      font-size: var(--font-size-xs);
      border-radius: var(--border-radius-md);
      box-shadow: var(--box-shadow-sm);
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp var(--animation-medium) ease-in-out forwards;
      animation-delay: 1.4s;
    }

    /* Responsive design for smaller screens */
    @media (max-width: 768px) {
      #title-container { 
        flex-direction: column; 
        align-items: flex-start; 
        padding: var(--spacing-sm);
      }
      
      #title h1 {
        font-size: var(--font-size-xl);
      }
      
      #title h2 {
        font-size: var(--font-size-lg);
      }
      
      .content-container { 
        flex-direction: column; 
      }
      
      #map, #map2, #map3, #map4, #map5, #country-circle-map { 
        height: 60vh; 
      }

      .idps-frame-container,
      .maps-container {
        flex-direction: column;
        gap: var(--spacing-md);
      }

      #idps-text-container,
      #map-container-3,
      #map-container,
      #map-container-2,
      #map-container-4 {
        flex: 1;
        width: 100%;
      }
      
      /* Adjust slideshow for mobile */
      .slide img {
        max-height: 300px;
      }
      
      .prev, .next {
        padding: var(--spacing-sm);
        font-size: var(--font-size-md);
      }
      
      /* Adjust loading spinner for mobile */
      .spinner {
        width: 60px;
        height: 60px;
      }
      
      .spinner-dot {
        width: 12px;
        height: 12px;
      }
      
      .loading-text {
        font-size: var(--font-size-md);
      }

      /* Adjust heatmap controls for mobile */
      #heatmap-controls {
        flex-direction: column;
        align-items: stretch;
      }

      #heatmap-slider {
        width: 100%;
        margin: var(--spacing-sm) 0;
      }

      #heatmap-time-display {
        margin: var(--spacing-xs) 0;
      }
      
      /* Adjust dashboard cards for mobile */
      .dashboard-cards {
        grid-template-columns: 1fr;
      }
      
      .dashboard-card {
        height: 80px;
      }
    }

    /* Accessibility improvements */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }
    
    /* Focus styles for keyboard navigation */
    a:focus, button:focus, input:focus, [tabindex]:focus {
      outline: 3px solid var(--primary-light);
      outline-offset: 2px;
    }
    
    /* High contrast mode support */
    @media (forced-colors: active) {
      .dashboard-card, .heatmap-control-button, .drilldown-back {
        border: 1px solid CanvasText;
      }
    }

    @media print {
      body { 
        font-size: 12pt; 
        color: #000; 
      }
      .dashboard-cards, .maps-container { 
        page-break-inside: avoid; 
      }
      footer { 
        display: none; 
      }
      
      /* Ensure maps print properly */
      #map, #map2, #map3, #map4, #map5, #country-circle-map {
        height: 400px;
        page-break-inside: avoid;
      }
    }
  </style>
</head>

<body>
  <!-- Loading Spinner -->
  <div id="loading-spinner" role="progressbar" aria-label="Loading data">
    <div class="spinner">
      <div class="spinner-dot"></div>
      <div class="spinner-dot"></div>
      <div class="spinner-dot"></div>
      <div class="spinner-dot"></div>
      <div class="spinner-dot"></div>
      <div class="spinner-dot"></div>
      <div class="spinner-dot"></div>
      <div class="spinner-dot"></div>
    </div>
    <div class="loading-text">Loading Displacement Data...</div>
    <div class="loading-progress">
      <div class="loading-progress-bar" id="progress-bar"></div>
    </div>
  </div>

  <!-- Dashboard Section -->
  <div id="dashboard-section">
    <!-- Title Container with Logo, Title, and Info Card -->
    <div id="title-container">
      <div id="title">
        <h1>SUDAN | DISPLACEMENT TRACKING MATRIX - SUDAN MOBILITY</h1>
        <h2><strong>Two Years of Displacement</strong></h2>
      </div>
      <!-- Add this image element to the right side of the title -->
      <img src="./data/IOM_DTM_WHITE.png" alt="IOM Logo" class="title-image">
    </div>
    
    <!-- Slideshow Gallery -->
    <div class="slideshow-container" role="region" aria-label="Displacement images slideshow">
      <div class="slide fade">
        <img src="./data/image5.jpg" alt="Displaced people in Sudan - scene 1">
      </div>
      
      <div class="slide fade">
        <img src="./data/image5.jpg" alt="Displaced people in Sudan - scene 2">
      </div>
      
      <div class="slide fade">
        <img src="./data/image5.jpg" alt="Displaced people in Sudan - scene 3"> 
      </div>
      
      <!-- Next and previous buttons -->
      <a class="prev" onclick="plusSlides(-1)" aria-label="Previous slide">❮</a>
      <a class="next" onclick="plusSlides(1)" aria-label="Next slide">❯</a>
    </div>
    
    <!-- The dots/circles -->
    <div class="dots">
      <span class="dot" onclick="currentSlide(1)" aria-label="Go to slide 1" tabindex="0"></span> 
      <span class="dot" onclick="currentSlide(2)" aria-label="Go to slide 2" tabindex="0"></span> 
      <span class="dot" onclick="currentSlide(3)" aria-label="Go to slide 3" tabindex="0"></span> 
    </div>

    <!-- Dashboard Cards Container -->
    <div class="dashboard-cards" role="region" aria-label="Key displacement statistics">
      <!-- Card 1: Internally Displaced Persons -->
      <div class="dashboard-card" style="background-color: var(--primary-color); color: var(--white);">
        <div class="card-content">
          <h2>11,301,340</h2>
          <p>Internally Displaced </p>
        </div>
        <div class="card-image">
          <img src="./data/Internally displaced.png" alt="IDP Icon" class="card-icon">
        </div>
      </div>

      <!-- Card 2: Returnees -->
      <div class="dashboard-card" style="background-color: var(--secondary-color); color: var(--white);">
        <div class="card-content">
          <h2>396,738</h2>
          <p>Returnees</p>
        </div>
        <div class="card-image">
          <img src="./data/Returnees.png" alt="Returnee Icon" class="card-icon">
        </div>
      </div>

      <!-- Card 3: Crossing Border -->
      <div class="dashboard-card" style="background-color: var(--primary-light); color: var(--white);">
        <div class="card-content">
          <h2>3,934,086</h2>
          <p> Crossing Border</p>
        </div>
        <div class="card-image">
          <img src="./data/Crossing Border.png" alt="Border Crossing Icon" class="card-icon">
        </div>
      </div>

      <!-- Card 4: Migrants Affected -->
      <div class="dashboard-card" style="background-color: var(--secondary-light); color: var(--neutral-dark);">
        <div class="card-content">
          <h2>400,000</h2>
          <p>Migrants Affected</p>
        </div>
        <div class="card-image">
          <img src="./data/Migrants Affected.png" alt="Migrant Icon" class="card-icon">
        </div>
      </div>

      <!-- Card 5: Locations Covered -->
      <div class="dashboard-card" style="background-color: var(--primary-dark); color: var(--white);">
        <div class="card-content">
          <h2>10,285</h2>
          <p>Locations Covered</p>
        </div>
        <div class="card-image">
          <img src="./data/Location.png" alt="Location Icon" class="card-icon">
        </div>
      </div>
    </div>
  </div>
    <!-- Heatmap Section -->
  <div id="heatmap-section" class="maps-container">
    <div id="heatmap-container">
      <h2>Mobility Over Time (2023 - 2025)</h2>
      <div id="mobility-text-container">
        <p>
          This interactive heatmap visualization shows the progression of displacement over time. The heat intensity represents the number of displaced persons, with darker colors indicating higher numbers. Use the time slider or play button to see how the situation evolved month by month.
        </p>
        <p>
          <strong>Key patterns to observe:</strong>
        </p>
        <ul>
          <li>The rapid increase in IDPs (blue line) in the first months of the conflict</li>
          <li>The sudden spike in May 2024 when displacement surpassed 10 million</li>
          <li>The appearance of returnees (orange line) only in the most recent data</li>
        </ul>
        <div id="heatmapChart" style="height: 400px;" aria-label="Heatmap showing displacement over time" role="img"></div>
      <div id="heatmap-controls" style="margin-top: 20px;">
        <button id="heatmap-play-button" class="heatmap-control-button" aria-label="Play animation">▶ Play</button>
        <input type="range" id="heatmap-slider" min="0" max="19" value="0" step="1" style="width: 70%; margin: 0 15px;" aria-label="Time slider">
        <span id="heatmap-time-display" style="font-weight: bold; color: var(--primary-color);">Aug-2023</span>
        <button id="heatmap-export-button" class="heatmap-control-button" aria-label="Export as image">Export as Image</button>
      </div>
    </div>
  </div>
      </div>

  <!-- IDPs Section -->
  <div id="idps-section" class="idps-frame-container">
    <!-- Text Container for Total Number of IDPs by State -->
    <div id="idps-text-container">
      <h2>CONTEXT</h2>
      <p>
       Sudan hosts an estimated 11,301,340 internally displaced
persons (IDPs) as of 30 March 2025, including those
displaced both before and after the outbreak of the conflict
between the Sudanese Armed Forces (SAF) and Rapid
Support Forces (RSF) on 15 April 2023. This report analyses displacement pathways and key
demographic information for the total population of
IDPs across Sudan, as well as data on mixed cross-border
movements into neighbouring countries.
      </p>
      <p>
        <h3>KEY FACTS AND FIGURES:</h3>
      </p>
      <ul>
        <li><strong style="color: var(--secondary-color);" >30%:</strong>  of a population is displaced both internally and externally</li>
        <li><strong style="color: var(--secondary-color);">11.3 Million </strong> people have been displaced internally across all of Sudan, highlighting a severe humanitarian crisis driven by conflict, instability, and other factors.</li>
        <li><strong style="color: var(--secondary-color);">3.9 Million </strong> people have been displaced externally from Sudan</li>
        <li><strong style="color: var(--secondary-color);">3.63 Million</strong>  IDPs are concentrated in South Darfur and North Darfur, underscoring the immense scale of displacement and humanitarian needs in these regions.</li>
        <li><strong style="color: var(--secondary-color);">4 Million</strong> IDPs live in camps across Sudan</li>
        <li><strong style="color: var(--secondary-color);">7.4 Million</strong> IDPs have been displaced from Khartoum, South Darfur, and North Darfur,</li>
      </ul>
    </div>

    <!-- Map Container for Total Number of IDPs by State -->
    <div id="map-container-3">
      <h2 id="map-title-3">Total Number of IDPs by State</h2>
      <button id="drilldown-back" class="drilldown-back" aria-label="Back to states view">← Back to States</button>
      <div id="map3" aria-label="Map showing IDPs by state" role="img"></div>
    </div>
  </div>
  
  <!-- Displacement Section -->
  <div id="displacement-section" class="maps-container">
    <div id="map-container">
      <h2>Displacement Proportions by State</h2>
      <div id="mobility-text-container">
        <p>
          This map visualizes the proportion of each state's population that has been displaced by the ongoing conflict. The pie chart markers show at a glance which states have been most severely affected, with the orange segments representing displaced populations and blue segments showing remaining residents.
        </p>
        <p>
          <strong>Key insights from the map visualization:</strong>
        </p>
        <ul>
          <li><strong>North Darfur stands out</strong> with the highest displacement proportion (66%) - nearly two-thirds of its population has been forced to flee</li>
          <li><strong>South Darfur shows</strong> the largest absolute numbers (over 2 million displaced) despite being a smaller proportion (53%) of its larger population</li>
          <li><strong>Khartoum's displacement</strong> (3.5 million people) represents 38% of the state's population, visible through the relative sizes of the pie segments</li>
          <li><strong>Northern states</strong> like Northern and Red Sea show much smaller displacement proportions (1-2%), visible through their predominantly blue pie charts</li>
        </ul>
        <p>
          <strong>How to interpret the map symbols:</strong>
        </p>
        <ul>
          <li>Each pie chart is scaled to the state's total population size</li>
          <li>Orange segments show displaced populations</li>
          <li>Blue segments show non-displaced populations</li>
          <li>The percentage label in each pie shows the exact displacement proportion</li>
          <li>Larger pies indicate states with bigger total populations</li>
        </ul>
        <p>
          The spatial distribution reveals clear patterns - states in Darfur and Khartoum show the most severe displacement, while northern and eastern states have been less affected. This visualization helps humanitarian actors quickly identify where needs are greatest and how displacement is impacting different regions proportionally.
        </p>
        <p>
          <strong>Map interaction tips:</strong>
        </p>
        <ul>
          <li>Click on any pie chart to see detailed state statistics</li>
          <li>Compare states by both segment size (proportion) and overall pie size (total population)</li>
          <li>Note the concentration of large orange segments in western Sudan</li>
        </ul>
      </div>
      <div id="map5" aria-label="Map showing displacement proportions by state" role="img"></div>
    </div>
  </div>
  
  <!-- Pathways Section -->
  <div id="pathways-section" id="map-container">
    <h2 id="map-title-2">IDPs Pathways Across Sudan</h2>
    <div id="mobility-text-container">
      <p>
        This map visualizes the complex movement patterns of Internally Displaced Persons (IDPs) across Sudan. The animated flow lines represent the pathways taken by displaced populations, with their thickness indicating the relative volume of movement between locations. The map reveals several critical displacement corridors that have emerged during the crisis.
      </p>
      <p>
        <strong>Key displacement patterns shown:</strong>
      </p>
      <ul>
        <li><strong>Mass exodus from Khartoum:</strong> Thick flow lines show the movement of over 3.5 million people from the capital to neighboring states, particularly to Aj Jazirah, Sennar, and White Nile states.</li>
        <li><strong>Darfur cross-border movements:</strong> Significant flows from Darfur states into neighboring Chad and South Sudan, with particularly heavy movement from West Darfur to Chad.</li>
        <li><strong>Secondary displacement:</strong> Many IDPs who initially fled to relatively safer areas like Aj Jazirah have been forced to move again as conflict spread.</li>
        <li><strong>Urban to rural movement:</strong> The majority of flows show displacement from urban centers to rural areas, straining already limited resources in receiving communities.</li>
      </ul>
      <p>
        <strong>How to use this map:</strong>
      </p>
      <ul>
        <li>Click on any flow line to see details about that displacement pathway</li>
        <li>Hover over origin or destination points to see total numbers</li>
        <li>Note that line thickness represents relative volume - thicker lines indicate larger numbers of displaced persons</li>
        <li>The animation direction shows the direction of displacement</li>
      </ul>
      <p>
        These displacement pathways have significant implications for humanitarian response, as they show where needs are concentrated and help predict where populations may move next based on conflict patterns and existing migration routes.
      </p>
        <div id="map2" aria-label="Map showing IDP pathways across Sudan" role="img"></div>
  </div>
    </div>
  
 
  <!-- Country Circle Propagation Map -->
  <div class="maps-container">
    <div id="map-container">
      <div id="mobility-text-container">
        <h2>Displacement to Neighboring Countries</h2>
        <p>
          The map below illustrates the significant displacement of Sudanese populations to neighboring countries since the conflict began. The size of each circle represents the relative number of displaced persons in each country, with the largest flows going to Egypt, Chad, and South Sudan. This external displacement has created regional humanitarian challenges, with over 3.9 million Sudanese refugees now living in neighboring countries.
        </p>
        <p>
          <strong>Key observations:</strong>
        </p>
        <ul>
          <li><strong>Egypt</strong> has received the largest number of displaced persons (1.5 million), representing 38% of all cross-border displacement</li>
          <li><strong>Chad</strong> hosts 767,365 Sudanese refugees, primarily from Darfur region</li>
          <li><strong>South Sudan</strong> has received 341,909 returnees and refugees despite its own humanitarian challenges</li>
          <li>Smaller but significant flows have gone to Ethiopia (88,001), Libya (105,721), and Central African Republic (35,376)</li>
        </ul>
        <p>
          These displacement patterns reflect both historical migration routes and the geographical proximity to conflict zones, with Darfur refugees primarily going to Chad, while those from eastern Sudan flee to Ethiopia and Egypt.
        </p>
      </div>
      <div id="country-circle-map" aria-label="Map showing displacement to neighboring countries" role="img"></div>
    </div>
  </div>  

  <!-- Returnees Section -->
  <div id="returnees-section" class="idps-frame-container">
    <!-- Map Container for Total Number of Returnees by State -->
    <div id="map-container-4">
      <h2 id="map-title-4">Total Number of Returnees by State</h2>
      <div id="map4" aria-label="Map showing returnees by state" role="img"></div>
    </div>

    <!-- Text Container for Mobility in Sudan -->
    <div id="mobility-text-container">
      <h2>Returns and Cross-Border Movements</h2>
      <p>Since December 2024, DTM teams have monitored 396,738 individuals returning to their places of origin in Sudan—a significant shift in displacement trends after nearly two years of conflict between the Rapid Support Forces (RSF) and Sudanese Armed Forces (SAF).</p>
      
      <h3>Primary Return Destinations</h3>
      <ul>
        <li><strong>Aj Jazirah</strong>: 66% of returnees he highest proportion of returnees, driven by improved access and relative stability </li>
        <li><strong>Sennar</strong>: 29% of returnees</li>
        <li><strong>Khartoum</strong>: 5% of returnees Limited returns to the capital reflect ongoing insecurity, infrastructure damage, and lack of basic services.</li>
      </ul>
      
     
  
      <h2>Key Findings on Returns</h2>
      <p>For the first time since the outbreak of war in April 2023, the number of internally displaced persons (IDPs) in Sudan has shown a decline, indicating early signs of return movements. However, these returns remain fragile, Many returning households are engaging in short-term visits rather than permanent resettlement, primarily to evaluate security conditions, access essential services, or retrieve belongings. This behavior indicates ongoing insecurity and a lack of confidence in long-term safety.</p>
        <p>the majority of Sudanese fleeing abroad—particularly to neighboring countries like Egypt, South Sudan, and Ethiopia—have come from Khartoum and Al Jazira states, As a result, any significant return movements from abroad will likely originate from these areas .</p>
    </div>
  </div>

  <!-- Maps Container for Returnee Pathways -->
  <div class="maps-container">
    <div id="map-container-2">
      <h2 id="map-title">Returnee Pathways Across Sudan</h2>
      <div id="map" aria-label="Map showing returnee pathways across Sudan" role="img"></div>
    </div>
  </div>
  
  <!-- Disclaimer paragraph -->
  <div style="background-color: var(--neutral-light); border-left: 4px solid var(--secondary-color); padding: 15px; margin: 20px 0; font-size: 14px; line-height: 1.6;">
    <p style="margin: 0; color: var(--neutral-medium);">
      <strong>DISCLAIMER:</strong> Due to on-going insecurity, DTM collects data through a dual 
      combination of in-person and remote interviews with key informants across its network. 
      Figures should be understood as preliminary estimates and are subject to change pending 
      future verification exercises. Percentages across the report may not equal 100 per cent 
      due to rounding.
    </p>
  </div>
</div>

  <!-- Add image above the footer -->
  <img src="./data/doner.png" alt="Donor organizations logos" style="width: 100%; height: auto; display: block; margin: 0 auto;">

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 International Organization for Migration | IOM, UN Migration. Sudan | Displacement Tracking Matrix</p>
    <div class="footer-links">
      <a href="https://dtm.iom.int/sudan" target="_blank">Visit IOM Sudan Website</a> |
      <a href="https://displacement.iom.int/" target="_blank">DTM Global Website</a>
    </div>
    <div class="footer-info">
      <p>For more information, please contact <a href="mailto:dtmsudan@iom.int">dtmsudan@iom.int</a>.</p>
    </div>
  </footer>

  <!-- External Scripts -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>

  <script>
    // Loading spinner functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Simulate loading progress
      let progress = 0;
      const progressBar = document.getElementById('progress-bar');
      const loadingSpinner = document.getElementById('loading-spinner');
      const loadingText = document.querySelector('.loading-text');
      
      // Update progress bar
      const progressInterval = setInterval(function() {
        progress += Math.random() * 10;
        if (progress >= 100) {
          progress = 100;
          clearInterval(progressInterval);
          
          // Change text when loading is complete
          loadingText.textContent = 'Almost there...';
          
          // Add a small delay before hiding to ensure everything is loaded
          setTimeout(function() {
            loadingSpinner.style.opacity = '0';
            setTimeout(function() {
              loadingSpinner.style.display = 'none';
              document.body.style.animation = 'fadeIn 1.5s ease-in-out forwards';
            }, 500);
          }, 500);
        }
        progressBar.style.width = progress + '%';
        // Update ARIA attributes for accessibility
        loadingSpinner.setAttribute('aria-valuenow', Math.round(progress));
        loadingSpinner.setAttribute('aria-valuemin', '0');
        loadingSpinner.setAttribute('aria-valuemax', '100');
      }, 200);
    });

    // Slideshow functionality with keyboard support
    let slideIndex = 1;
    showSlides(slideIndex);
    
    // Next/previous controls
    function plusSlides(n) {
      showSlides(slideIndex += n);
    }
    
    // Thumbnail image controls
    function currentSlide(n) {
      showSlides(slideIndex = n);
    }
    
    function showSlides(n) {
      let i;
      let slides = document.getElementsByClassName("slide");
      let dots = document.getElementsByClassName("dot");
      
      if (n > slides.length) {slideIndex = 1}
      if (n < 1) {slideIndex = slides.length}
      
      for (i = 0; i < slides.length; i++) {
        slides[i].style.display = "none";
        slides[i].setAttribute('aria-hidden', 'true');
      }
      
      for (i = 0; i < dots.length; i++) {
        dots[i].className = dots[i].className.replace(" active", "");
        dots[i].setAttribute('aria-current', 'false');
      }
      
      slides[slideIndex-1].style.display = "block";
      slides[slideIndex-1].setAttribute('aria-hidden', 'false');
      dots[slideIndex-1].className += " active";
      dots[slideIndex-1].setAttribute('aria-current', 'true');
    }
    
    // Add keyboard support for slideshow
    document.addEventListener('keydown', function(e) {
      if (e.key === 'ArrowLeft') {
        plusSlides(-1);
      } else if (e.key === 'ArrowRight') {
        plusSlides(1);
      }
    });
    
    // Auto-advance slides every 5 seconds
    let slideInterval = setInterval(() => {
      plusSlides(1);
    }, 5000);
    
    // Pause slideshow when user interacts with it
    document.querySelector('.slideshow-container').addEventListener('mouseover', function() {
      clearInterval(slideInterval);
    });
    
    // Resume slideshow when user stops interacting
    document.querySelector('.slideshow-container').addEventListener('mouseout', function() {
      slideInterval = setInterval(() => {
        plusSlides(1);
      }, 5000);
    });

    // Map configuration - centralized for consistency
    const mapConfig = {
      center: [16, 30],
      zoom: L.Browser.mobile ? 4 : 5.5,
      minZoom: 3,
      maxZoom: 18,
      zoomControl: true,
      attributionControl: true
    };
    
    // Color configuration - centralized for consistency
    const colorConfig = {
      idp: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
      returnee: getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim(),
      idpLight: getComputedStyle(document.documentElement).getPropertyValue('--primary-light').trim(),
      returneeLight: getComputedStyle(document.documentElement).getPropertyValue('--secondary-light').trim(),
      white: getComputedStyle(document.documentElement).getPropertyValue('--white').trim()
    };

    // Define Mapbox custom layer once and reuse
    const mapboxCustomLayer = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    // Define base layers once and reuse
    const baseLayers = {
      "Mapbox Custom": mapboxCustomLayer,
      "CartoDB Light": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }),
      "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }),
      "Esri World Imagery": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
      }),
      "Mapbox Light": L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
      })
    };

    // Initialize maps with consistent configuration
    const map = L.map('map', mapConfig);
    const map2 = L.map('map2', mapConfig);
    const map3 = L.map('map3', mapConfig);
    const map4 = L.map('map4', mapConfig);

    // Add default base layer to all maps
    mapboxCustomLayer.addTo(map);
    mapboxCustomLayer.addTo(map2);
    mapboxCustomLayer.addTo(map3);
    mapboxCustomLayer.addTo(map4);

    // Add layer control to all maps
    L.control.layers(baseLayers).addTo(map);
    L.control.layers(baseLayers).addTo(map2);
    L.control.layers(baseLayers).addTo(map3);
    L.control.layers(baseLayers).addTo(map4);

    // Reusable tooltip function
    function createTooltip(feature, layer, isReturnee = false) {
      const tooltipContent = feature.properties.isOrigin
        ? `${isReturnee ? 'Return' : 'Displacement'} From: ${feature.properties.s_State}`
        : `${isReturnee ? 'Return' : 'Displacement'} To: ${feature.properties.e_locality}`;

      layer.bindTooltip(tooltipContent, {
        className: 'custom-tooltip',
        direction: 'top',
        permanent: false,
        opacity: 0.9
      });
      
      layer.on('mouseover', () => layer.openTooltip());
      layer.on('mouseout', () => layer.closeTooltip());
      layer.on('focus', () => layer.openTooltip());
      layer.on('blur', () => layer.closeTooltip());

      // Add popup with more detailed information
      const popupContent = feature.properties.isOrigin
        ? `<div class="custom-popup">
            <h3>${isReturnee ? 'Return' : 'Displacement'} From: ${feature.properties.s_State}</h3>
            <p>Total: ${feature.properties.s_Volume?.toLocaleString() || 'N/A'} people</p>
           </div>`
        : `<div class="custom-popup">
            <h3>${isReturnee ? 'Return' : 'Displacement'} To: ${feature.properties.e_locality}</h3>
            <p>Total: ${feature.properties.e_Volume?.toLocaleString() || 'N/A'} people</p>
           </div>`;

      layer.bindPopup(popupContent);
    }

    // Reusable flow map style function
    function getFlowMapStyle(feature, isReturnee = false) {
      const baseRadius = 6;
      const maxRadius = 20;
      const volume = feature.properties.e_Volume || 0;

      const radius = feature.properties.isOrigin
        ? baseRadius
        : Math.min(baseRadius + (volume / 5000), maxRadius);

      return {
        radius: radius,
        weight: 1,
        color: colorConfig.white,
        fillColor: feature.properties.isOrigin 
          ? (isReturnee ? colorConfig.returnee : colorConfig.idp)
          : (isReturnee ? colorConfig.idp : colorConfig.returnee),
        fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
      };
    }

    // Reusable flow map bezier style
    const flowMapBezierStyle = {
      type: 'classBreaks',
      field: 'e_Volume',
      classBreakInfos: [
        { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: colorConfig.returneeLight, lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
        { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: colorConfig.returnee, lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
        { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: colorConfig.returnee, lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
      ],
      defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
    };

    // Reusable legend creation function
    function createLegend(map, title, items, position = 'bottomright') {
      const legend = L.control({ position: position });
      legend.onAdd = () => {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `<span style="font-size:14px">${title}:</span><br/>`;
        
        items.forEach(item => {
          div.innerHTML += `
            <div style="width:70px;height:${item.height}px;background:${item.color};float:left;margin-right:10px;margin-top:10px"></div>
            <span style="float:left;font-weight:bold">${item.label}</span><br/>
          `;
        });
        
        return div;
      };
      legend.addTo(map);
      return legend;
    }

    // Parse CSV data and create flow map layer for the first map (Returnee Pathways)
    Papa.parse('./data/data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        const flowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => getFlowMapStyle(feature, true),
          canvasBezierStyle: flowMapBezierStyle,
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: (feature, layer) => createTooltip(feature, layer, true)
        }).addTo(map);

        // Highlight paths on mouseover
        flowmapLayer.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
        
        // Add keyboard navigation support
        map.on('keydown', function(e) {
          if (e.originalEvent.key === 'Tab') {
            // Find the next feature to focus
            const features = flowmapLayer.getLayers();
            const currentIndex = features.findIndex(f => f._leaflet_id === document.activeElement?._leaflet_id);
            const nextIndex = (currentIndex + 1) % features.length;
            features[nextIndex].getElement().focus();
          }
        });
      }
    });

    // Add legend to the first map
    createLegend(map, 'Returnee Flow Volume', [
      { height: 3, color: colorConfig.returneeLight, label: '< 10,000' },
      { height: 4, color: colorConfig.returnee, label: '10,001 - 20,000' },
      { height: 7, color: colorConfig.returnee, label: '> 20,000' }
    ]);

    // Parse CSV data and create flow map layer for the second map (IDP Pathways)
    Papa.parse('./data/data_idps.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection2 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        const flowmapLayer2 = L.canvasFlowmapLayer(geoJsonFeatureCollection2, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => getFlowMapStyle(feature, false),
          canvasBezierStyle: {
            ...flowMapBezierStyle,
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: colorConfig.idpLight, lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: colorConfig.idp, lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: colorConfig.idp, lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
            ]
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: (feature, layer) => createTooltip(feature, layer, false)
        }).addTo(map2);

        // Highlight paths on mouseover
        flowmapLayer2.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer2.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      }
    });

    // Add legend to the second map
    createLegend(map2, 'IDP Flow Volume', [
      { height: 3, color: colorConfig.idpLight, label: '< 10,000' },
      { height: 4, color: colorConfig.idp, label: '10,001 - 20,000' },
      { height: 7, color: colorConfig.idp, label: '> 20,000' }
    ]);

    // Variables for drill-down functionality
    let stateMarkersLayer = L.layerGroup();
    let districtMarkersLayer = L.layerGroup();
    let currentState = null;
    const drilldownBackBtn = document.getElementById('drilldown-back');

    // Function to load district data for a state
    function loadDistrictData(stateName) {
      // Show loading indicator
      document.getElementById('map-title-3').textContent = `Loading districts for ${stateName}...`;
      
      // In a real application, you would load district data from your server or CSV file
      Papa.parse('./data/districts_data.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (results) => {
          // Filter districts for the selected state
          const stateDistricts = results.data.filter(d => d.state === stateName);
          
          // Clear previous district markers
          districtMarkersLayer.clearLayers();
          
          // Add district markers
          stateDistricts.forEach(district => {
            const marker = L.circleMarker([district.lat, district.lon], {
              radius: Math.sqrt(district.idps / 1000) * 2,
              fillColor: colorConfig.idp,
              color: colorConfig.white,
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            });
            
            marker.bindTooltip(`${district.name}: ${district.idps.toLocaleString()} IDPs`, {
              permanent: false,
              direction: 'top',
              className: 'district-tooltip'
            });
            
            marker.bindPopup(`
              <div class="district-popup">
                <h3>${district.name}</h3>
                <p><strong>IDPs:</strong> ${district.idps.toLocaleString()}</p>
                <p><strong>Population:</strong> ${district.population.toLocaleString()}</p>
                <p><strong>Displacement %:</strong> ${(district.idps / district.population * 100).toFixed(1)}%</p>
              </div>
            `);
            
            districtMarkersLayer.addLayer(marker);
          });
          
          // Add district markers layer to map
          districtMarkersLayer.addTo(map3);
          
          // Update title and show back button
          document.getElementById('map-title-3').textContent = `Districts in ${stateName}`;
          drilldownBackBtn.style.display = 'block';
          
          // Store current state for back button
          currentState = stateName;
        }
      });
    }

    // Load state data for IDPs map
    Papa.parse('./data/states_data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        // Clear previous state markers
        stateMarkersLayer.clearLayers();
        
        // Add state markers
        results.data.forEach(state => {
          const marker = L.circleMarker([state.lat, state.lon], {
            radius: Math.sqrt(state.idps / 10000) * 2,
            fillColor: colorConfig.idp,
            color: colorConfig.white,
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          });
          
          marker.bindTooltip(`${state.name}: ${state.idps.toLocaleString()} IDPs`, {
            permanent: false,
            direction: 'top',
            className: 'state-tooltip'
          });
          
          marker.bindPopup(`
            <div class="state-popup">
              <h3>${state.name}</h3>
              <p><strong>IDPs:</strong> ${state.idps.toLocaleString()}</p>
              <p><strong>Population:</strong> ${state.population.toLocaleString()}</p>
              <p><strong>Displacement %:</strong> ${(state.idps / state.population * 100).toFixed(1)}%</p>
              <button class="popup-button" onclick="loadDistrictData('${state.name}')">View Districts</button>
            </div>
          `);
          
          stateMarkersLayer.addLayer(marker);
        });
        
        // Add state markers layer to map
        stateMarkersLayer.addTo(map3);
      }
    });

    // Back button event listener
    drilldownBackBtn.addEventListener('click', () => {
      // Clear district markers
      districtMarkersLayer.clearLayers();
      
      // Show state markers
      stateMarkersLayer.addTo(map3);
      
      // Update title and hide back button
      document.getElementById('map-title-3').textContent = 'Total Number of IDPs by State';
      drilldownBackBtn.style.display = 'none';
      
      // Reset current state
      currentState = null;
    });

    // Load returnee data for map4
    Papa.parse('./data/returnees_data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const returneeLayer = L.layerGroup();
        
        results.data.forEach(state => {
          const marker = L.circleMarker([state.lat, state.lon], {
            radius: Math.sqrt(state.returnees / 1000) * 2,
            fillColor: colorConfig.returnee,
            color: colorConfig.white,
            weight: 1,
            opacity: 1,
            fillOpacity: 0.8
          });
          
          marker.bindTooltip(`${state.name}: ${state.returnees.toLocaleString()} Returnees`, {
            permanent: false,
            direction: 'top',
            className: 'returnee-tooltip'
          });
          
          marker.bindPopup(`
            <div class="returnee-popup">
              <h3>${state.name}</h3>
              <p><strong>Returnees:</strong> ${state.returnees.toLocaleString()}</p>
              <p><strong>Return %:</strong> ${(state.returnees / state.idps * 100).toFixed(1)}% of IDPs</p>
              <p><strong>IDPs:</strong> ${state.idps.toLocaleString()}</p>
            </div>
          `);
          
          returneeLayer.addLayer(marker);
        });
        
        returneeLayer.addTo(map4);
      }
    });

    // Create heatmap chart
    document.addEventListener('DOMContentLoaded', function() {
      const ctx = document.getElementById('heatmapChart').getContext('2d');
      
      // Sample data for the heatmap chart
      const months = ['Aug-2023', 'Sep-2023', 'Oct-2023', 'Nov-2023', 'Dec-2023', 
                      'Jan-2024', 'Feb-2024', 'Mar-2024', 'Apr-2024', 'May-2024',
                      'Jun-2024', 'Jul-2024', 'Aug-2024', 'Sep-2024', 'Oct-2024',
                      'Nov-2024', 'Dec-2024', 'Jan-2025', 'Feb-2025', 'Mar-2025'];
      
      const idpData = [2500000, 3200000, 4100000, 4800000, 5300000, 
                       5900000, 6400000, 7100000, 7800000, 10200000,
                       10400000, 10600000, 10800000, 11000000, 11200000,
                       11300000, 11300000, 11300000, 11300000, 11301340];
      
      const returneeData = [0, 0, 0, 0, 0, 
                           0, 0, 0, 0, 0,
                           0, 0, 0, 0, 0,
                           0, 120000, 220000, 310000, 396738];
      
      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [
            {
              label: 'IDPs',
              data: idpData,
              borderColor: colorConfig.idp,
              backgroundColor: 'rgba(65, 143, 222, 0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 4,
              pointHoverRadius: 6
            },
            {
              label: 'Returnees',
              data: returneeData,
              borderColor: colorConfig.returnee,
              backgroundColor: 'rgba(255, 103, 31, 0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 4,
              pointHoverRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 20,
                font: {
                  size: 14
                }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  if (context.parsed.y !== null) {
                    label += new Intl.NumberFormat().format(context.parsed.y);
                  }
                  return label;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value / 1000000 + 'M';
                }
              },
              title: {
                display: true,
                text: 'Number of People'
              }
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          }
        }
      });
      
      // Heatmap controls functionality
      const slider = document.getElementById('heatmap-slider');
      const timeDisplay = document.getElementById('heatmap-time-display');
      const playButton = document.getElementById('heatmap-play-button');
      const exportButton = document.getElementById('heatmap-export-button');
      
      let isPlaying = false;
      let animationInterval;
      
      // Update time display based on slider value
      function updateTimeDisplay() {
        const index = parseInt(slider.value);
        timeDisplay.textContent = months[index];
        
        // Update chart to highlight the current point
        chart.data.datasets.forEach((dataset, i) => {
          const newPointStyles = Array(months.length).fill(4);
          newPointStyles[index] = 8;
          
          dataset.pointRadius = newPointStyles;
          dataset.pointBackgroundColor = Array(months.length).fill(i === 0 ? colorConfig.idp : colorConfig.returnee);
          dataset.pointBackgroundColor[index] = '#FFFFFF';
          dataset.pointBorderWidth = Array(months.length).fill(1);
          dataset.pointBorderWidth[index] = 2;
        });
        
        chart.update();
      }
      
      // Initialize time display
      updateTimeDisplay();
      
      // Slider event listener
      slider.addEventListener('input', updateTimeDisplay);
      
      // Play button event listener
      playButton.addEventListener('click', function() {
        if (isPlaying) {
          // Stop animation
          clearInterval(animationInterval);
          playButton.innerHTML = '▶ Play';
          isPlaying = false;
        } else {
          // Start animation
          playButton.innerHTML = '⏸ Pause';
          isPlaying = true;
          
          animationInterval = setInterval(function() {
            let currentValue = parseInt(slider.value);
            currentValue = (currentValue + 1) % months.length;
            slider.value = currentValue;
            updateTimeDisplay();
            
            // Stop at the end
            if (currentValue === months.length - 1) {
              clearInterval(animationInterval);
              playButton.innerHTML = '▶ Play';
              isPlaying = false;
            }
          }, 1000);
        }
      });
      
      // Export button event listener
      exportButton.addEventListener('click', function() {
        // Create a temporary link
        const link = document.createElement('a');
        link.download = 'displacement_trends.png';
        link.href = chart.toBase64Image();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    });

    // Add keyboard navigation support for all interactive elements
    document.addEventListener('DOMContentLoaded', function() {
      const interactiveElements = document.querySelectorAll('a, button, [tabindex]');
      
      interactiveElements.forEach(element => {
        element.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            element.click();
          }
        });
      });
    });
  </script>
</body>
</html>
