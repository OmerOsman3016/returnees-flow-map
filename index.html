<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudan IDP Displacement Dashboard</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        
        .header {
            background-color: #08306B;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header p {
            margin: 5px 0 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .container {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        #map-container {
            flex: 1;
            height: calc(100vh - 60px);
        }
        
        .info-panel {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .info-panel h4 {
            margin: 0 0 5px;
            color: #08306B;
        }
        
        .info-panel b {
            font-weight: 600;
        }
        
        .color-key {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-left: 5px;
            vertical-align: middle;
            border: 1px solid #ddd;
        }
        
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            line-height: 1.5;
        }
        
        .legend h4 {
            margin: 0 0 5px;
            color: #08306B;
        }
        
        .legend i {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            width: 70%;
            max-width: 800px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .state-stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stat-item {
            flex: 1;
            min-width: 120px;
            text-align: center;
            margin: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2171B5;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .state-chart-container {
            margin: 30px 0;
            height: 300px;
        }
        
        .state-details h3 {
            color: #08306B;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .state-details ul {
            padding-left: 20px;
        }
        
        .state-details li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            #map-container {
                order: 2;
                height: 60vh;
            }
            
            .modal-content {
                width: 90%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sudan Internal Displacement Monitoring</h1>
        <p>Visualization of IDP populations by state (2024 data)</p>
    </div>
    
    <div class="container">
        <div id="map-container"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initializeIDPMap();
        });

/**
 * Initialize the main IDP map showing total IDPs by state
 */
function initializeIDPMap() {
  // Create the map instance with improved initial view
  const idpMap = L.map('map-container', {
    center: [15.5, 30.5], // Centered on Sudan
    zoom: 5.5,
    minZoom: 5,
    maxZoom: 10,
    zoomControl: false, // We'll add custom zoom controls
    attributionControl: true
  });

  // Add custom zoom controls in a better position
  L.control.zoom({
    position: 'topright'
  }).addTo(idpMap);

  // Add scale control
  L.control.scale({
    position: 'bottomright',
    imperial: false
  }).addTo(idpMap);

  // Add improved basemap with better contrast for data visualization
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(idpMap);

  // Add a secondary satellite basemap option
  const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
  });

  // Create a layer control for basemap switching
  const baseMaps = {
    "Light": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }),
    "Satellite": satelliteLayer
  };

  // Add the layer control to the map
  L.control.layers(baseMaps, null, {
    position: 'topright',
    collapsed: true
  }).addTo(idpMap);

  // Improved color scale for IDP visualization
  function getColor(d) {
    return d > 1500000 ? '#08306B' :
           d > 1000000 ? '#2171B5' :
           d > 500000  ? '#6BAED6' :
           d > 250000  ? '#BDD7E7' :
                         '#EFF3FF';
  }

  // Improved styling for state boundaries
  function style(feature) {
    const stateName = feature.properties.admin1Name;
    const idpCount = idpData[stateName] || 0;
    
    return {
      weight: 1.5,
      opacity: 1,
      color: '#FFFFFF',
      dashArray: '',
      fillOpacity: 0.7,
      fillColor: getColor(idpCount)
    };
  }

  // Enhanced hover effect
  function highlightFeature(e) {
    const layer = e.target;
    
    layer.setStyle({
      weight: 3,
      color: '#666',
      dashArray: '',
      fillOpacity: 0.9
    });
    
    layer.bringToFront();
    updateInfoPanel(layer.feature.properties);
  }

  // Reset highlight
  function resetHighlight(e) {
    geojsonLayer.resetStyle(e.target);
    infoPanel.update();
  }

  // Click handler for zooming to state
  function zoomToFeature(e) {
    idpMap.fitBounds(e.target.getBounds());
    showStateDetails(e.target.feature.properties);
  }

  // Set interaction listeners
  function onEachFeature(feature, layer) {
    layer.on({
      mouseover: highlightFeature,
      mouseout: resetHighlight,
      click: zoomToFeature
    });
  }

  // Create a custom info panel
  const infoPanel = L.control({position: 'topleft'});

  infoPanel.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'info-panel');
    this.update();
    return this._div;
  };

  infoPanel.update = function(props) {
    const stateName = props ? props.admin1Name : '';
    const idpCount = props ? idpData[stateName] : null;
    
    this._div.innerHTML = '<h4>Sudan IDP Distribution</h4>' +
      (props ?
        `<b>${stateName}</b><br />` +
        (idpCount ? idpCount.toLocaleString() + ' IDPs' : 'Data not available') +
        `<div class="color-key" style="background: ${getColor(idpCount)};"></div>`
        : 'Hover over a state');
  };

  infoPanel.addTo(idpMap);

  // Function to update info panel on hover
  function updateInfoPanel(props) {
    infoPanel.update(props);
  }

  // Function to show detailed state information
  function showStateDetails(props) {
    const stateName = props.admin1Name;
    const idpCount = idpData[stateName] || 0;
    
    // Create or update a modal with detailed information
    let modal = document.getElementById('state-details-modal');
    
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'state-details-modal';
      modal.className = 'modal';
      document.body.appendChild(modal);
      
      // Add close button
      const closeBtn = document.createElement('span');
      closeBtn.className = 'modal-close';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = function() {
        modal.style.display = 'none';
      };
      modal.appendChild(closeBtn);
      
      // Add content container
      const content = document.createElement('div');
      content.className = 'modal-content';
      modal.appendChild(content);
    }
    
    // Get the content container
    const content = modal.querySelector('.modal-content');
    
    // Calculate percentage of total IDPs
    const totalIDPs = Object.values(idpData).reduce((a, b) => a + b, 0);
    const percentage = ((idpCount / totalIDPs) * 100).toFixed(1);
    
    // Create a more detailed visualization of the state data
    content.innerHTML = `
      <h2>${stateName}</h2>
      <div class="state-stats">
        <div class="stat-item">
          <div class="stat-value">${idpCount.toLocaleString()}</div>
          <div class="stat-label">Internally Displaced Persons</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${percentage}%</div>
          <div class="stat-label">Of National Total</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">#${Object.entries(idpData).sort((a, b) => b[1] - a[1]).findIndex(x => x[0] === stateName) + 1}</div>
          <div class="stat-label">National Rank</div>
        </div>
      </div>
      <div class="state-chart-container">
        <canvas id="state-chart"></canvas>
      </div>
      <div class="state-details">
        <h3>Displacement Context</h3>
        <p>${getStateDescription(stateName)}</p>
        <h3>Key Challenges</h3>
        <ul>
          ${getStateChallenges(stateName).map(challenge => `<li>${challenge}</li>`).join('')}
        </ul>
      </div>
    `;
    
    // Show the modal
    modal.style.display = 'block';
    
    // Create a chart for the state data
    const ctx = document.getElementById('state-chart').getContext('2d');
    
    // Generate some random data for demonstration
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const idpDataPoints = generateMonthlyData(idpCount);
    const returneeData = generateReturneeData(idpCount);
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'IDPs',
            data: idpDataPoints,
            borderColor: '#2171B5',
            backgroundColor: 'rgba(33, 113, 181, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          },
          {
            label: 'Returnees',
            data: returneeData,
            borderColor: '#238B45',
            backgroundColor: 'rgba(35, 139, 69, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Monthly Displacement Trends (2024)',
            font: {
              size: 16
            }
          },
          legend: {
            position: 'top'
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ${context.raw.toLocaleString()}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of People'
            },
            ticks: {
              callback: function(value) {
                return value.toLocaleString();
              }
            }
          },
          x: {
            title: {
              display: true,
              text: 'Month'
            }
          }
        }
      }
    });
  }

  // Helper function to generate realistic monthly data
  function generateMonthlyData(baseValue) {
    const variation = baseValue * 0.3; // Allow 30% variation
    return Array.from({length: 12}, (_, i) => {
      // Simulate seasonal patterns - more displacement in certain months
      const seasonFactor = 1 + (0.2 * Math.sin(i * 0.5));
      const randomFactor = 1 + (Math.random() - 0.5) * 0.2;
      return Math.floor(baseValue * seasonFactor * randomFactor);
    });
  }

  // Helper function to generate returnee data
  function generateReturneeData(idpCount) {
    const baseReturns = idpCount * 0.05; // Assume 5% return rate
    return Array.from({length: 12}, (_, i) => {
      // More returns in later months
      const progressFactor = 1 + (i / 12);
      const randomFactor = 0.8 + Math.random() * 0.4;
      return Math.floor(baseReturns * progressFactor * randomFactor);
    });
  }

  // Helper function to get state descriptions
  function getStateDescription(stateName) {
    const descriptions = {
      "North Darfur": "North Darfur has experienced significant displacement due to ongoing conflict and intercommunal violence. The state hosts the largest IDP population in Sudan.",
      "South Darfur": "South Darfur continues to see displacement from both conflict and environmental factors, with many IDPs concentrated around Nyala.",
      "Central Darfur": "Central Darfur's displacement situation is characterized by periodic flare-ups of violence and limited access to humanitarian assistance.",
      // Add descriptions for other states...
      "Khartoum": "Despite being the capital, Khartoum has seen displacement due to urban conflict and economic factors, though numbers are lower than in conflict zones.",
      "White Nile": "White Nile hosts both IDPs and refugees from neighboring countries, with displacement driven by multiple factors."
    };
    
    return descriptions[stateName] || `The displacement situation in ${stateName} has been affected by various factors including conflict, environmental conditions, and economic challenges.`;
  }

  // Helper function to get state-specific challenges
  function getStateChallenges(stateName) {
    const challenges = {
      "North Darfur": [
        "Ongoing conflict and insecurity",
        "Limited humanitarian access",
        "Environmental degradation",
        "Overcrowded camps"
      ],
      "South Darfur": [
        "Protection concerns",
        "Food insecurity",
        "Limited healthcare",
        "Water scarcity"
      ],
      // Add challenges for other states...
      "Khartoum": [
        "Urban displacement challenges",
        "High cost of living",
        "Limited shelter options",
        "Livelihood opportunities"
      ]
    };
    
    return challenges[stateName] || [
      "Access to clean water and sanitation",
      "Food security concerns",
      "Limited healthcare facilities",
      "Protection issues for vulnerable populations"
    ];
  }

  // Load the GeoJSON data and create the map layer
  fetch('./data/Admin1.json')
    .then(response => response.json())
    .then(data => {
      // Create the GeoJSON layer with our styling and interaction
      geojsonLayer = L.geoJson(data, {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(idpMap);

      // Add a legend
      const legend = L.control({position: 'bottomleft'});

      legend.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'info legend');
        const grades = [0, 250000, 500000, 1000000, 1500000];
        const labels = [];
        
        div.innerHTML = '<h4>IDP Count</h4>';
        
        // Loop through our intervals and generate a label with a colored square for each interval
        for (let i = 0; i < grades.length; i++) {
          div.innerHTML +=
            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
            grades[i].toLocaleString() + (grades[i + 1] ? 'â€“' + grades[i + 1].toLocaleString() + '<br>' : '+');
        }
        
        return div;
      };

      legend.addTo(idpMap);
    })
    .catch(error => {
      console.error('Error loading GeoJSON data:', error);
    });
}
    </script>
</body>
</html>
