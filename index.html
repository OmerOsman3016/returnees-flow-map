<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudan IDP and Returnee Flow Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <style>
        /* Your existing CSS styles here */
        /* ... */
    </style>
</head>
<body>
    <div class="header">
        <h1>Sudan IDP and Returnee Flow Map</h1>
        <p>Visualization of displacement patterns and return movements</p>
    </div>
    
    <div id="loading" class="loading">Loading data...</div>
    <div id="map-container" class="map-container"></div>
    
    <div class="footer">
        Data for demonstration purposes only | Â© 2024 Humanitarian Mapping Initiative
    </div>
    
    <script>
        // Global variables to store our data
        let sudanAdmin1Data = null;
        let idpData = null;
        let idpMap = null;
        let geojsonLayer = null;
        let infoPanel = null;

        // Initialize maps when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading indicator
            document.getElementById('loading').style.display = 'block';
            
            // Load data files in parallel
            Promise.all([
                loadGeoJSONData(),
                loadCSVData()
            ]).then(() => {
                // Initialize the map after data is loaded
                initializeIDPMap();
                document.getElementById('loading').style.display = 'none';
            }).catch(error => {
                console.error('Error loading data:', error);
                const loadingDiv = document.getElementById('loading');
                loadingDiv.textContent = 'Error loading data. Please check:';
                
                // Create a more detailed error message
                const errorDetails = document.createElement('div');
                errorDetails.style.marginTop = '10px';
                errorDetails.style.textAlign = 'left';
                errorDetails.style.fontSize = '0.8em';
                errorDetails.innerHTML = `
                    <p>1. Ensure you have both data files in the correct location:</p>
                    <ul>
                        <li><code>./data/Admin1.json</code> (Sudan administrative boundaries)</li>
                        <li><code>./data/total_idps.csv</code> (IDP data with columns: state, total_idps, lat, lon)</li>
                    </ul>
                    <p>2. Check your browser's developer console (F12) for specific errors</p>
                    <p>3. If running locally, you may need to use a local web server due to CORS restrictions</p>
                `;
                loadingDiv.appendChild(errorDetails);
            });
        });

        /**
         * Load GeoJSON data for Sudan admin1 boundaries
         */
        function loadGeoJSONData() {
            return fetch('./data/Admin1.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to load Admin1.json: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data || !data.features || data.features.length === 0) {
                        throw new Error('Admin1.json is empty or invalid GeoJSON');
                    }
                    sudanAdmin1Data = data;
                    console.log('Loaded Admin1 GeoJSON data with', data.features.length, 'features');
                });
        }

        /**
         * Load CSV data for IDP statistics
         */
        function loadCSVData() {
            return new Promise((resolve, reject) => {
                Papa.parse('./data/total_idps.csv', {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors && results.errors.length > 0) {
                            console.warn('CSV parsing warnings:', results.errors);
                        }
                        
                        if (!results.data || results.data.length === 0) {
                            reject(new Error('CSV file is empty or could not be parsed'));
                            return;
                        }
                        
                        // Process the CSV data
                        idpData = results.data.map((row, index) => {
                            // Validate required fields
                            if (!row.state) {
                                console.warn(`Row ${index + 1} is missing state name`);
                            }
                            
                            return {
                                state: row.state || `Unknown State ${index + 1}`,
                                total_idps: parseInt(row.total_idps) || 0,
                                lat: parseFloat(row.lat) || null,
                                lon: parseFloat(row.lon) || null
                            };
                        });
                        
                        console.log('Loaded', idpData.length, 'IDP records from CSV');
                        resolve();
                    },
                    error: function(error) {
                        reject(new Error(`Failed to load total_idps.csv: ${error.message}`));
                    }
                });
            });
        }

        /**
         * Get IDP data for a specific state
         */
        function getIdpDataForState(stateName) {
            if (!idpData || !stateName) return null;
            
            // Clean the state name for comparison
            const cleanName = stateName.toString().toLowerCase().trim();
            
            // Find matching state (case insensitive, partial match)
            return idpData.find(row => {
                if (!row.state) return false;
                return row.state.toLowerCase().includes(cleanName);
            }) || null;
        }

        /**
         * Initialize the main IDP map showing total IDPs by state
         */
        function initializeIDPMap() {
            // Create the map instance
            idpMap = L.map('map-container', {
                center: [15.5, 30.5], // Centered on Sudan
                zoom: 5.5,
                minZoom: 5,
                maxZoom: 10,
                zoomControl: false,
                attributionControl: true
            });

            // Add controls
            L.control.zoom({ position: 'topright' }).addTo(idpMap);
            L.control.scale({ position: 'bottomright', imperial: false }).addTo(idpMap);

            // Add base layers
            const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(idpMap);

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });

            L.control.layers({
                "Light": lightLayer,
                "Satellite": satelliteLayer
            }, null, { position: 'topright', collapsed: true }).addTo(idpMap);

            // Color scale for IDP visualization
            function getColor(d) {
                return d > 1000000 ? '#2A81CB' :
                       d > 500000  ? '#73B9ED' :
                                     '#BFE1F6';
            }

            // Style function for GeoJSON features
            function style(feature) {
                const stateName = feature.properties.admin1Name || feature.properties.ADM1_EN || feature.properties.name;
                const stateData = getIdpDataForState(stateName);
                const idpCount = stateData ? stateData.total_idps : 0;
                
                feature.properties.idp_count = idpCount;
                feature.properties.stateData = stateData;
                
                return {
                    weight: 1.5,
                    opacity: 1,
                    color: '#FFFFFF',
                    dashArray: '',
                    fillOpacity: 0.7,
                    fillColor: getColor(idpCount)
                };
            }

            // Feature interaction functions
            function highlightFeature(e) {
                const layer = e.target;
                layer.setStyle({
                    weight: 3,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.8
                }).bringToFront();
                updateInfoPanel(layer.feature.properties);
            }

            function resetHighlight(e) {
                geojsonLayer.resetStyle(e.target);
                infoPanel.update();
            }

            function zoomToFeature(e) {
                idpMap.fitBounds(e.target.getBounds());
                showStateDetails(e.target.feature.properties);
            }

            function onEachFeature(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
            }

            // Create info panel
            infoPanel = L.control({position: 'topleft'});
            infoPanel.onAdd = function(map) {
                this._div = L.DomUtil.create('div', 'info-panel');
                this.update();
                return this._div;
            };
            infoPanel.update = function(props) {
                this._div.innerHTML = '<h4>Sudan IDP Distribution</h4>' +
                    (props ?
                        '<b>' + (props.admin1Name || props.ADM1_EN || props.name) + '</b><br />' +
                        (props.idp_count ? props.idp_count.toLocaleString() : 'No data') + ' IDPs'
                        : 'Hover over a state');
            };
            infoPanel.addTo(idpMap);

            function updateInfoPanel(props) {
                infoPanel.update(props);
            }

            // Add GeoJSON layer if data is available
            if (sudanAdmin1Data) {
                geojsonLayer = L.geoJSON(sudanAdmin1Data, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(idpMap);
                idpMap.fitBounds(geojsonLayer.getBounds());
            }

            // Add markers if CSV data is available
            if (idpData) {
                idpData.forEach(state => {
                    if (state.lat && state.lon) {
                        L.circleMarker([state.lat, state.lon], {
                            radius: Math.min(15, Math.max(5, Math.log(state.total_idps + 1) * 2)),
                            fillColor: getColor(state.total_idps),
                            color: '#fff',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        })
                        .bindTooltip(`${state.state}: ${state.total_idps.toLocaleString()} IDPs`)
                        .addTo(idpMap);
                    }
                });
            }
        }

        // Function to show detailed state information
        function showStateDetails(props) {
            // Create or update modal
            let modal = document.getElementById('state-details-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'state-details-modal';
                modal.className = 'modal';
                document.body.appendChild(modal);
                
                const closeBtn = document.createElement('span');
                closeBtn.className = 'modal-close';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = () => modal.style.display = 'none';
                modal.appendChild(closeBtn);
                
                const content = document.createElement('div');
                content.className = 'modal-content';
                modal.appendChild(content);
            }
            
            const content = modal.querySelector('.modal-content');
            const stateName = props.admin1Name || props.ADM1_EN || props.name || 'Unknown State';
            const stateData = props.stateData || {};
            const idpCount = props.idp_count ? props.idp_count.toLocaleString() : 'No data';
            
            content.innerHTML = `
                <h2>${stateName}</h2>
                <div class="state-stats">
                    <div class="stat-item">
                        <div class="stat-value">${idpCount}</div>
                        <div class="stat-label">IDPs</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stateData.lat ? stateData.lat.toFixed(4) : 'N/A'}</div>
                        <div class="stat-label">Latitude</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stateData.lon ? stateData.lon.toFixed(4) : 'N/A'}</div>
                        <div class="stat-label">Longitude</div>
                    </div>
                </div>
                <div class="state-details">
                    <h3>Displacement Overview</h3>
                    <p>${stateName} has ${idpCount} reported internally displaced persons.</p>
                    <h3>Key Challenges</h3>
                    <ul>
                        <li>Access to basic services</li>
                        <li>Food insecurity</li>
                        <li>Healthcare access</li>
                        <li>Protection concerns</li>
                    </ul>
                </div>
            `;
            
            modal.style.display = 'block';
        }
    </script>
</body>
</html>
