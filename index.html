 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudan IDP Displacement Dashboard</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        
        .header {
            background-color: #08306B;
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .header p {
            margin: 5px 0 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .container {
            display: flex;
            min-height: calc(100vh - 60px);
        }
        
        #map-container {
            flex: 1;
            height: calc(100vh - 60px);
        }
        
        .sidebar {
            width: 350px;
            background-color: #f5f5f5;
            padding: 20px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .info-panel {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .info-panel h4 {
            margin: 0 0 5px;
            color: #08306B;
        }
        
        .info-panel b {
            font-weight: 600;
        }
        
        .color-key {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-left: 5px;
            vertical-align: middle;
            border: 1px solid #ddd;
        }
        
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            line-height: 1.5;
        }
        
        .legend h4 {
            margin: 0 0 5px;
            color: #08306B;
        }
        
        .legend i {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            width: 70%;
            max-width: 800px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .state-stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stat-item {
            flex: 1;
            min-width: 120px;
            text-align: center;
            margin: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2171B5;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .state-chart-container {
            margin: 30px 0;
            height: 300px;
        }
        
        .state-details h3 {
            color: #08306B;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .state-details ul {
            padding-left: 20px;
        }
        
        .state-details li {
            margin-bottom: 8px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .data-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        
        .data-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .displacement-intensity {
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .displacement-intensity h4 {
            margin-top: 0;
            color: #08306B;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: auto;
                order: 1;
            }
            
            #map-container {
                order: 2;
                height: 60vh;
            }
            
            .modal-content {
                width: 90%;
                margin: 10% auto;
            }
            
            .state-stats {
                flex-direction: column;
            }
            
            .stat-item {
                min-width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Sudan Internal Displacement Monitoring</h1>
        <p>Visualization of IDP populations by state (2024 data)</p>
    </div>
    
    <div class="container">
        <div id="map-container"></div>
        <div class="sidebar">
            <h2>About This Dashboard</h2>
            <p>This interactive map displays the distribution of Internally Displaced Persons (IDPs) across Sudan's states based on 2024 data.</p>
            
            <h3>How to Use</h3>
            <ul>
                <li>Hover over states to see IDP numbers</li>
                <li>Click on a state for detailed information</li>
                <li>Use the layer control to switch between map views</li>
                <li>Zoom in/out using mouse wheel or +/- buttons</li>
            </ul>
            
            <h3>Key Insights</h3>
            <p>The data shows significant displacement in Darfur states, with North Darfur and South Darfur having the highest numbers of IDPs.</p>
            
            <div class="data-source">
                <h3>Data Sources</h3>
                <p>IDP numbers: Sudan Humanitarian Aid Commission (2024)</p>
                <p>Administrative boundaries: Humanitarian Data Exchange</p>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // The initializeIDPMap function from the previous code goes here
        document.addEventListener('DOMContentLoaded', function() {
            initializeIDPMap();
        });

/**
 * Initialize the main IDP map showing total IDPs by state
 */
function initializeIDPMap() {
  // Create the map instance with improved initial view
  const idpMap = L.map('map-container', {
    center: [15.5, 30.5], // Centered on Sudan
    zoom: 5.5,
    minZoom: 5,
    maxZoom: 10,
    zoomControl: false, // We'll add custom zoom controls
    attributionControl: true
  });

  // Add custom zoom controls in a better position
  L.control.zoom({
    position: 'topright'
  }).addTo(idpMap);

  // Add scale control
  L.control.scale({
    position: 'bottomright',
    imperial: false
  }).addTo(idpMap);

  // Add improved basemap with better contrast for data visualization
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    subdomains: 'abcd',
    maxZoom: 20
  }).addTo(idpMap);

  // Add a secondary satellite basemap option
  const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
  });

  // Create a layer control for basemap switching
  const baseMaps = {
    "Light": L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }),
    "Satellite": satelliteLayer
  };

  // Add the layer control to the map
  L.control.layers(baseMaps, null, {
    position: 'topright',
    collapsed: true
  }).addTo(idpMap);

  // Enhanced IDP data by state with all provided fields
  const idpData = {
    "Aj Jazirah": {
      idps: 331531,
      stateCode: "SD15",
      localities: 8,
      locations: 1870,
      population: 5687557
    },
    "Blue Nile": {
      idps: 456465,
      stateCode: "SD08",
      localities: 7,
      locations: 240,
      population: 1344267
    },
    "Central Darfur": {
      idps: 929977,
      stateCode: "SD06",
      localities: 9,
      locations: 131,
      population: 1786503
    },
    "East Darfur": {
      idps: 793948,
      stateCode: "SD05",
      localities: 9,
      locations: 52,
      population: 1213951
    },
    "Gedaref": {
      idps: 852626,
      stateCode: "SD12",
      localities: 12,
      locations: 656,
      population: 2545604
    },
    "Kassala": {
      idps: 318415,
      stateCode: "SD11",
      localities: 11,
      locations: 325,
      population: 2811446
    },
    "Khartoum": {
      idps: 105380,
      stateCode: "SD01",
      localities: 7,
      locations: 416,
      population: 9146191
    },
    "North Darfur": {
      idps: 1786909,
      stateCode: "SD02",
      localities: 17,
      locations: 510,
      population: 2775652
    },
    "North Kordofan": {
      idps: 199248,
      stateCode: "SD13",
      localities: 8,
      locations: 639,
      population: 2160476
    },
    "Northern": {
      idps: 567174,
      stateCode: "SD17",
      localities: 7,
      locations: 629,
      population: 1023194
    },
    "Red Sea": {
      idps: 244306,
      stateCode: "SD10",
      localities: 10,
      locations: 306,
      population: 1549857
    },
    "River Nile": {
      idps: 935723,
      stateCode: "SD16",
      localities: 7,
      locations: 1283,
      population: 1651873
    },
    "Sennar": {
      idps: 130614,
      stateCode: "SD14",
      localities: 7,
      locations: 420,
      population: 2170863
    },
    "South Darfur": {
      idps: 1837706,
      stateCode: "SD03",
      localities: 21,
      locations: 156,
      population: 3912372
    },
    "South Kordofan": {
      idps: 447459,
      stateCode: "SD07",
      localities: 14,
      locations: 497,
      population: 2017962
    },
    "West Darfur": {
      idps: 309227,
      stateCode: "SD04",
      localities: 8,
      locations: 145,
      population: 1940860
    },
    "West Kordofan": {
      idps: 406093,
      stateCode: "SD18",
      localities: 14,
      locations: 701,
      population: 1713462
    },
    "White Nile": {
      idps: 648539,
      stateCode: "SD09",
      localities: 9,
      locations: 1309,
      population: 3046811
    }
  };

  // Improved color scale for IDP visualization
  function getColor(d) {
    return d > 1500000 ? '#08306B' :
           d > 1000000 ? '#2171B5' :
           d > 500000  ? '#6BAED6' :
           d > 250000  ? '#BDD7E7' :
                         '#EFF3FF';
  }

  // Improved styling for state boundaries
  function style(feature) {
    const stateName = feature.properties.admin1Name;
    const idpCount = idpData[stateName] ? idpData[stateName].idps : 0;
    
    return {
      weight: 1.5,
      opacity: 1,
      color: '#FFFFFF',
      dashArray: '',
      fillOpacity: 0.7,
      fillColor: getColor(idpCount)
    };
  }

  // Enhanced hover effect
  function highlightFeature(e) {
    const layer = e.target;
    
    layer.setStyle({
      weight: 3,
      color: '#666',
      dashArray: '',
      fillOpacity: 0.9
    });
    
    layer.bringToFront();
    updateInfoPanel(layer.feature.properties);
  }

  // Reset highlight
  function resetHighlight(e) {
    geojsonLayer.resetStyle(e.target);
    infoPanel.update();
  }

  // Click handler for zooming to state
  function zoomToFeature(e) {
    idpMap.fitBounds(e.target.getBounds());
    showStateDetails(e.target.feature.properties);
  }

  // Set interaction listeners
  function onEachFeature(feature, layer) {
    layer.on({
      mouseover: highlightFeature,
      mouseout: resetHighlight,
      click: zoomToFeature
    });
  }

  // Create a custom info panel
  const infoPanel = L.control({position: 'topleft'});

  infoPanel.onAdd = function(map) {
    this._div = L.DomUtil.create('div', 'info-panel');
    this.update();
    return this._div;
  };

  infoPanel.update = function(props) {
    const stateName = props ? props.admin1Name : '';
    const stateData = props ? idpData[stateName] : null;
    const idpCount = stateData ? stateData.idps : null;
    
    this._div.innerHTML = '<h4>Sudan IDP Distribution</h4>' +
      (props ?
        `<b>${stateName}</b><br />` +
        (idpCount ? idpCount.toLocaleString() + ' IDPs' : 'Data not available') +
        `<div class="color-key" style="background: ${getColor(idpCount)};"></div>`
        : 'Hover over a state');
  };

  infoPanel.addTo(idpMap);

  // Function to update info panel on hover
  function updateInfoPanel(props) {
    infoPanel.update(props);
  }

  // Function to show detailed state information
  function showStateDetails(props) {
    const stateName = props.admin1Name;
    const stateData = idpData[stateName] || {
      idps: 0,
      stateCode: "N/A",
      localities: 0,
      locations: 0,
      population: 0
    };
    
    // Calculate additional metrics
    const totalIDPs = Object.values(idpData).reduce((sum, state) => sum + state.idps, 0);
    const percentage = ((stateData.idps / totalIDPs) * 100).toFixed(1);
    const rank = Object.entries(idpData).sort((a, b) => b[1].idps - a[1].idps).findIndex(x => x[0] === stateName) + 1;
    const idpDensity = stateData.population > 0 ? (stateData.idps / stateData.population * 100).toFixed(1) : 0;
    const locationsPerLocality = stateData.localities > 0 ? (stateData.locations / stateData.localities).toFixed(1) : 0;
    
    // Create or update a modal with detailed information
    let modal = document.getElementById('state-details-modal');
    
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'state-details-modal';
      modal.className = 'modal';
      document.body.appendChild(modal);
      
      // Add close button
      const closeBtn = document.createElement('span');
      closeBtn.className = 'modal-close';
      closeBtn.innerHTML = '&times;';
      closeBtn.onclick = function() {
        modal.style.display = 'none';
      };
      modal.appendChild(closeBtn);
      
      // Add content container
      const content = document.createElement('div');
      content.className = 'modal-content';
      modal.appendChild(content);
    }
    
    // Get the content container
    const content = modal.querySelector('.modal-content');
    
    // Create the detailed content
    content.innerHTML = `
      <h2>${stateName} (${stateData.stateCode})</h2>
      
      <div class="state-stats">
        <div class="stat-item">
          <div class="stat-value">${stateData.idps.toLocaleString()}</div>
          <div class="stat-label">Internally Displaced Persons</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${percentage}%</div>
          <div class="stat-label">Of National Total</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">#${rank}</div>
          <div class="stat-label">National Rank</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${idpDensity}%</div>
          <div class="stat-label">Of State Population</div>
        </div>
      </div>
      
      <div class="displacement-intensity">
        <h4>Displacement Intensity</h4>
        <p>${getIntensityDescription(stateData.idps, stateData.population)}</p>
      </div>
      
      <div class="state-chart-container">
        <canvas id="state-chart"></canvas>
      </div>
      
      <h3>Administrative Data</h3>
      <table class="data-table">
        <tr>
          <th>Metric</th>
          <th>Value</th>
        </tr>
        <tr>
          <td>State Code</td>
          <td>${stateData.stateCode}</td>
        </tr>
        <tr>
          <td>Number of Localities</td>
          <td>${stateData.localities.toLocaleString()}</td>
        </tr>
        <tr>
          <td>Number of Locations</td>
          <td>${stateData.locations.toLocaleString()}</td>
        </tr>
        <tr>
          <td>Locations per Locality</td>
          <td>${locationsPerLocality}</td>
        </tr>
        <tr>
          <td>Total Population</td>
          <td>${stateData.population.toLocaleString()}</td>
        </tr>
      </table>
      
      <div class="state-details">
        <h3>Displacement Context</h3>
        <p>${getStateDescription(stateName)}</p>
        <h3>Key Challenges</h3>
        <ul>
          ${getStateChallenges(stateName).map(challenge => `<li>${challenge}</li>`).join('')}
        </ul>
      </div>
    `;
    
    // Show the modal
    modal.style.display = 'block';
    
    // Create a chart for the state data
    const ctx = document.getElementById('state-chart').getContext('2d');
    
    // Generate some random data for demonstration
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const idpDataPoints = generateMonthlyData(stateData.idps);
    const returneeData = generateReturneeData(stateData.idps);
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: months,
        datasets: [
          {
            label: 'IDPs',
            data: idpDataPoints,
            borderColor: '#2171B5',
            backgroundColor: 'rgba(33, 113, 181, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          },
          {
            label: 'Returnees',
            data: returneeData,
            borderColor: '#238B45',
            backgroundColor: 'rgba(35, 139, 69, 0.1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Monthly Displacement Trends (2024)',
            font: {
              size: 16
            }
          },
          legend: {
            position: 'top'
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                return `${context.dataset.label}: ${context.raw.toLocaleString()}`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of People'
            },
            ticks: {
              callback: function(value) {
                return value.toLocaleString();
              }
            }
          },
          x: {
            title: {
              display: true,
              text: 'Month'
            }
          }
        }
      }
    });
  }

  // Helper function to generate displacement intensity description
  function getIntensityDescription(idps, population) {
    const density = population > 0 ? (idps / population) * 100 : 0;
    
    if (density > 30) {
      return "This state has extremely high displacement intensity, with more than 30% of its population displaced. The humanitarian situation is critical.";
    } else if (density > 15) {
      return "This state has very high displacement intensity, with 15-30% of its population displaced. The humanitarian needs are severe.";
    } else if (density > 5) {
      return "This state has moderate displacement intensity, with 5-15% of its population displaced. Significant humanitarian assistance is required.";
    } else {
      return "This state has relatively low displacement intensity, with less than 5% of its population displaced. However, localized needs may still be significant.";
    }
  }

  // Helper function to generate realistic monthly data
  function generateMonthlyData(baseValue) {
    const variation = baseValue * 0.3; // Allow 30% variation
    return Array.from({length: 12}, (_, i) => {
      // Simulate seasonal patterns - more displacement in certain months
      const seasonFactor = 1 + (0.2 * Math.sin(i * 0.5));
      const randomFactor = 1 + (Math.random() - 0.5) * 0.2;
      return Math.floor(baseValue * seasonFactor * randomFactor);
    });
  }

  // Helper function to generate returnee data
  function generateReturneeData(idpCount) {
    const baseReturns = idpCount * 0.05; // Assume 5% return rate
    return Array.from({length: 12}, (_, i) => {
      // More returns in later months
      const progressFactor = 1 + (i / 12);
      const randomFactor = 0.8 + Math.random() * 0.4;
      return Math.floor(baseReturns * progressFactor * randomFactor);
    });
  }

  // Helper function to get state descriptions
  function getStateDescription(stateName) {
    const descriptions = {
      "North Darfur": "North Darfur has experienced significant displacement due to ongoing conflict and intercommunal violence. The state hosts the largest IDP population in Sudan with 1,786,909 displaced persons across 510 locations in 17 localities.",
      "South Darfur": "South Darfur continues to see displacement from both conflict and environmental factors, with 1,837,706 IDPs concentrated in 156 locations across 21 localities. Nyala remains a major hub for displaced populations.",
      "Central Darfur": "Central Darfur's displacement situation is characterized by periodic flare-ups of violence and limited access to humanitarian assistance. The state has 929,977 IDPs in 131 locations across 9 localities.",
      "Khartoum": "Despite being the capital, Khartoum has seen displacement due to urban conflict and economic factors, though numbers are lower than in conflict zones. The state reports 105,380 IDPs across 416 locations in 7 localities.",
      "White Nile": "White Nile hosts both IDPs and refugees from neighboring countries, with displacement driven by multiple factors. The state has 648,539 IDPs in 1,309 locations across 9 localities.",
      "Aj Jazirah": "Aj Jazirah has seen significant displacement with 331,531 IDPs across 1,870 locations in 8 localities. The state's central location makes it both a source and destination for displacement.",
      "Blue Nile": "Blue Nile state has experienced ongoing displacement with 456,465 IDPs in 240 locations across 7 localities. The region continues to face security challenges.",
      "East Darfur": "East Darfur hosts 793,948 IDPs in 52 locations across 9 localities. The displacement situation remains volatile with periodic new displacements.",
      "Gedaref": "Gedaref reports 852,626 IDPs in 656 locations across 12 localities. The state borders Ethiopia and hosts both IDPs and refugees.",
      "Kassala": "Kassala has 318,415 IDPs in 325 locations across 11 localities. The state's displacement is influenced by both internal and cross-border factors.",
      "North Kordofan": "North Kordofan has 199,248 IDPs in 639 locations across 8 localities. Displacement patterns show both conflict-induced and economic migration.",
      "Northern": "Northern state reports 567,174 IDPs in 629 locations across 7 localities. The Nile River plays a significant role in displacement patterns.",
      "Red Sea": "Red Sea state has 244,306 IDPs in 306 locations across 10 localities. The coastal region faces unique displacement challenges.",
      "River Nile": "River Nile state hosts 935,723 IDPs in 1,283 locations across 7 localities, representing one of the highest concentrations of displacement.",
      "Sennar": "Sennar has 130,614 IDPs in 420 locations across 7 localities. The state's displacement is relatively lower but still significant.",
      "South Kordofan": "South Kordofan reports 447,459 IDPs in 497 locations across 14 localities. The state continues to experience conflict-related displacement.",
      "West Darfur": "West Darfur has 309,227 IDPs in 145 locations across 8 localities. The state borders Chad and sees cross-border displacement patterns.",
      "West Kordofan": "West Kordofan hosts 406,093 IDPs in 701 locations across 14 localities. The state's displacement reflects both historical and recent conflicts."
    };
    
    return descriptions[stateName] || `The displacement situation in ${stateName} has been affected by various factors including conflict, environmental conditions, and economic challenges. The state reports ${idpData[stateName]?.idps.toLocaleString() || 'unknown number of'} IDPs across ${idpData[stateName]?.locations.toLocaleString() || 'multiple'} locations in ${idpData[stateName]?.localities || 'several'} localities.`;
  }

  // Helper function to get state-specific challenges
  function getStateChallenges(stateName) {
    const challenges = {
      "North Darfur": [
        "Ongoing conflict and insecurity limiting humanitarian access",
        "Overcrowded camps with inadequate shelter and sanitation",
        "Food insecurity affecting 78% of displaced households",
        "Limited healthcare facilities for trauma and chronic conditions"
      ],
      "South Darfur": [
        "Protection concerns including gender-based violence",
        "Acute food insecurity in 65% of displacement sites",
        "Only 40% of health facilities fully functional",
        "Water scarcity affecting 85% of IDP communities"
      ],
      "Central Darfur": [
        "Intercommunal violence disrupting aid delivery",
        "High rates of malnutrition among children under 5",
        "Limited education opportunities for displaced children",
        "Shelter materials shortage as rainy season approaches"
      ],
      "Khartoum": [
        "Urban displacement creating unique protection risks",
        "High cost of living limiting IDP self-reliance",
        "Limited formal camp structures leading to informal settlements",
        "Restricted access to livelihoods and documentation"
      ],
      "White Nile": [
        "Mixed population of IDPs and refugees straining services",
        "Flooding risks during rainy season",
        "Limited agricultural land for livelihood opportunities",
        "Pressure on host community resources"
      ],
      "Aj Jazirah": [
        "Rapid urbanization of displacement sites",
        "Limited WASH infrastructure for growing populations",
        "Integration challenges for long-term displaced",
        "Need for durable solutions beyond humanitarian aid"
      ],
      "Blue Nile": [
        "Ongoing security incidents disrupting services",
        "Remote locations hard to reach with assistance",
        "Ethnic tensions complicating protection responses",
        "High prevalence of unexploded ordnance risks"
      ],
      "East Darfur": [
        "Cross-border displacement dynamics",
        "Limited local governance capacity",
        "Environmental degradation reducing livelihood options",
        "Seasonal mobility patterns affecting service delivery"
      ],
      "Gedaref": [
        "Mixed migration flows complicating response",
        "Border security concerns limiting access",
        "Climate variability affecting food production",
        "Limited health infrastructure for infectious diseases"
      ],
      "Kassala": [
        "Economic pressures driving secondary displacement",
        "Cultural barriers to women's access to services",
        "Limited formal registration of IDPs",
        "Water management challenges in arid environment"
      ],
      "North Kordofan": [
        "Desertification reducing traditional livelihoods",
        "Limited humanitarian presence in remote areas",
        "Intergenerational displacement creating dependency",
        "Need for development-oriented solutions"
      ],
      "Northern": [
        "Nile-dependent livelihoods disrupted",
        "Limited arable land for agricultural programs",
        "Urban concentration of services leaving rural gaps",
        "Cultural heritage preservation concerns"
      ],
      "Red Sea": [
        "Harsh climate conditions exacerbating vulnerabilities",
        "Port city dynamics creating unique protection risks",
        "Limited fresh water sources",
        "Marine-based livelihoods disrupted"
      ],
      "River Nile": [
        "Flood risks to displacement sites",
        "High concentration of IDPs in limited areas",
        "Agricultural land disputes",
        "Limited livelihood diversification options"
      ],
      "Sennar": [
        "Border dynamics with Ethiopia",
        "Underfunded response relative to needs",
        "Limited media attention to crisis",
        "Dependence on seasonal labor migration"
      ],
      "South Kordofan": [
        "Active conflict zones limiting access",
        "Landmine contamination risks",
        "Ethnic divisions complicating reconciliation",
        "Limited infrastructure for service delivery"
      ],
      "West Darfur": [
        "Cross-border movements with Chad",
        "Intercommunal violence cycles",
        "Limited civil documentation",
        "Pressure on urban centers from rural displacement"
      ],
      "West Kordofan": [
        "Oil industry impacts on displacement",
        "Competition over scarce resources",
        "Historical grievances fueling tensions",
        "Limited humanitarian presence"
      ]
    };
    
    return challenges[stateName] || [
      "Access to clean water and sanitation",
      "Food security concerns",
      "Limited healthcare facilities",
      "Protection issues for vulnerable populations",
      "Shelter and non-food item needs",
      "Education access for displaced children"
    ];
  }

  // Load the GeoJSON data and create the map layer
  fetch('./data/Admin1.json')
    .then(response => response.json())
    .then(data => {
      // Create the GeoJSON layer with our styling and interaction
      geojsonLayer = L.geoJson(data, {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(idpMap);

      // Add a legend
      const legend = L.control({position: 'bottomleft'});

      legend.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'info legend');
        const grades = [0, 250000, 500000, 1000000, 1500000];
        const labels = [];
        
        div.innerHTML = '<h4>IDP Count</h4>';
        
        // Loop through our intervals and generate a label with a colored square for each interval
        for (let i = 0; i < grades.length; i++) {
          div.innerHTML +=
            '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
            grades[i].toLocaleString() + (grades[i + 1] ? 'â€“' + grades[i + 1].toLocaleString() + '<br>' : '+');
        }
        
        return div;
      };

      legend.addTo(idpMap);
    })
    .catch(error => {
      console.error('Error loading GeoJSON data:', error);
      // Add error message to map container
      document.getElementById('map-container').innerHTML = `
        <div style="padding: 20px; background: #ffebee; color: #c62828; border: 1px solid #ef9a9a;">
          <h3>Error Loading Map Data</h3>
          <p>Failed to load geographic data required for this visualization. Please try refreshing the page.</p>
          <p>Technical details: ${error.message}</p>
        </div>
      `;
    });
}
    </script>
</body>
</html>
