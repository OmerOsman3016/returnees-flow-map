<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  <title>Sudan | Displacement Tracking Matrix - Returnees Flow</title>

  <!-- External CSS libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    /* Loading spinner styles */
    #loading-spinner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
    }
    
    .spinner {
      width: 80px;
      height: 80px;
      position: relative;
      margin-bottom: 20px;
    }
    
    .spinner-dot {
      position: absolute;
      width: 16px;
      height: 16px;
      background: #418FDE;
      border-radius: 50%;
      animation: spinner-animation 2s infinite ease-in-out;
    }
    
    .spinner-dot:nth-child(1) {
      top: 0;
      left: 32px;
      animation-delay: 0s;
    }
    
    .spinner-dot:nth-child(2) {
      top: 8px;
      left: 8px;
      animation-delay: -0.4s;
    }
    
    .spinner-dot:nth-child(3) {
      top: 32px;
      left: 0;
      animation-delay: -0.8s;
    }
    
    .spinner-dot:nth-child(4) {
      top: 56px;
      left: 8px;
      animation-delay: -1.2s;
    }
    
    .spinner-dot:nth-child(5) {
      top: 64px;
      left: 32px;
      animation-delay: -1.6s;
    }
    
    .spinner-dot:nth-child(6) {
      top: 56px;
      left: 56px;
      animation-delay: -2s;
    }
    
    .spinner-dot:nth-child(7) {
      top: 32px;
      left: 64px;
      animation-delay: -2.4s;
    }
    
    .spinner-dot:nth-child(8) {
      top: 8px;
      left: 56px;
      animation-delay: -2.8s;
    }
    
    @keyframes spinner-animation {
      0%, 100% {
        transform: scale(0.1);
        opacity: 0.5;
      }
      50% {
        transform: scale(1);
        opacity: 1;
      }
    }
    
    .loading-text {
      font-size: 18px;
      color: #418FDE;
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 0.6;
      }
      50% {
        opacity: 1;
      }
    }
    
    .loading-progress {
      width: 200px;
      height: 4px;
      background: #e0e0e0;
      border-radius: 2px;
      margin-top: 15px;
      overflow: hidden;
    }
    
    .loading-progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #418FDE, #82C4FF);
      transition: width 0.3s ease;
      border-radius: 2px;
    }

    /* General body styling */
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.6;
      letter-spacing: 0.5px;
      font-size: 16px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      opacity: 0;
      animation: fadeIn 1.5s ease-in-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    *, *::before, *::after { box-sizing: inherit; }

    a {
      color: #0033A0;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    a:hover { color: #0056b3; }

    /* Custom scrollbar */
    body::-webkit-scrollbar { width: 10px; }
    body::-webkit-scrollbar-track { background: #f1f1f1; }
    body::-webkit-scrollbar-thumb { background: #888; border-radius: 5px; }
    body::-webkit-scrollbar-thumb:hover { background: #555; }
  
    /* Main container */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 30px; /* Standardized gap between sections */
    }
  
    /* Slideshow container */
    .slideshow-container {
      max-width: 100%;
      position: relative;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    /* Slides */
    .slide {
      display: none;
      width: 100%;
      text-align: center;
    }

    .slide img {
      width: 100%;
      max-height: 500px;
      object-fit: cover;
      border-radius: 8px;
    }

    /* Next & previous buttons */
    .prev, .next {
      cursor: pointer;
      position: absolute;
      top: 50%;
      width: auto;
      padding: 20px;
      margin-top: -22px;
      color: white;
      font-weight: bold;
      font-size: 24px;
      transition: 0.6s ease;
      background-color: rgba(0,0,0,0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Position the "next button" to the right */
    .next {
      right: 20px;
    }

    .prev {
      left: 20px;
    }

    /* On hover, add a black background color with a little bit see-through */
    .prev:hover, .next:hover {
      background-color: rgba(0,0,0,0.8);
    }

    /* The dots/bullets/indicators */
    .dots {
      text-align: center;
      margin: 15px 0;
    }

    .dot {
      cursor: pointer;
      height: 15px;
      width: 15px;
      margin: 0 5px;
      background-color: #bbb;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.6s ease;
    }

    .active, .dot:hover {
      background-color: #418FDE;
    }

    /* Fading animation */
    .fade {
      animation-name: fade;
      animation-duration: 1.5s;
    }

    @keyframes fade {
      from {opacity: .4} 
      to {opacity: 1}
    }

    /* Title Container with Logo, Title, and Info Card */
    #title-container {
      display: flex;
      align-items: center;
      background: linear-gradient(135deg, #418FDE 0%, #2A6FBB 100%);
      padding: 15px 30px;
      color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap;
      opacity: 0;
      transform: translateY(20px);gap: 30px
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.2s;
      gap: 30px;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .title-image {
      width: 220px;
      height: 90px;
      margin-right: 20px;
      border-radius: 5px;
      object-fit: contain;
    }

    #title {
      flex: 1;
      text-align: left;
      min-width: 300px;
    }

    #title h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
      border-bottom: 3px solid rgba(255,255,255,0.3);
      padding-bottom: 8px;
      display: inline-block;
      letter-spacing: 0.5px;
    }

    #title h2 {
      margin: 10px 0 0;
      font-size: 18px;
      font-weight: 400;
      color: rgba(255,255,255,0.9);
    }

    /* Consistent title styling for all sections */
    h2 {
      color: #2A6FBB;
      font-size: 22px;
      font-weight: 600;
      text-align: left;
      margin: 0 0 15px;
      
    }

    /* Description container styling */
    #description-container {
      display: flex;
      background-color: #ffffff;
      border-radius: 12px;
      padding: 20px 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.4s;
    }

    #description-container p {
      font-size: 15px;
      line-height: 1.7;
      color: #555;
      margin-bottom: 15px;
    }

    #description-container strong { color: #333; font-weight: 600; }
    #description-container .data-point { color: #418FDE; font-weight: 600; }

    /* Enhanced Dashboard Cards Styling */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.6s;
    }

    .dashboard-card {
      position: relative;
      padding: 25px;
      border-radius: 12px;
      background: white;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      text-align: center;
      transition: all 0.3s ease;
      overflow: hidden;
      border-top: 4px solid var(--card-color);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--card-color);
    }

    .dashboard-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.15);
    }

    .card-icon {
      width: 50px;
      height: 50px;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(var(--card-color-rgb), 0.1);
      border-radius: 50%;
      color: var(--card-color);
    }

    .dashboard-card h3 {
      margin: 0 0 10px 0;
      color: #555;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .dashboard-card .value {
      font-size: 32px;
      font-weight: 700;
      color: var(--card-color);
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .dashboard-card .change {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
      padding: 5px 12px;
      border-radius: 20px;
      margin-bottom: 15px;
    }

    .change.positive {
      background-color: rgba(40, 167, 69, 0.15);
      color: #28a745;
    }

    .change.negative {
      background-color: rgba(220, 53, 69, 0.15);
      color: #dc3545;
    }

    .change i {
      font-size: 10px;
    }

    .card-footer {
      font-size: 12px;
      color: #888;
      padding-top: 10px;
      border-top: 1px dashed #eee;
      margin-top: 10px;
    }

    /* Set RGB values for the cards */
    .dashboard-card:nth-child(1) {
      --card-color: #2A81CB;
      --card-color-rgb: 42, 129, 203;
    }
    .dashboard-card:nth-child(2) {
      --card-color: #5CB85C;
      --card-color-rgb: 92, 184, 92;
    }
    .dashboard-card:nth-child(3) {
      --card-color: #F0AD4E;
      --card-color-rgb: 240, 173, 78;
    }
    .dashboard-card:nth-child(4) {
      --card-color: #D9534F;
      --card-color-rgb: 217, 83, 79;
    }
    .dashboard-card:nth-child(5) {
      --card-color: #5BC0DE;
      --card-color-rgb: 91, 192, 222;
    }

    /* Parent Container for Text and Map */
    .idps-frame-container {
      display: flex;
      gap: 20px;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.8s;
    }

    /* Text Container for Total Number of IDPs by STATE */
    #idps-text-container {
      flex: 1;
      background-color: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    #idps-text-container p {
      font-size: 15px;
      line-height: 1.7;
      color: #555;
      margin-bottom: 15px;
    }

    #idps-text-container ul {
      list-style-type: none;
      margin-left: 0;
      padding-left: 0;
      color: #555;
    }

    #idps-text-container ul li {
      margin-bottom: 10px;
      padding-left: 20px;
      position: relative;
      line-height: 1.6;
    }

    #idps-text-container ul li:before {
      content: "•";
      color: #418FDE;
      font-size: 20px;
      position: absolute;
      left: 0;
      top: -2px;
    }

    #idps-text-container strong {
      color: #333;
      font-weight: 600;
    }

    #idps-text-container h3 {
      color: #2A6FBB;
      font-size: 18px;
      margin: 20px 0 10px;
      border-bottom: 1px solid #e0e8f5;
      padding-bottom: 5px;
    }

    /* Map Container for Total Number of IDPs by State */
    #map-container-3 {
      flex: 2;
      background-color: #ffffff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    #map3 {
      width: 100%;
      height: 80vh;
      border-radius: 8px;
    }

    /* Maps container styling */
    .maps-container {
      display: flex;
      gap: 20px;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.8s;
    }

    #map-container, #map-container-2, #map-container-4 {
      flex: 1;
      background-color: #ffffff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    #map, #map2, #map4 {
      width: 100%;
      height: 80vh;
      border-radius: 8px;
    }

    /* Mobility in Sudan Text Container */
    #mobility-text-container {
      flex: 1;
      background-color: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      font-size: 15px;
      line-height: 1.7;
      color: #555;
    }

    #mobility-text-container p {
      margin-bottom: 15px;
    }

    #mobility-text-container strong {
      color: #333;
      font-weight: 600;
    }

    #mobility-text-container .data-point {
      color: #418FDE;
      font-weight: 600;
    }

    #mobility-text-container ul {
      list-style-type: none;
      margin-left: 0;
      padding-left: 0;
    }

    #mobility-text-container ul li {
      margin-bottom: 10px;
      padding-left: 20px;
      position: relative;
    }

    #mobility-text-container ul li:before {
      content: "•";
      color: #418FDE;
      font-size: 20px;
      position: absolute;
      left: 0;
      top: -2px;
    }

    /* Pie Chart Map Showing Displacement Proportions */
    #map5 {
      height: 600px;
      border-radius: 8px;
    }
    
    .legend {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Country Circle Map Styles */
    #country-circle-map {
      height: 600px;
      border-radius: 8px;
    }

    /* Drill-down back button */
    .drilldown-back {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1000;
      background: #418FDE;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 6px;
      cursor: pointer;
      display: none;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    .drilldown-back:hover {
      background: #2a6fbb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Heatmap controls styling */
    .heatmap-control-button {
      background-color: #418FDE;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .heatmap-control-button:hover {
      background-color: #2a6fbb;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    #heatmap-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
      gap: 15px;
    }

    #heatmap-slider {
      flex-grow: 1;
      margin: 0 15px;
      height: 6px;
      border-radius: 3px;
      background: #e0e8f5;
      -webkit-appearance: none;
    }

    #heatmap-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #418FDE;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #heatmap-time-display {
      min-width: 100px;
      text-align: center;
      font-weight: 600;
      color: #2A6FBB;
    }
    
    /* Enhanced Legend Styles */
    .legend {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 220px;
    }
    
    .legend h4 {
      margin: 0 0 10px;
      color: #2A6FBB;
      font-size: 15px;
      font-weight: 600;
    }
    
    .legend-checkbox {
      margin: 8px 0;
      display: flex;
      align-items: center;
    }
    
    .legend-checkbox input {
      margin-right: 10px;
      accent-color: #418FDE;
    }
    
    .legend-checkbox label {
      font-size: 14px;
      color: #555;
    }
    
    .marker-size-controls {
      margin-top: 15px;
    }
    
    .marker-size-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      gap: 5px;
    }
    
    .marker-size-buttons button {
      padding: 6px 12px;
      font-size: 13px;
      background-color: #f0f4fa;
      border: 1px solid #d9e0f1;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .marker-size-buttons button:hover {
      background-color: #e0e8f5;
    }
    
    .marker-size-buttons button.active {
      background-color: #418FDE;
      color: white;
      border-color: #2a6fbb;
    }
    
    .marker-size-label {
      font-size: 13px;
      color: #777;
      margin-bottom: 5px;
    }
    
    /* Footer styling */
    footer {
      background: linear-gradient(135deg, #418FDE 0%, #2A6FBB 100%);
      color: #FFFFFF;
      text-align: center;
      padding: 20px;
      font-size: 14px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 1.4s;
    }

    footer p {
      margin: 0 0 10px;
    }

    .footer-links {
      margin: 10px 0;
    }

    .footer-links a {
      color: white;
      margin: 0 10px;
      font-weight: 500;
      position: relative;
    }

    .footer-links a:after {
      content: "";
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 1px;
      background: white;
      transition: width 0.3s ease;
    }

    .footer-links a:hover:after {
      width: 100%;
    }

    .footer-info {
      margin-top: 10px;
    }

    .footer-info a {
      color: white;
      font-weight: 500;
    }

    /* Disclaimer paragraph */
    .disclaimer {
      background-color: #f8f9fa;
      border-left: 4px solid #FF671F;
      padding: 20px;
      font-size: 14px;
      line-height: 1.6;
      border-radius: 0 8px 8px 0;
    }

    .disclaimer p {
      margin: 0;
      color: #555;
    }

    .disclaimer strong {
      color: #FF671F;
    }

    /* Donor logo */
    .donor-logo {
      width: 100%;
      height: auto;
      display: block;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* Responsive design for smaller screens */
    @media (max-width: 992px) {
      .idps-frame-container {
        flex-direction: column;
      }

      #map-container-3, #idps-text-container {
        flex: 1;
      }

      #map3 {
        height: 60vh;
      }
    }

    @media (max-width: 768px) {
      #title-container { 
        flex-direction: column; 
        align-items: flex-start; 
        padding: 20px;
      }
      
      .title-image {
        margin: 0 0 15px 0;
      }
      
      #title h1 {
        font-size: 24px;
      }
      
      .content-container { 
        flex-direction: column; 
      }
      
      #map, #map2, #map3, #map4, #map5, #country-circle-map { 
        height: 70vh; 
      }

      .dashboard-cards {
        grid-template-columns: 1fr;
      }

      /* Adjust slideshow for mobile */
      .slide img {
        max-height: 300px;
      }
      
      .prev, .next {
        padding: 15px;
        font-size: 18px;
      }
      
      /* Adjust loading spinner for mobile */
      .spinner {
        width: 60px;
        height: 60px;
      }
      
      .spinner-dot {
        width: 12px;
        height: 12px;
      }
      
      .loading-text {
        font-size: 16px;
      }

      /* Adjust heatmap controls for mobile */
      #heatmap-controls {
        flex-direction: column;
        align-items: stretch;
      }

      #heatmap-slider {
        width: 100%;
        margin: 15px 0;
      }

      #heatmap-time-display {
        margin: 5px 0;
      }
      
      /* Adjust legend for mobile */
      .legend {
        max-width: 180px;
        padding: 12px;
      }
      
      .marker-size-buttons {
        flex-direction: column;
      }
      
      .marker-size-buttons button {
        margin-bottom: 5px;
      }
    }

    @media print {
      body { 
        font-size: 12pt; 
        color: #000; 
        background: white;
        padding: 10px;
      }
      
      .dashboard-cards, .maps-container { 
        page-break-inside: avoid; 
      }
      
      footer { 
        display: none; 
      }
      
      #loading-spinner {
        display: none;
      }
      
      .slideshow-container, .dots {
        display: none;
      }
    }
  </style>
</head>

<body>
  <div class="main-container">
    <!-- Loading Spinner -->
    <div id="loading-spinner">
      <div class="spinner">
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
      </div>
      <div class="loading-text">Loading Displacement Data...</div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="progress-bar"></div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section">
      <!-- Title Container with Logo, Title, and Info Card -->
      <div id="title-container">
        <div id="title">
          <h1>SUDAN | DISPLACEMENT TRACKING MATRIX - SUDAN MOBILITY</h1>
          <h2><strong>Two Years of Displacement</strong></h2>
        </div>
        <!-- Add this image element to the right side of the title -->
        <img src="./data/IOM_DTM_WHITE.png" alt="IOM Logo" class="title-image">
      </div>
      
      <!-- Slideshow Gallery -->
      <div class="slideshow-container">
        <div class="slide fade">
          <img src="./data/image5.jpg" alt="Displacement Image 1">
        </div>
        
        <div class="slide fade">
          <img src="./data/image5.jpg" alt="Displacement Image 2">
        </div>
        
        <div class="slide fade">
          <img src="./data/image5.jpg" alt="Displacement Image 3"> 
        </div>
        
        <!-- Next and previous buttons -->
        <a class="prev" onclick="plusSlides(-1)">❮</a>
        <a class="next" onclick="plusSlides(1)">❯</a>
      </div>
      
      <!-- The dots/circles -->
      <div class="dots">
        <span class="dot" onclick="currentSlide(1)"></span> 
        <span class="dot" onclick="currentSlide(2)"></span> 
        <span class="dot" onclick="currentSlide(3)"></span> 
      </div>

      <!-- Dashboard Cards Container -->
      <div class="dashboard-cards">
        <!-- Card 1: Internally Displaced Persons -->
        <div class="dashboard-card" style="--card-color: #2A81CB;">
          <div class="card-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
            </svg>
          </div>
          <h3>Internally Displaced</h3>
          <div class="value">11,301,340</div>
          <div class="change negative">
            <i class="fas fa-arrow-down"></i> 3.2% since last month
          </div>
          <div class="card-footer">Nationwide</div>
        </div>

        <!-- Card 2: Returnees -->
        <div class="dashboard-card" style="--card-color: #5CB85C;">
          <div class="card-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M12,3L2,12H5V20H19V12H22L12,3M12,7.7L16,11.2V18H14V14H10V18H8V11.2L12,7.7Z" />
            </svg>
          </div>
          <h3>Returnees</h3>
          <div class="value">396,738</div>
          <div class="change negative">
            <i class="fas fa-arrow-down"></i> 1.5% since last month
          </div>
          <div class="card-footer">Northern regions</div>
        </div>

        <!-- Card 3: Crossing Border -->
        <div class="dashboard-card" style="--card-color: #F0AD4E;">
          <div class="card-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M17,20V22H7V20H17M19,20H21V22H19V20M12,2C14.5,2 16.75,2.9 18.5,4.4C16.36,6.23 15,8.96 15,12C15,15.04 16.36,17.77 18.5,19.6C16.75,21.1 14.5,22 12,22C9.5,22 7.25,21.1 5.5,19.6C7.64,17.77 9,15.04 9,12C9,8.96 7.64,6.23 5.5,4.4C7.25,2.9 9.5,2 12,2M12,4C10.07,4 8.5,5.57 8.5,7.5C8.5,9.43 10.07,11 12,11C13.93,11 15.5,9.43 15.5,7.5C15.5,5.57 13.93,4 12,4Z" />
            </svg>
          </div>
          <h3>Crossing Border</h3>
          <div class="value">3,934,086</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i> 0.8% since last month
          </div>
          <div class="card-footer">Neighboring countries</div>
        </div>

        <!-- Card 4: Migrants Affected -->
        <div class="dashboard-card" style="--card-color: #D9534F;">
          <div class="card-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M15,5A1,1 0 0,1 14,4A1,1 0 0,1 15,3A1,1 0 0,1 16,4A1,1 0 0,1 15,5M14,7H15.5C16.88,7 18,8.12 18,9.5C18,10.88 16.88,12 15.5,12H15V13H19V15H15.25C14.03,15 13,13.97 13,12.75V9.5C13,8.67 13.67,8 14.5,8H15V7M11,9V15H9V9H11M9,7V5H11V7H9M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2Z" />
            </svg>
          </div>
          <h3>Migrants Affected</h3>
          <div class="value">400,000</div>
          <div class="change negative">
            <i class="fas fa-arrow-down"></i> 2.1% since last month
          </div>
          <div class="card-footer">Urban centers</div>
        </div>

        <!-- Card 5: Locations Covered -->
        <div class="dashboard-card" style="--card-color: #5BC0DE;">
          <div class="card-icon">
            <svg viewBox="0 0 24 24" width="24" height="24">
              <path fill="currentColor" d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z" />
            </svg>
          </div>
          <h3>Locations Covered</h3>
          <div class="value">10,285</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i> 1.2% since last month
          </div>
          <div class="card-footer">Across Sudan</div>
        </div>
      </div>
    </div>
     
    <!-- IDPs Section -->
    <div id="idps-section" class="idps-frame-container">
      <!-- Text Container for Total Number of IDPs by State -->
      <div id="idps-text-container">
        <h2>CONTEXT</h2>
        <p>
         Sudan hosts an estimated 11,301,340 internally displaced
        persons (IDPs) as of 30 March 2025, including those
        displaced both before and after the outbreak of the conflict
        between the Sudanese Armed Forces (SAF) and Rapid
        Support Forces (RSF) on 15 April 2023.This report analyses displacement pathways and key
        demographic information for the total population of
        IDPs across Sudan, as well as data on mixed cross-border
        movements into neighbouring countries.
        </p>
        <h3>KEY FACTS AND FIGURES:</h3>
        <ul>
          <li><strong>30%</strong> of a population is displaced both internally and externally</li>
          <li><strong>11.3 Million</strong> people have been displaced internally across all of Sudan, highlighting a severe humanitarian crisis driven by conflict, instability, and other factors.</li>
          <li><strong>3.9 Million</strong> people have been displaced externally from Sudan</li>
          <li><strong>3.63 Million</strong> IDPs are concentrated in South Darfur and North Darfur, underscoring the immense scale of displacement and humanitarian needs in these regions.</li>
          <li><strong>4 Million</strong> IDPs live in camps across Sudan</li>
          <li><strong>7.4 Million</strong> IDPs have been displaced from Khartoum, South Darfur, and North Darfur,</li>
        </ul>
      </div>

      <!-- Map Container for Total Number of IDPs by State -->
      <div id="map-container-3">
        <h2 id="map-title-3">Total Number of IDPs by State</h2>
        <button id="drilldown-back" class="drilldown-back">← Back to States</button>
        <div id="map3"></div>
      </div>
    </div>
    
    <!-- Displacement Section -->
    <div id="displacement-section" class="maps-container">
      <div id="map-container">
        <h2>Displacement Proportions by State</h2>
        <div id="mobility-text-container">
          <p>
            This map visualizes the proportion of each state's population that has been displaced by the ongoing conflict. The pie chart markers show at a glance which states have been most severely affected, with the orange segments representing displaced populations and blue segments showing remaining residents.
          </p>
          <p>
            <strong>Key insights from the map visualization:</strong>
            <ul>
              <li><strong>North Darfur stands out</strong> with the highest displacement proportion (66%) - nearly two-thirds of its population has been forced to flee</li>
              <li><strong>South Darfur shows</strong> the largest absolute numbers (over 2 million displaced) despite being a smaller proportion (53%) of its larger population</li>
              <li><strong>Khartoum's displacement</strong> (3.5 million people) represents 38% of the state's population, visible through the relative sizes of the pie segments</li>
              <li><strong>Northern states</strong> like Northern and Red Sea show much smaller displacement proportions (1-2%), visible through their predominantly blue pie charts</li>
            </ul>
          </p>
          <p>
            <strong>How to interpret the map symbols:</strong>
            <ul>
              <li>Each pie chart is scaled to the state's total population size</li>
              <li>Orange segments show displaced populations</li>
              <li>Blue segments show non-displaced populations</li>
              <li>The percentage label in each pie shows the exact displacement proportion</li>
              <li>Larger pies indicate states with bigger total populations</li>
            </ul>
          </p>
          <p>
            The spatial distribution reveals clear patterns - states in Darfur and Khartoum show the most severe displacement, while northern and eastern states have been less affected. This visualization helps humanitarian actors quickly identify where needs are greatest and how displacement is impacting different regions proportionally.
          </p>
          <p>
            <strong>Map interaction tips:</strong>
            <ul>
              <li>Click on any pie chart to see detailed state statistics</li>
              <li>Compare states by both segment size (proportion) and overall pie size (total population)</li>
              <li>Note the concentration of large orange segments in western Sudan</li>
            </ul>
          </p>
        </div>
        <div id="map5"></div>
      </div>
    </div>
    
    <!-- Pathways Section -->
    <div id="pathways-section" class="maps-container">
      <div id="map-container-2">
        <h2 id="map-title-2">IDPs Pathways Across Sudan</h2>
        <div id="mobility-text-container">
          <p>
            This map visualizes the complex movement patterns of Internally Displaced Persons (IDPs) across Sudan. The animated flow lines represent the pathways taken by displaced populations, with their thickness indicating the relative volume of movement between locations. The map reveals several critical displacement corridors that have emerged during the crisis.
          </p>
          <p>
            <strong>Key displacement patterns shown:</strong>
            <ul>
              <li><strong>Mass exodus from Khartoum:</strong> Thick flow lines show the movement of over 3.5 million people from the capital to neighboring states, particularly to Aj Jazirah, Sennar, and White Nile states.</li>
              <li><strong>Darfur cross-border movements:</strong> Significant flows from Darfur states into neighboring Chad and South Sudan, with particularly heavy movement from West Darfur to Chad.</li>
              <li><strong>Secondary displacement:</strong> Many IDPs who initially fled to relatively safer areas like Aj Jazirah have been forced to move again as conflict spread.</li>
              <li><strong>Urban to rural movement:</strong> The majority of flows show displacement from urban centers to rural areas, straining already limited resources in receiving communities.</li>
            </ul>
          </p>
          <p>
            <strong>How to use this map:</strong>
            <ul>
              <li>Click on any flow line to see details about that displacement pathway</li>
              <li>Hover over origin or destination points to see total numbers</li>
              <li>Note that line thickness represents relative volume - thicker lines indicate larger numbers of displaced persons</li>
              <li>The animation direction shows the direction of displacement</li>
            </ul>
          </p>
          <p>
            These displacement pathways have significant implications for humanitarian response, as they show where needs are concentrated and help predict where populations may move next based on conflict patterns and existing migration routes.
          </p>
        </div>
        <div id="map2"></div>
      </div>
    </div>
    
    <!-- Country Circle Propagation Map -->
    <div class="maps-container">
      <div id="map-container">
        <div id="mobility-text-container">
          <h2>Displacement to Neighboring Countries</h2>
          <p>
            The map below illustrates the significant displacement of Sudanese populations to neighboring countries since the conflict began. The size of each circle represents the relative number of displaced persons in each country, with the largest flows going to Egypt, Chad, and South Sudan. This external displacement has created regional humanitarian challenges, with over 3.9 million Sudanese refugees now living in neighboring countries.
          </p>
          <p>
            <strong>Key observations:</strong>
            <ul>
              <li><strong>Egypt</strong> has received the largest number of displaced persons (1.5 million), representing 38% of all cross-border displacement</li>
              <li><strong>Chad</strong> hosts 767,365 Sudanese refugees, primarily from Darfur region</li>
              <li><strong>South Sudan</strong> has received 341,909 returnees and refugees despite its own humanitarian challenges</li>
              <li>Smaller but significant flows have gone to Ethiopia (88,001), Libya (105,721), and Central African Republic (35,376)</li>
            </ul>
          </p>
          <p>
            These displacement patterns reflect both historical migration routes and the geographical proximity to conflict zones, with Darfur refugees primarily going to Chad, while those from eastern Sudan flee to Ethiopia and Egypt.
          </p>
        </div>
        <div id="country-circle-map"></div>
      </div>
    </div>  
    
    <!-- Heatmap Section -->
    <div id="heatmap-section" class="maps-container">
      <div id="heatmap-container">
        <h2>Mobility Over Time (2023 - 2025)</h2>
        <div id="mobility-text-container">
          <p>
            This interactive heatmap visualization shows the progression of displacement over time. The heat intensity represents the number of displaced persons, with darker colors indicating higher numbers. Use the time slider or play button to see how the situation evolved month by month.
          </p>
          <p>
            <strong>Key patterns to observe:</strong>
            <ul>
              <li>The rapid increase in IDPs (blue line) in the first months of the conflict</li>
              <li>The sudden spike in May 2024 when displacement surpassed 10 million</li>
              <li>The appearance of returnees (orange line) only in the most recent data</li>
            </ul>
          </p>
        </div>
        <div id="heatmapChart" style="height: 400px;"></div>
        <div id="heatmap-controls">
          <button id="heatmap-play-button" class="heatmap-control-button">▶ Play</button>
          <input type="range" id="heatmap-slider" min="0" max="19" value="0" step="1" style="width: 70%; margin: 0 15px;">
          <span id="heatmap-time-display" style="font-weight: bold; color: #418FDE;">Aug-2023</span>
          <button id="heatmap-export-button" class="heatmap-control-button">Export as Image</button>
        </div>
      </div>
    </div>

    <!-- Returnees Section -->
    <div id="returnees-section" class="idps-frame-container">
      <!-- Map Container for Total Number of Returnees by State -->
      <div id="map-container-4">
        <h2 id="map-title-4">Total Number of Returnees by State</h2>
        <div id="map4"></div>
      </div>

      <!-- Text Container for Mobility in Sudan -->
      <div id="mobility-text-container">
        <h2>Returns and Cross-Border Movements</h2>
        <p>Since December 2024, DTM teams have monitored 396,738 individuals returning to their places of origin in Sudan—a significant shift in displacement trends after nearly two years of conflict between the Rapid Support Forces (RSF) and Sudanese Armed Forces (SAF).</p>
        
        <h3>Primary Return Destinations</h3>
        <ul>
          <li><strong>Aj Jazirah</strong>: 66% of returnees he highest proportion of returnees, driven by improved access and relative stability </li>
          <li><strong>Sennar</strong>: 29% of returnees</li>
          <li><strong>Khartoum</strong>: 5% of returnees Limited returns to the capital reflect ongoing insecurity, infrastructure damage, and lack of basic services.</li>
        </ul>
        
        <h2>Key Findings on Returns</h2>
        <p>For the first time since the outbreak of war in April 2023, the number of internally displaced persons (IDPs) in Sudan has shown a decline, indicating early signs of return movements. However, these returns remain fragile, Many returning households are engaging in short-term visits rather than permanent resettlement, primarily to evaluate security conditions, access essential services, or retrieve belongings. This behavior indicates ongoing insecurity and a lack of confidence in long-term safety.</p>
        <p>the majority of Sudanese fleeing abroad—particularly to neighboring countries like Egypt, South Sudan, and Ethiopia—have come from Khartoum and Al Jazira states, As a result, any significant return movements from abroad will likely originate from these areas .</p>
      </div>
    </div>

    <!-- Maps Container for Returnee Pathways -->
    <div class="maps-container">
      <div id="map-container-2">
        <h2 id="map-title">Returnee Pathways Across Sudan</h2>
        <div id="map"></div>
      </div>
    </div>
    
    <!-- Disclaimer paragraph -->
    <div class="disclaimer">
      <p>
        <strong>DISCLAIMER:</strong> Due to on-going insecurity, DTM collects data through a dual 
        combination of in-person and remote interviews with key informants across its network. 
        Figures should be understood as preliminary estimates and are subject to change pending 
        future verification exercises. Percentages across the report may not equal 100 per cent 
        due to rounding.
      </p>
    </div>

    <!-- Add image above the footer -->
    <img src="./data/doner.png" alt="Donor Logo" class="donor-logo">

    <!-- Footer -->
    <footer>
      <p>&copy; 2025 International Organization for Migration | IOM, UN Migration. Sudan | Displacement Tracking Matrix</p>
      <div class="footer-links">
        <a href="https://dtm.iom.int/sudan" target="_blank">Visit IOM Sudan Website</a>
        <a href="https://displacement.iom.int/" target="_blank">DTM Global Website</a>
      </div>
      <div class="footer-info">
        <p>For more information, please contact <a href="mailto:dtmsudan@iom.int">dtmsudan@iom.int</a>.</p>
      </div>
    </footer>
  </div>

  <!-- External Scripts -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>

  <script>
    // Loading spinner functionality
    document.addEventListener('DOMContentLoaded', function() {
      // Simulate loading progress
      let progress = 0;
      const progressBar = document.getElementById('progress-bar');
      const loadingSpinner = document.getElementById('loading-spinner');
      const loadingText = document.querySelector('.loading-text');
      
      // Update progress bar
      const progressInterval = setInterval(function() {
        progress += Math.random() * 10;
        if (progress >= 100) {
          progress = 100;
          clearInterval(progressInterval);
          
          // Change text when loading is complete
          loadingText.textContent = 'Almost there...';
          
          // Add a small delay before hiding to ensure everything is loaded
          setTimeout(function() {
            loadingSpinner.style.opacity = '0';
            setTimeout(function() {
              loadingSpinner.style.display = 'none';
              document.body.style.animation = 'fadeIn 1.5s ease-in-out forwards';
            }, 500);
          }, 500);
        }
        progressBar.style.width = progress + '%';
      }, 200);
    });

    // Slideshow functionality
    let slideIndex = 1;
    showSlides(slideIndex);
    
    // Next/previous controls
    function plusSlides(n) {
      showSlides(slideIndex += n);
    }
    
    // Thumbnail image controls
    function currentSlide(n) {
      showSlides(slideIndex = n);
    }
    
    function showSlides(n) {
      let i;
      let slides = document.getElementsByClassName("slide");
      let dots = document.getElementsByClassName("dot");
      
      if (n > slides.length) {slideIndex = 1}
      if (n < 1) {slideIndex = slides.length}
      
      for (i = 0; i < slides.length; i++) {
        slides[i].style.display = "none";
      }
      
      for (i = 0; i < dots.length; i++) {
        dots[i].className = dots[i].className.replace(" active", "");
      }
      
      slides[slideIndex-1].style.display = "block";
      dots[slideIndex-1].className += " active";
    }
    
    // Auto-advance slides every 5 seconds
    setInterval(() => {
      plusSlides(1);
    }, 5000);

    // Define Mapbox custom layers
    const mapboxCustom1 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxCustom2 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxCustom3 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxCustom4 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    // Initialize the first map
    const map = L.map('map').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the first map
    const cartoDBLight1 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap1 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery1 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner1 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    const mapboxLight = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxStreets = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxSatellite = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxOutdoors = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/outdoors-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    // Add default base layer to the first map
    mapboxCustom1.addTo(map);

    // Add layer control to the first map
    const baseLayers1 = {
      "Mapbox Custom": mapboxCustom1,
      "CartoDB Light": cartoDBLight1,
      "OpenStreetMap": openStreetMap1,
      "Esri World Imagery": esriWorldImagery1,
      "Stamen Toner": stamenToner1,
      "Mapbox Light": mapboxLight,
      "Mapbox Streets": mapboxStreets,
      "Mapbox Outdoors": mapboxOutdoors,
      "Mapbox Satellite": mapboxSatellite
    };

    L.control.layers(baseLayers1).addTo(map);

    // Parse CSV data and create flow map layer for the first map
    Papa.parse('./data/data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        flowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => {
            const baseRadius = 6;
            const maxRadius = 20;
            const volume = feature.properties.e_Volume || 0;

            const radius = feature.properties.isOrigin
              ? baseRadius
              : Math.min(baseRadius + (volume / 5000), maxRadius);

            return {
              radius: radius,
              weight: 1,
              color: feature.properties.isOrigin ? '#FFFFFF' : '#FFFFFF',
              fillColor: feature.properties.isOrigin ? '#418FDE' : 'rgb(255, 103, 31)',
              fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
            };
          },
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
            ],
            defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: addTooltip
        }).addTo(map);

        // Add tooltip and popup to features
        function addTooltip(feature, layer) {
          const tooltipContent = feature.properties.isOrigin
            ? `State of Displacement: ${feature.properties.s_State}`
            : `State of Return: ${feature.properties.e_locality}`;

          layer.bindTooltip(tooltipContent);
          layer.on('mouseover', () => layer.openTooltip());
          layer.on('mouseout', () => layer.closeTooltip());

          // Add popup
          const popupContent = feature.properties.isOrigin
            ? `<b>State of Displacement:</b> ${feature.properties.s_State}`
            : `<b>State of Return:</b> ${feature.properties.e_locality}`;

          layer.bindPopup(popupContent);
        }

        // Highlight paths on mouseover
        flowmapLayer.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      }
    });

    // Add legend to the first map
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px">Returnee Flow Volume:</span><br/>
        <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> < 10000</span><br/>
        <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold">10,001 - 20,000</span><br/>
        <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> > 20,000</span><br/>
      `;
      return div;
    };
    legend.addTo(map);

    // Initialize the second map
    const map2 = L.map('map2').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the second map
    const cartoDBLight2 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap2 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery2 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner2 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the second map
    mapboxCustom2.addTo(map2);

    // Add layer control to the second map
    const baseLayers2 = {
      "Mapbox Custom": mapboxCustom2,
      "CartoDB Light": cartoDBLight2,
      "OpenStreetMap": openStreetMap2,
      "Esri World Imagery": esriWorldImagery2,
      "Stamen Toner": stamenToner2
    };

    L.control.layers(baseLayers2).addTo(map2);

    // Parse CSV data and create flow map layer for the second map
    Papa.parse('./data/data_idps.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection2 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        const flowmapLayer2 = L.canvasFlowmapLayer(geoJsonFeatureCollection2, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => {
            const baseRadius = 12;
            const maxRadius = 6;
            const volume = feature.properties.e_Volume || 0;

            const radius = feature.properties.isOrigin
              ? baseRadius
              : Math.min(baseRadius + (volume / 5000), maxRadius);

            return {
              radius: radius,
              weight: 1,
              color: feature.properties.isOrigin ? '#FFFFFF' : '#FFFFFF',
              fillColor: feature.properties.isOrigin ? 'rgb(255, 103, 31)' : '#418FDE',
              fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
            };
          },
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
            ],
            defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: addTooltip
        }).addTo(map2);

        // Add tooltip and popup to features
        function addTooltip(feature, layer) {
          const tooltipContent = feature.properties.isOrigin
            ? `State of Displacement: ${feature.properties.s_State}`
            : `State of Return: ${feature.properties.e_locality}`;

          layer.bindTooltip(tooltipContent);
          layer.on('mouseover', () => layer.openTooltip());
          layer.on('mouseout', () => layer.closeTooltip());

          // Add popup
          const popupContent = feature.properties.isOrigin
            ? `<b>Displacement From:</b> ${feature.properties.s_State}`
            : `<b>Displacement To:</b> ${feature.properties.e_locality}`;

          layer.bindPopup(popupContent);
        }

        // Highlight paths on mouseover
        flowmapLayer2.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer2.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      }
    });

    // Add legend to the second map
    const legend2 = L.control({ position: 'bottomright' });
    legend2.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px">Returnee Flow Volume:</span><br/>
        <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> < 10000</span><br/>
        <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold">10,001 - 20,000</span><br/>
        <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> > 20,000</span><br/>
      `;
      return div;
    };
    legend2.addTo(map2);

    // Initialize the third map
    const map3 = L.map('map3').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the third map
    const cartoDBLight3 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap3 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery3 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner3 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the third map
    mapboxCustom3.addTo(map3);

    // Add layer control to the third map
    const baseLayers3 = {
      "Mapbox Custom": mapboxCustom3,
      "CartoDB Light": cartoDBLight3,
      "OpenStreetMap": openStreetMap3,
      "Esri World Imagery": esriWorldImagery3,
      "Stamen Toner": stamenToner3
    };

    L.control.layers(baseLayers3).addTo(map3);

    // Variables for drill-down functionality
    let stateMarkersLayer = L.layerGroup();
    let districtMarkersLayer = L.layerGroup();
    let currentState = null;
    const drilldownBackBtn = document.getElementById('drilldown-back');

    // Function to load district data for a state
    function loadDistrictData(stateName) {
      // Show loading indicator
      document.getElementById('map-title-3').textContent = `Loading districts for ${stateName}...`;
      
      // In a real application, you would load district data from your server or CSV file
      // For this example, we'll use a mock data structure
      Papa.parse('./data/districts_data.csv', {
        download: true,
        header: true,
        dynamicTyping: true,
        skipEmptyLines: true,
        complete: (results) => {
          // Filter districts for the selected state
          const stateDistricts = results.data.filter(d => d.state === stateName);
          
          // Clear previous district markers
          districtMarkersLayer.clearLayers();
          
          // Find the maximum total_idps value for normalization
          const maxTotalIdps = Math.max(...stateDistricts.map(d => d.total_idps));
          
          // Add markers for each district
          stateDistricts.forEach(district => {
            const baseRadius = 8 + (district.total_idps / maxTotalIdps) * 20;
            
            const marker = L.circleMarker([district.lat, district.lon], {
              radius: baseRadius,
              fillColor: '#418FDE', // Different color for districts
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });
            
            // Add animation
            animateCircleMarker(marker, baseRadius);
            
            // Add popup
            marker.bindPopup(`
              <b>District:</b> ${district.district}<br/>
              <b>Total IDPs:</b> ${district.total_idps.toLocaleString()}
            `);
            
            // Add tooltip
            marker.bindTooltip(`
              <b>${district.district}</b><br/>
              <b>Total IDPs:</b> ${district.total_idps.toLocaleString()}
            `);
            
            // Add to district layer
            districtMarkersLayer.addLayer(marker);
          });
          
          // Add district layer to map
          map3.addLayer(districtMarkersLayer);
          
          // Update title
          document.getElementById('map-title-3').textContent = `IDPs by District in ${stateName}`;
          
          // Show back button
          drilldownBackBtn.style.display = 'block';
          
          // Store current state
          currentState = stateName;
          
          // Fit bounds to show all districts
          if (stateDistricts.length > 0) {
            const bounds = L.latLngBounds(stateDistricts.map(d => [d.lat, d.lon]));
            map3.fitBounds(bounds, { padding: [50, 50] });
          }
        },
        error: (error) => {
          console.error('Error loading district data:', error);
          alert('Failed to load district data. Please try again.');
          document.getElementById('map-title-3').textContent = 'Total Number of IDPs by State';
        }
      });
    }

    // Back button functionality
    drilldownBackBtn.addEventListener('click', function() {
      // Remove district layer
      map3.removeLayer(districtMarkersLayer);
      
      // Add state layer back
      map3.addLayer(stateMarkersLayer);
      
      // Reset view
      map3.setView([16, 30], L.Browser.mobile ? 3 : 5.5);
      
      // Update title
      document.getElementById('map-title-3').textContent = 'Total Number of IDPs by State';
      
      // Hide back button
      drilldownBackBtn.style.display = 'none';
      
      // Clear current state
      currentState = null;
    });

    // Parse CSV data and create animated markers for the third map
    Papa.parse('./data/total_idps.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection3 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.lon, datum.lat] },
            properties: datum
          }))
        };

        // Find the maximum total_idps value for normalization
        const maxTotalIdps = Math.max(...results.data.map(d => d.total_idps));

        // Function to animate circle markers
        function animateCircleMarker(marker, baseRadius) {
          const tween = new TWEEN.Tween({ radius: baseRadius })
            .to({ radius: baseRadius * 1.5 }, 1000) // Animate to 1.5x the base radius
            .easing(TWEEN.Easing.Sinusoidal.InOut) // Smooth easing
            .yoyo(true) // Reverse the animation
            .repeat(Infinity) // Repeat indefinitely
            .onUpdate(({ radius }) => {
              marker.setRadius(radius); // Update the marker's radius
            })
            .start(); // Start the animation
        }

        // Add animated markers to the third map
        L.geoJSON(geoJsonFeatureCollection3, {
          pointToLayer: (feature, latlng) => {
            // Normalize the total_idps value to determine the base radius
            const baseRadius = 8 + (feature.properties.total_idps / maxTotalIdps) * 20;

            // Create a circle marker
            const marker = L.circleMarker(latlng, {
              radius: baseRadius, // Initial radius
              fillColor: '#418FDE', // Blue color for IDPs
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });

            // Animate the marker
            animateCircleMarker(marker, baseRadius);

            // Add click handler for drill-down
            marker.on('click', function(e) {
              // Remove state layer
              map3.removeLayer(stateMarkersLayer);
              
              // Load district data for this state
              loadDistrictData(feature.properties.state);
            });

            return marker;
          },
          onEachFeature: (feature, layer) => {
            const popupContent = `
              <b>State:</b> ${feature.properties.state}<br/>
              <b>Total IDPs:</b> ${feature.properties.total_idps.toLocaleString()}<br/>
              <small>Click to view districts</small>
            `;
            layer.bindPopup(popupContent);

            // Add tooltip
            const tooltipContent = `<b>${feature.properties.state}</b><br/>
              <b>Total IDPs:</b> ${feature.properties.total_idps.toLocaleString()}`;
            layer.bindTooltip(tooltipContent);
          }
        }).addTo(stateMarkersLayer);

        // Add state markers layer to map
        map3.addLayer(stateMarkersLayer);
      }
    });

    // Update Tween.js animations on each frame
    function animate() {
      requestAnimationFrame(animate);
      TWEEN.update();
    }
    animate(); // Start the animation loop

    // Add legend to the third map
    const legend3 = L.control({ position: 'bottomright' });
    legend3.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px; font-weight:bold;">Total IDPs by State:</span><br/>
        <div style="display: flex; align-items: center; margin-top: 10px;">
          <div style="width: 10px; height: 10px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">  < 500,000 IDPs</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 20px; height: 20px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;"> 500,001 - 1,000,000 IDPs</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 30px; height: 30px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;"> > 1,000,001 IDPs</span>
        </div>
        <div style="margin-top: 10px; font-size:12px; color: #666;">
          Click on a state to view district-level data
        </div>
      `;
      return div;
    };
    legend3.addTo(map3);
    
    // Initialize the fourth map
    const map4 = L.map('map4').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the fourth map
    const cartoDBLight4 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap4 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery4 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner4 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the fourth map
    mapboxCustom4.addTo(map4);

    // Add layer control to the fourth map
    const baseLayers4 = {
      "Mapbox Custom": mapboxCustom4,
      "CartoDB Light": cartoDBLight4,
      "OpenStreetMap": openStreetMap4,
      "Esri World Imagery": esriWorldImagery4,
      "Stamen Toner": stamenToner4
    };

    L.control.layers(baseLayers4).addTo(map4);

    // Parse CSV data and create animated markers for the fourth map
    Papa.parse('./data/total_return.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection4 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.lon, datum.lat] },
            properties: datum
          }))
        };

        // Find the maximum total_return value for normalization
        const maxTotalReturn = Math.max(...results.data.map(d => d.total_return));

        // Function to animate circle markers
        function animateCircleMarker(marker, baseRadius) {
          const tween = new TWEEN.Tween({ radius: baseRadius })
            .to({ radius: baseRadius * 1.5 }, 1000) // Animate to 1.5x the base radius
            .easing(TWEEN.Easing.Sinusoidal.InOut) // Smooth easing
            .yoyo(true) // Reverse the animation
            .repeat(Infinity) // Repeat indefinitely
            .onUpdate(({ radius }) => {
              marker.setRadius(radius); // Update the marker's radius
            })
            .start(); // Start the animation
        }

        // Add animated markers to the fourth map
        L.geoJSON(geoJsonFeatureCollection4, {
          pointToLayer: (feature, latlng) => {
            // Normalize the total_return value to determine the base radius
            const baseRadius = 8 + (feature.properties.total_return / maxTotalReturn) * 20;

            // Create a circle marker
            const marker = L.circleMarker(latlng, {
              radius: baseRadius, // Initial radius
              fillColor: 'rgba(255, 103, 31, 0.8)', // Orange color for returnees
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });

            // Animate the marker
            animateCircleMarker(marker, baseRadius);

            return marker;
          },
          onEachFeature: (feature, layer) => {
            const popupContent = `
              <b>State:</b> ${feature.properties.state}<br/>
              <b>Total Returnees:</b> ${feature.properties.total_return.toLocaleString()}
            `;
            layer.bindPopup(popupContent);

            // Add tooltip
            const tooltipContent = `<b>${feature.properties.state}</b><br/>
              <b>Total Returnees:</b> ${feature.properties.total_return.toLocaleString()}`;
            layer.bindTooltip(tooltipContent);
          }
        }).addTo(map4);
      }
    });

    // Add legend to the fourth map
    const legend4 = L.control({ position: 'bottomleft' });
    legend4.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px; font-weight:bold;">Total Returnees by State:</span><br/>
        <div style="display: flex; align-items: center; margin-top: 10px;">
          <div style="width: 10px; height: 10px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">< 10,000 Returnees</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 20px; height: 20px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">10,000 - 50,000 Returnees</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 30px; height: 30px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;"> > 50,000 Returnees</span>
        </div>
      `;
      return div;
    };
    legend4.addTo(map4);

    // Initialize the country circle map with layer controls
    const countryCircleMap = L.map('country-circle-map').setView([16, 30], 5);
    
    // Define multiple base layers for the country circle map
    const cartoDBLightCountry = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMapCountry = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImageryCountry = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenTonerCountry = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    const mapboxCustomCountry = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
      attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      tileSize: 512,
      zoomOffset: -1,
      maxZoom: 18
    });

    // Add default base layer to the country circle map
    mapboxCustomCountry.addTo(countryCircleMap);

    // Add layer control to the country circle map
    const baseLayersCountry = {
      "CartoDB Light": cartoDBLightCountry,
      "OpenStreetMap": openStreetMapCountry,
      "Esri World Imagery": esriWorldImageryCountry,
      "Stamen Toner": stamenTonerCountry,
      "Mapbox Custom": mapboxCustomCountry
    };

    // Country data with coordinates and volume
    const countryData = [
      {country: "Egypt", e_lat: 26.8206, e_lon: 30.8025, Volume: 1500000},
      {country: "libya", e_lat: 26.3351, e_lon: 17.2283, Volume: 105721},
      {country: "Chad", e_lat: 15.4542, e_lon: 18.7322, Volume: 767365},
      {country: "Central African Republic", e_lat: 6.6111, e_lon: 20.9394, Volume: 35376},
      {country: "South Sudan", e_lat: 6.877, e_lon: 31.307, Volume: 341909},
      {country: "Ethiopia", e_lat: 9.145, e_lon: 40.4897, Volume: 88001},
      {country: "Eritrea", e_lat: 15.1794, e_lon: 39.7823, Volume: 14141}
    ];

    // Find the maximum volume for scaling
    const maxVolume = Math.max(...countryData.map(d => d.Volume));

    // Create a layer group for the country circles
    const countryCirclesLayer = L.layerGroup().addTo(countryCircleMap);

    // Function to animate circle markers
    function animateCircleMarker(marker, baseRadius) {
      const tween = new TWEEN.Tween({ radius: baseRadius })
        .to({ radius: baseRadius * 1.5 }, 1500) // Animate to 1.5x the base radius
        .easing(TWEEN.Easing.Sinusoidal.InOut) // Smooth easing
        .yoyo(true) // Reverse the animation
        .repeat(Infinity) // Repeat indefinitely
        .onUpdate(({ radius }) => {
          marker.setRadius(radius); // Update the marker's radius
        })
        .start(); // Start the animation
    }

    // Add animated circle markers for each country to the layer group
    countryData.forEach(country => {
      // Calculate base radius based on volume (scaled to a reasonable size)
      const baseRadius = 5 + (country.Volume / maxVolume) * 30;
      
      // Create circle marker
      const circle = L.circleMarker([country.e_lat, country.e_lon], {
        radius: baseRadius,
        fillColor: '#5CB8B2',
        color: '#fff',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.7
      }).addTo(countryCirclesLayer);

      // Add animation
      animateCircleMarker(circle, baseRadius);

      // Add popup with country info
      circle.bindPopup(`
        <b>${country.country}</b><br>
        Volume: ${country.Volume.toLocaleString()}
      `);

      // Add tooltip
      circle.bindTooltip(`
        <b>${country.country}</b><br>
        Volume: ${country.Volume.toLocaleString()}
      `);
    });

    // Add overlay control for the country circles
    const overlaysCountry = {
      "Displacement Circles": countryCirclesLayer
    };

    // Add layer control with both base layers and overlays
    L.control.layers(baseLayersCountry, overlaysCountry).addTo(countryCircleMap);

    // Add legend for the country circle map
    const countryLegend = L.control({ position: 'bottomright' });
    countryLegend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>Displacement to Neighboring Countries</h4>
        <div style="display: flex; align-items: center; margin: 5px 0;">
          <svg width="20" height="20">
            <circle cx="10" cy="10" r="10" fill="#5CB8B2"/>
          </svg>
          Displaced Population
        </div>
        <p>Circle size represents relative volume</p>
      `;
      return div;
    };
    countryLegend.addTo(countryCircleMap);

    // Pie Chart Map Showing Displacement Proportions
    const map5 = L.map('map5').setView([16, 30], L.Browser.mobile ? 3 : 5.5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map5);

    // State data with coordinates (lat, lng), displaced, total population
    const stateData = [
      ["Aj Jazirah", 14.900, 33.434, 876156, 5687557],
      ["Blue Nile", 11.270, 34.390, 270810, 1344267],
      ["Central Darfur", 12.900, 23.470, 749491, 1786503],
      ["East Darfur", 11.160, 26.140, 247874, 1213951],
      ["Gedaref", 14.040, 35.380, 14327, 2545604],
      ["Kassala", 15.450, 36.400, 6211, 2811446],
      ["Khartoum", 15.501, 32.560, 3500400, 9146191],
      ["North Darfur", 15.766, 27.333, 1844175, 2775652],
      ["North Kordofan", 13.630, 27.930, 91161, 2160476],
      ["Northern", 19.615, 30.416, 12052, 1023194],
      ["Red Sea", 19.580, 37.130, 30480, 1549857],
      ["River Nile", 18.500, 33.800, 53683, 1651873],
      ["Sennar", 13.550, 33.600, 244250, 2170863],
      ["South Darfur", 11.783, 24.883, 2082537, 3912372],
      ["South Kordofan", 11.150, 29.633, 414734, 2017962],
      ["West Darfur", 12.900, 22.466, 368971, 1940860],
      ["West Kordofan", 11.200, 28.433, 314484, 1713462],
      ["White Nile", 13.450, 32.500, 179544, 3046811]
    ];

    // Create pie chart icon function with standardized size
    function createPieChartIcon(displaced, total, sizeFactor = 1) {
      const displacedPercent = displaced / total;
      const endAngle = displacedPercent * 360;
      
      // Use a fixed radius for all pie charts (e.g., 16 pixels)
      const baseRadius = 30;
      const radius = baseRadius * sizeFactor;
      
      const svg = `
        <svg width="${radius * 2}" height="${radius * 2}" viewBox="0 0 ${radius * 2} ${radius * 2}">
          <circle cx="${radius}" cy="${radius}" r="${radius}" fill="#418FDE"/>
          <path d="M${radius},${radius} L${radius},0 A${radius},${radius} 0 ${endAngle > 180 ? 1 : 0},1 
            ${radius + Math.sin((endAngle * Math.PI)/180) * radius},
            ${radius - Math.cos((endAngle * Math.PI)/180) * radius} z" 
            fill="rgba(255, 103, 31, 0.8)"/>
          <circle cx="${radius}" cy="${radius}" r="${radius * 0.6}" fill="white" opacity="0.7"/>
          <text x="${radius}" y="${radius}" text-anchor="middle" dominant-baseline="middle" 
                font-size="${8 * sizeFactor}" font-weight="bold" fill="#82C4FF">
            ${Math.round(displacedPercent * 100)}%
          </text>
        </svg>
      `;

      return L.divIcon({
        html: svg,
        iconSize: [radius * 2, radius * 2],
        className: 'pie-chart-marker'
      });
    }

    // Create a layer group for the pie chart markers
    const pieMarkersLayer = L.layerGroup().addTo(map5);
    
    // Store references to all pie chart markers
    const pieMarkers = [];

    // Add markers with standardized pie charts
    stateData.forEach(state => {
      const [name, lat, lng, displaced, total] = state;
      
      const marker = L.marker([lat, lng], {
        icon: createPieChartIcon(displaced, total, 1.0) // Default medium size
      }).addTo(pieMarkersLayer).bindPopup(`
        <b>${name}</b><br>
        Total Population: ${total.toLocaleString()}<br>
        Displaced: ${displaced.toLocaleString()} (${((displaced/total)*100).toFixed(1)}%)<br>
        Non-Displaced: ${(total - displaced).toLocaleString()}
      `);
      
      // Store reference to marker
      pieMarkers.push({
        name: name,
        lat: lat,
        lng: lng,
        displaced: displaced,
        total: total,
        marker: marker
      });
    });

    // Function to update pie chart sizes
    function updatePieChartSizes(size) {
      const sizeFactors = {
        small: 0.7,
        medium: 1.0,
        large: 1.3
      };
      
      const factor = sizeFactors[size];
      
      // Update all pie chart markers
      pieMarkers.forEach(pieMarker => {
        pieMarker.marker.setIcon(createPieChartIcon(pieMarker.displaced, pieMarker.total, factor));
      });
    }

    // Enhanced legend control for pie chart map
    const legend5 = L.control({position: 'bottomright'});
    legend5.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>Displacement Proportion</h4>
        <div class="legend-checkbox">
          <input type="checkbox" id="displaced-checkbox" checked>
          <label for="displaced-checkbox">Displaced Population</label>
        </div>
        <div class="legend-checkbox">
          <input type="checkbox" id="remaining-checkbox" checked>
          <label for="remaining-checkbox">Remaining Population</label>
        </div>
        <div class="marker-size-controls">
          <div class="marker-size-label">Marker Size</div>
          <div class="marker-size-buttons">
            <button id="size-small">Small</button>
            <button id="size-medium" class="active">Medium</button>
            <button id="size-large">Large</button>
          </div>
          <div class="marker-size-label">Represents total state population</div>
        </div>
      `;
      
      // Add functionality to checkboxes
      const displacedCheckbox = div.querySelector('#displaced-checkbox');
      const remainingCheckbox = div.querySelector('#remaining-checkbox');
      
      displacedCheckbox.addEventListener('change', function() {
        // Toggle visibility of displaced segments (orange)
        const opacity = this.checked ? 1 : 0;
        pieMarkers.forEach(pieMarker => {
          const icon = pieMarker.marker.getIcon();
          const newHtml = icon.options.html.replace(/fill="rgba\(255, 103, 31, [\d.]+\)"/g, 
                                          `fill="rgba(255, 103, 31, ${opacity})"`);
          icon.options.html = newHtml;
          pieMarker.marker.setIcon(icon);
        });
      });
      
      remainingCheckbox.addEventListener('change', function() {
        // Toggle visibility of remaining segments (blue)
        const opacity = this.checked ? 1 : 0;
        pieMarkers.forEach(pieMarker => {
          const icon = pieMarker.marker.getIcon();
          const newHtml = icon.options.html.replace(/fill="#418FDE"/g, 
                                          `fill="rgba(65, 143, 222, ${opacity})"`);
          icon.options.html = newHtml;
          pieMarker.marker.setIcon(icon);
        });
      });
      
      // Add functionality to size buttons
      const sizeButtons = div.querySelectorAll('.marker-size-buttons button');
      sizeButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all buttons
          sizeButtons.forEach(btn => btn.classList.remove('active'));
          // Add active class to clicked button
          this.classList.add('active');
          
          // Change marker size
          const size = this.id.split('-')[1]; // small, medium, or large
          updatePieChartSizes(size);
        });
      });
      
      return div;
    };
    legend5.addTo(map5);

    // Heatmap Data (from your timeline chart)
    const months = ['Aug-2023', 'Sep-2023', 'Oct-2023', 'Nov-2023', 'Dec-2023', 
                   'Jan-2024', 'Feb-2024', 'Mar-2024', 'Apr-2024', 'May-2024', 
                   'Jun-2024', 'Jul-2024', 'Aug-2024', 'Sep-2024', 'Oct-2024', 
                   'Nov-2024', 'Dec-2024', 'Jan-2025', 'Feb-2025', 'Mar-2025'];
    
    const idpsData = [3801754, 4425083, 4856294, 5340863, 5942580, 6144363, 
                     6397698, 6622565, 6786816, 10095054, 10540215, 10710015, 
                     10834382, 10890722, 11018231, 11359005, 11532774, 11568970, 
                     11585384, 11301340];
    
    const returneesData = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 396738];

    // Prepare heatmap data
    const heatmapData = [];
    for (let i = 0; i < months.length; i++) {
      heatmapData.push({
        month: months[i],
        idps: idpsData[i],
        returnees: returneesData[i]
      });
    }

    // Create heatmap
    const heatmapElement = document.getElementById('heatmapChart');
    const heatmapSlider = document.getElementById('heatmap-slider');
    const heatmapPlayButton = document.getElementById('heatmap-play-button');
    const heatmapTimeDisplay = document.getElementById('heatmap-time-display');
    const heatmapExportButton = document.getElementById('heatmap-export-button');
    
    let heatmapChart;
    let isPlaying = false;
    let playInterval;
    const animationSpeed = 1000; // milliseconds between frames

    // Initialize heatmap
    function initHeatmap() {
      const initialData = getDataUpToIndex(0);
      
      const layout = {
        title: 'Displacement Over Time',
        xaxis: {
          title: 'Month',
          tickangle: -45,
          showgrid: true,
          gridcolor: '#f0f0f0'
        },
        yaxis: {
          title: 'Number of People',
          showgrid: true,
          gridcolor: '#f0f0f0',
          rangemode: 'tozero'
        },
        margin: {t: 50, l: 60, r: 30, b: 80},
        hovermode: 'closest',
        plot_bgcolor: 'rgba(0,0,0,0)',
        paper_bgcolor: 'rgba(0,0,0,0)',
        legend: {
          orientation: 'h',
          yanchor: 'bottom',
          y: 1.02,
          xanchor: 'right',
          x: 1
        },
        transition: {
          duration: 500,
          easing: 'cubic-in-out'
        }
      };
      
      const config = {
        responsive: true,
        displayModeBar: true
      };
      
      heatmapChart = Plotly.newPlot(
        heatmapElement, 
        [
          createTrace('IDPs', '#418FDE', initialData),
          createTrace('Returnees', '#FF671F', initialData)
        ], 
        layout, 
        config
      );
    }

    // Create a trace for the chart
    function createTrace(name, color, data) {
      return {
        x: data.map(d => d.month),
        y: data.map(d => d[name.toLowerCase()]),
        name: name,
        type: 'scatter',
        mode: 'lines+markers',
        line: {color: color, width: 3},
        marker: {size: 8, color: color},
        hoverinfo: 'y+name',
        hoverlabel: {bgcolor: color},
        fill: 'tozeroy',
        fillcolor: hexToRgba(color, 0.2)
      };
    }

    // Helper function to convert hex to rgba
    function hexToRgba(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // Get data up to a specific index
    function getDataUpToIndex(index) {
      return heatmapData.slice(0, index + 1);
    }

    // Update heatmap to show data up to a specific time index
    function updateHeatmap(timeIndex) {
      timeIndex = Math.max(0, Math.min(timeIndex, months.length - 1));
      
      // Update UI elements
      heatmapSlider.value = timeIndex;
      heatmapTimeDisplay.textContent = months[timeIndex];
      
      // Get data for this time period
      const currentData = getDataUpToIndex(timeIndex);
      
      // Update chart
      Plotly.react(
        heatmapElement,
        [
          createTrace('IDPs', '#418FDE', currentData),
          createTrace('Returnees', '#FF671F', currentData)
        ],
        heatmapChart.layout
      );
    }

    // Toggle play/pause of animation
    function togglePlayback() {
      isPlaying = !isPlaying;
      
      if (isPlaying) {
        heatmapPlayButton.textContent = '❚❚ Pause';
        
        let currentIndex = parseInt(heatmapSlider.value);
        playInterval = setInterval(() => {
          currentIndex++;
          if (currentIndex >= months.length) {
            currentIndex = months.length - 1; // Stop at the last month
            togglePlayback(); // Stop playback
            return;
          }
          updateHeatmap(currentIndex);
        }, animationSpeed);
      } else {
        heatmapPlayButton.textContent = '▶ Play';
        clearInterval(playInterval);
      }
    }

    // Export heatmap as image
    function exportHeatmap() {
      Plotly.downloadImage(heatmapElement, {
        format: 'png',
        width: 1200,
        height: 600,
        filename: 'sudan-displacement-heatmap'
      });
    }

    // Initialize heatmap when page loads
    document.addEventListener('DOMContentLoaded', () => {
      initHeatmap();
      
      // Event listeners
      heatmapSlider.addEventListener('input', () => {
        if (isPlaying) togglePlayback();
        updateHeatmap(parseInt(heatmapSlider.value));
      });
      
      heatmapPlayButton.addEventListener('click', togglePlayback);
      heatmapExportButton.addEventListener('click', exportHeatmap);
      
      // Keyboard controls
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName.toLowerCase() !== 'input') {
          const currentIndex = parseInt(heatmapSlider.value);
          
          if (e.key === 'ArrowLeft') {
            updateHeatmap(currentIndex - 1);
            if (isPlaying) togglePlayback();
          } else if (e.key === 'ArrowRight') {
            updateHeatmap(currentIndex + 1);
            if (isPlaying) togglePlayback();
          } else if (e.key === ' ') {
            togglePlayback();
            e.preventDefault();
          }
        }
      });
    });
  </script>
</body>
</html>
