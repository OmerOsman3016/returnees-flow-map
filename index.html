 <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  <title>Sudan | Displacement Tracking Matrix-Returnees Flow</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    #title {
      text-align: left;
      padding: 20px;
      background-color: #0033A0;
      color: #FFFFFF;
      font-size: 24px;
    }

    #main-container {
      display: flex;
      flex: 1;
    }

    #sidebar {
      width: 300px; /* Fixed width for the sidebar */
      background-color: #f4f4f4;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      overflow-y: auto; /* Enable scrolling if content overflows */
    }

    #map-container {
      flex: 1; /* Map container takes up remaining space */
      display: flex;
      flex-direction: column;
    }

    #map {
      flex: 1; /* Map takes up remaining space */
      height: 100%; /* Full height of the container */
    }

    footer {
      background-color: #0033A0;
      color: #FFFFFF;
      text-align: left;
      padding: 10px;
      font-size: 14px;
    }

    .legend {
      background: #fff;
      border-radius: 5px;
      padding: 8px;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div id="title">
    <h1>Sudan | Displacement Tracking Matrix - Returnees Flow</h1>
  </div>

  <div id="main-container">
    <!-- Sidebar -->
    <div id="sidebar">
      <h2>Sidebar Title</h2>
      <p>This is the sidebar content. You can add filters, descriptions, or other controls here.</p>
      <div class="legend">
        <h3>Legend</h3>
        <div style="width:17px;height:17px;background:rgba(255, 103, 31, 0.8);float:left;margin-right:10px;border-radius:30px"></div>
        <span style="float:left;margin-top:1px;font-weight:bold">State of Displacement</span><br/><br/>
        <div style="width:17px;height:17px;background:rgba(0, 51, 160, 0.8);float:left;margin-right:10px;border-radius:30px"></div>
        <span style="float:left;margin-top:1px;font-weight:bold">State of Return</span><br/><br/>
        <span style="font-size:14px">Returnee Flow Volume:</span><br/>
        <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> < 50,000</span><br/>
        <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold">50,001 - 100,000</span><br/>
        <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> > 100,000</span><br/>
      </div>
    </div>

    <!-- Map Container -->
    <div id="map-container">
      <div id="map"></div>
    </div>
  </div>

  <footer>
    <p>&copy; 2023 Your Organization Name. All rights reserved.</p>
  </footer>

  <!-- External Scripts -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

  <script>
    // Initialize the map
    const map = L.map('map').setView([16, 31], L.Browser.mobile ? 3 : 5.3);

    // Add base layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; CartoDB'
    }).addTo(map);

    // Add administrative boundaries layers
    const admn0 = L.esri.featureLayer({
      url: "https://codgis.itos.uga.edu/arcgis/rest/services/COD_External/SDN_EN/MapServer/2",
      where: "ADMLEVEL = 0",
      style: { color: "LightSteelBlue", weight: 2, dashArray: "2, 3" }
    }).addTo(map);

    const admn1 = L.esri.featureLayer({
      url: "https://codgis.itos.uga.edu/arcgis/rest/services/COD_External/SDN_EN/MapServer/2",
      where: "ADMLEVEL = 1",
      style: { color: "LightSteelBlue", weight: 1.5, dashArray: "1, 2", dashOffset: "2" }
    }).addTo(map);

    const admn2 = L.esri.featureLayer({
      url: "https://codgis.itos.uga.edu/arcgis/rest/services/COD_External/SDN_EN/MapServer/2",
      where: "ADMLEVEL = 2",
      style: { color: "LightSteelBlue", weight: 0.25 }
    }).addTo(map);

    // Store the flowmap layer globally
    let flowmapLayer;

    // Parse CSV data and create flow map layer
    Papa.parse('./data/data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        if (results.errors.length > 0) {
          console.error('Error parsing CSV:', results.errors);
          return;
        }

        const geoJsonFeatureCollection = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        flowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => ({
            radius: 6,
            weight: 1,
            color: feature.properties.isOrigin ? 'rgb(17, 142, 170)' : 'rgb(195, 255, 62)',
            fillColor: feature.properties.isOrigin ? 'rgba(0, 51, 160)' : 'rgb(255, 103, 31)',
            fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
          }),
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 50000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5 } },
              { classMinValue: 50001, classMaxValue: 100000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5 } },
              { classMinValue: 100001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3 } }
            ]
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: addTooltip
        }).addTo(map);

        // Add tooltip and popup to features
        function addTooltip(feature, layer) {
          const tooltipContent = feature.properties.isOrigin
            ? `State of Displacement: ${feature.properties.s_State}<br>Returnees: ${feature.properties.e_Volume}`
           : `State of Return: ${feature.properties.e_locality}<br>Returnees: ${feature.properties.e_Volume}`;  

          layer.bindTooltip(tooltipContent);
          layer.on('mouseover', () => layer.openTooltip());
          layer.on('mouseout', () => layer.closeTooltip());

          // Add popup
          const popupContent = feature.properties.isOrigin
            ? `<b>State of Displacement:</b> ${feature.properties.s_State}<br>
               <b>Returnees:</b> ${feature.properties.e_Volume}`
            : `<b>State of Return:</b> ${feature.properties.e_locality}<br>
               <b>Returnees:</b> ${feature.properties.e_Volume}`;

          layer.bindPopup(popupContent);
        }

        // Highlight paths on mouseover
        flowmapLayer.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      },
      error: (error) => {
        console.error('Failed to load CSV:', error);
      }
    });
  </script>
</body>

</html>
