<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Sudan Displacement to Neighboring Countries</title>
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      color: #333;
    }
    
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1, h2 {
      color: #2A6FBB;
    }
    
    #map-container {
      margin-top: 20px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    #country-movement-map {
      width: 100%;
      height: 600px;
      border-radius: 8px;
    }
    
    .mobility-text-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .mobility-text-container ul {
      padding-left: 20px;
    }
    
    .mobility-text-container li {
      margin-bottom: 8px;
    }
    
    .legend {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 250px;
    }
    
    .legend h4 {
      margin: 0 0 10px;
      color: #2A6FBB;
      font-size: 15px;
      font-weight: 600;
    }
    
    @media (max-width: 768px) {
      #country-movement-map {
        height: 400px;
      }
      
      .main-container {
        padding: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="main-container">
    <h1>Sudan Displacement Crisis</h1>
    <h2>Movement to Neighboring Countries</h2>
    
    <div id="map-container">
      <div class="mobility-text-container">
        <p>
          This map visualizes the movement patterns of displaced populations from Sudan to neighboring countries. 
          The animated flow lines represent the pathways taken by refugees, with their thickness indicating 
          the relative volume of movement between Sudan and each destination country.
        </p>
        <p>
          <strong>Key observations:</strong>
          <ul>
            <li><strong>Egypt</strong> receives the largest flow (1.5 million), primarily from northern and eastern Sudan</li>
            <li><strong>Chad</strong> shows heavy movement (767,365) from Darfur region</li>
            <li><strong>South Sudan</strong> receives significant flows (341,909) despite its own challenges</li>
            <li>Smaller but important movements to Ethiopia, Libya, and Central African Republic</li>
          </ul>
        </p>
        <p>
          <strong>How to use this map:</strong>
          <ul>
            <li>Click on any flow line to see details about that movement pathway</li>
            <li>Hover over origin or destination points to see total numbers</li>
            <li>Line thickness represents relative volume - thicker lines indicate larger numbers</li>
            <li>Animation direction shows the direction of movement</li>
          </ul>
        </p>
      </div>
      
      <div id="country-movement-map"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  
  <!-- Canvas Flowmap Layer JS -->
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet-canvas-flowmap-layer@1.0.0/dist/CanvasFlowmapLayer.min.js"></script>
  
  <script>
    // Initialize the map
    const countryMovementMap = L.map('country-movement-map').setView([16, 30], 5);

    // Add base map layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(countryMovementMap);

    // Movement data from Sudan to neighboring countries
    const movementData = [
      {
        origin: { name: "Sudan", lat: 16, lon: 30 },
        destination: { name: "Egypt", lat: 26.8206, lon: 30.8025 },
        volume: 1500000,
        color: '#e34a33'
      },
      {
        origin: { name: "Sudan", lat: 16, lon: 30 },
        destination: { name: "Chad", lat: 15.4542, lon: 18.7322 },
        volume: 767365,
        color: '#e34a33'
      },
      {
        origin: { name: "Sudan", lat: 16, lon: 30 },
        destination: { name: "South Sudan", lat: 6.877, lon: 31.307 },
        volume: 341909,
        color: '#e34a33'
      },
      {
        origin: { name: "Sudan", lat: 16, lon: 30 },
        destination: { name: "Ethiopia", lat: 9.145, lon: 40.4897 },
        volume: 88001,
        color: '#ff671f'
      },
      {
        origin: { name: "Sudan", lat: 16, lon: 30 },
        destination: { name: "Libya", lat: 26.3351, lon: 17.2283 },
        volume: 105721,
        color: '#ff671f'
      },
      {
        origin: { name: "Sudan", lat: 16, lon: 30 },
        destination: { name: "Central African Republic", lat: 6.6111, lon: 20.9394 },
        volume: 35376,
        color: '#ffb81c'
      },
      {
        origin: { name: "Sudan", lat: 16, lon: 30 },
        destination: { name: "Eritrea", lat: 15.1794, lon: 39.7823 },
        volume: 14141,
        color: '#ffb81c'
      }
    ];

    // Create a feature collection for the flow map layer
    const movementFeatureCollection = {
      type: 'FeatureCollection',
      features: movementData.map((movement, index) => ({
        type: 'Feature',
        geometry: { type: 'Point', coordinates: [movement.origin.lon, movement.origin.lat] },
        properties: {
          ...movement,
          isOrigin: true,
          s_state_id: 'SD00',
          e_locality_id: `CNTRY${index}`,
          e_Volume: movement.volume
        }
      }))
    };

    // Create flow map layer
    const movementFlowLayer = L.canvasFlowmapLayer(movementFeatureCollection, {
      originAndDestinationFieldIds: {
        originUniqueIdField: 's_state_id',
        originGeometry: { x: 'origin.lon', y: 'origin.lat' },
        destinationUniqueIdField: 'e_locality_id',
        destinationGeometry: { x: 'destination.lon', y: 'destination.lat' }
      },
      style: (feature) => {
        const baseRadius = 6;
        const maxRadius = 20;
        const volume = feature.properties.volume || 0;

        const radius = feature.properties.isOrigin
          ? baseRadius
          : Math.min(baseRadius + (volume / 50000), maxRadius);

        return {
          radius: radius,
          weight: 1,
          color: feature.properties.isOrigin ? '#FFFFFF' : '#FFFFFF',
          fillColor: feature.properties.isOrigin ? '#418FDE' : 'rgb(255, 103, 31)',
          fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
        };
      },
      canvasBezierStyle: {
        type: 'classBreaks',
        field: 'e_Volume',
        classBreakInfos: [
          { classMinValue: 1, classMaxValue: 50000, symbol: { strokeStyle: '#ffb81c', lineWidth: 1.5, lineCap: 'round' } },
          { classMinValue: 50001, classMaxValue: 200000, symbol: { strokeStyle: '#ff671f', lineWidth: 3, lineCap: 'round' } },
          { classMinValue: 200001, classMaxValue: 2000000, symbol: { strokeStyle: '#e34a33', lineWidth: 5, lineCap: 'round' } }
        ],
        defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round' }
      },
      pathDisplayMode: 'all',
      animationStarted: true,
      animationEasingFamily: 'Linear',
      animationEasingType: 'None',
      animationDuration: 3000,
      onEachFeature: (feature, layer) => {
        const tooltipContent = feature.properties.isOrigin
          ? `Origin: ${feature.properties.origin.name}`
          : `Destination: ${feature.properties.destination.name}`;

        layer.bindTooltip(tooltipContent);
        layer.on('mouseover', () => layer.openTooltip());
        layer.on('mouseout', () => layer.closeTooltip());

        // Add popup
        const popupContent = feature.properties.isOrigin
          ? `<b>Origin:</b> ${feature.properties.origin.name}`
          : `<b>Destination:</b> ${feature.properties.destination.name}<br>
             <b>Displaced Persons:</b> ${feature.properties.volume.toLocaleString()}`;

        layer.bindPopup(popupContent);
      }
    }).addTo(countryMovementMap);

    // Add country markers with population numbers
    movementData.forEach(movement => {
      // Calculate marker size based on volume
      const maxVolume = Math.max(...movementData.map(m => m.volume));
      const baseRadius = 8 + (movement.volume / maxVolume) * 25;
      
      // Create destination marker
      L.circleMarker([movement.destination.lat, movement.destination.lon], {
        radius: baseRadius,
        fillColor: 'rgba(255, 103, 31, 0.8)',
        color: '#fff',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.7
      }).addTo(countryMovementMap)
        .bindPopup(`
          <b>${movement.destination.name}</b><br>
          <b>Displaced Persons:</b> ${movement.volume.toLocaleString()}
        `)
        .bindTooltip(`
          <b>${movement.destination.name}</b><br>
          ${movement.volume.toLocaleString()} arrivals
        `);
    });

    // Add Sudan marker
    L.circleMarker([16, 30], {
      radius: 15,
      fillColor: '#418FDE',
      color: '#fff',
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    }).addTo(countryMovementMap)
      .bindPopup('<b>Sudan</b><br>Origin of displacement')
      .bindTooltip('<b>Sudan</b>');

    // Add legend
    const movementLegend = L.control({ position: 'bottomright' });
    movementLegend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>Movement Volume</h4>
        <div style="margin-top: 10px;">
          <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <div style="width: 20px; height: 3px; background: #e34a33; margin-right: 10px;"></div>
            <span>Large flows (>200,000)</span>
          </div>
          <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <div style="width: 20px; height: 2px; background: #ff671f; margin-right: 10px;"></div>
            <span>Medium flows (50,000-200,000)</span>
          </div>
          <div style="display: flex; align-items: center;">
            <div style="width: 20px; height: 1px; background: #ffb81c; margin-right: 10px;"></div>
            <span>Small flows (<50,000)</span>
          </div>
        </div>
        <div style="margin-top: 15px; font-size: 12px; color: #666;">
          <div style="display: flex; align-items: center; margin-bottom: 5px;">
            <div style="width: 15px; height: 15px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
            <span>Sudan (origin)</span>
          </div>
          <div style="display: flex; align-items: center;">
            <div style="width: 15px; height: 15px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
            <span>Destination countries</span>
          </div>
        </div>
      `;
      return div;
    };
    movementLegend.addTo(countryMovementMap);

    // Animation for markers (optional pulsing effect)
    function animateMarkers() {
      const markers = document.querySelectorAll('.leaflet-marker-icon');
      markers.forEach(marker => {
        marker.style.transition = 'transform 0.5s ease-in-out';
        setInterval(() => {
          marker.style.transform = marker.style.transform === 'scale(1.1)' ? 'scale(1)' : 'scale(1.1)';
        }, 1000);
      });
    }

    // Run after map is loaded
    countryMovementMap.whenReady(animateMarkers);
  </script>
</body>
</html>
