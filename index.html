 <!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="Flow Map" />
  <title>Displacement Flow Map</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
    }

    .legend {
      background: #fff;
      border-radius: 5px;
      padding: 10px;
      font-size: 14px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .legend div {
      margin-bottom: 8px;
    }

    .legend span {
      margin-left: 10px;
    }

    .legend .circle {
      width: 17px;
      height: 17px;
      border-radius: 50%;
      display: inline-block;
    }

  </style>
</head>

<body>

  <div id="map"></div>

  <!-- LeafletJS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- Esri Leaflet -->
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <!-- Tweening for animation -->
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <!-- CanvasFlowMapLayer -->
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <!-- CSV Parsing -->
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

  <script>
    const map = L.map('map');

    // Adjusting map view based on device type
    map.setView(L.Browser.mobile ? [16, 32] : [16, 31], L.Browser.mobile ? 3 : 6);

    // Adding basemap
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; CartoDB'
    }).addTo(map);

    // Adding admin boundary layers (Level 0)
    const admn0 = L.esri.featureLayer({
      url: "https://codgis.itos.uga.edu/arcgis/rest/services/COD_External/SDN_EN/MapServer/2",
      where: "ADMLEVEL = 0",
      style: { color: "gray", weight: 2, dashArray: "2, 3" }
    }).addTo(map);

    // Parsing CSV and creating GeoJSON features
    Papa.parse('./data/data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: function (results) {
        const geoJsonFeatureCollection = {
          type: 'FeatureCollection',
          features: results.data.map(function (datum) {
            return {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [datum.s_lon, datum.s_lat]
              },
              properties: datum
            }
          })
        };

        const flowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: function (geoJsonFeature) {
            return geoJsonFeature.properties.isOrigin ? {
              radius: 6,
              weight: 1,
              color: 'rgb(17, 142, 170)',
              fillColor: 'rgba(0, 51, 160)',
              fillOpacity: 0.8
            } : {
              radius: 6,
              weight: 1,
              color: 'rgb(195, 255, 62)',
              fillColor: 'rgb(255, 103, 31)',
              fillOpacity: 0.7
            };
          },
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [{
                classMinValue: 0,
                classMaxValue: 80000,
                symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2 }
              },
              {
                classMinValue: 80001,
                classMaxValue: 160000,
                symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2 }
              },
              {
                classMinValue: 160001,
                classMaxValue: 10000000,
                symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2 }
              }
            ],
            defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 },
          },
          pathDisplayMode: 'continuous',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 2000,
          onEachFeature: TooltipName,
        }).addTo(map);

        // Tooltip function for showing details on hover
        function TooltipName(feature, layer) {
          layer.on('mouseover', function () {
            this.openPopup();
          });
          layer.on('mouseout', function () {
            this.closePopup();
          });

          const tooltipText = layer._radius === 6 ? `State of Origin: ${feature.properties.s_State}` : `Locality of Displacement: ${feature.properties.e_locality}`;
          layer.bindTooltip(tooltipText);
        }

        // Initial flow path selection on map
        flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', "SD02", true, 'SELECTION_NEW');
      }
    });

    // Adding a Legend to the map
    const legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function () {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <div><span class="circle" style="background:rgba(255, 103, 31, 0.8)"></span><span>State of Displacement</span></div>
        <div><span class="circle" style="background:rgba(0, 51, 160, 0.8)"></span><span>State of Return</span></div>
        <div>Displacement Flow:</div>
        <div><div style="width: 70px; height: 3px; background: #ffb81c;"></div><span>< 80,000</span></div>
        <div><div style="width: 70px; height: 4px; background: #ff671f;"></div><span>80,001 - 160,000</span></div>
        <div><div style="width: 70px; height: 7px; background: #e34a33;"></div><span>> 160,000</span></div>
      `;
      return div;
    };
    legend.addTo(map);

  </script>
</body>

</html>
