 <!DOCTYPE html>
  <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="description" content="Flow Map" />

<style>
  /* Apply space around the page */
  body {
    margin: 20px; /* Adds space around the entire body */
    padding: 0;
    font-family: Arial, sans-serif;
  }

  /* Title Styling */
  #title {
    text-align: center;
    padding: 20px;
    background-color: #f0f0f0;
    margin-bottom: 20px; /* Adds space below the title */
  }

  #title h1 {
    margin: 0;
    font-size: 24px;
    color: #2a9d8f;
  }

  /* Map Container Styling */
  #map {
    height: calc(100vh - 120px); /* Adjusts the height to leave space for the title and margin */
  }

  /* Card Styling */
  #displacementCard {
    position: absolute;
    bottom: 50px;
    right: 20px;
    background: #fff;
    border: 1px solid #ccc;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    z-index: 1000;
  }
  <style>
    /* Apply space around the page */
    body {
      margin: 20px;
      padding: 0;
      font-family: Arial, sans-serif;
    }

  /* Add some spacing to the map for better layout */
  #map {
    margin-top: 60px; /* Adds space between the map and the title */
  }
</style>
    /* Title Styling */
    #title {
      text-align: center;
      padding: 20px;
      background-color: #f0f0f0;
      margin-bottom: 20px;
    }

    #title h1 {
      margin: 0;
      font-size: 24px;
      color: #2a9d8f;
    }

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    /* Map Container Styling */
    #map {
      height: calc(100vh - 120px);
    }

  <style>
    body {
      margin: 0;
      padding: 0;
    /* Card Styling */
    #displacementCard {
      position: absolute;
      bottom: 50px;
      right: 20px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    /* Ensure full-page map */
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
    }

    .legend {
	background: #fff;
	border-radius: 5px;
	padding: 8px;
	}

  </style>

  <!-- Load Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>

<body>
	 
 <div id="map"></div>
  <!-- Map container -->
  <div id="map"></div>

  <!-- first load LeafletJS -->
  <!-- Load LeafletJS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

  <!-- load Esri Leaflet because we want to use an Esri basemap -->
  <!-- Load Esri Leaflet for Esri basemap -->
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>

  <!-- load animation tweening lib requirement for CanvasFlowMapLayer -->
  <!-- Load Tween.js for animation -->
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>

  <!-- then load CanvasFlowMapLayer -->
  <!-- Load CanvasFlowMapLayer for flow visualization -->
  <script src="./src/CanvasFlowmapLayer.js"></script>

  <!-- also load 3rd-party CSV parsing libary just for this demo  -->
  <!-- Load PapaParse for CSV data parsing -->
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  

  <script>
    // Initialize the map
    var map = L.map('map');

    // Set map view based on device type
    if (L.Browser.mobile) {
      map.setView([16, 32], 3);
    } else {
      map.setView([16, 31], 6);
    }

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; CartoDB'
}).addTo(map);


	  
   var admn0 = L.esri.featureLayer({
  url: "https://codgis.itos.uga.edu/arcgis/rest/services/COD_External/SDN_EN/MapServer/2",
  where: "ADMLEVEL = 0",
  style: { color: "gray", weight: 2, dashArray: "2, 3" } // Dashed black border
});
admn0.addTo(map);

    /*
    var admn1 = L.esri
        .featureLayer({
          url: "https://codgis.itos.uga.edu/arcgis/rest/services/COD_External/SDN_EN/MapServer/2",
          where: "ADMLEVEL = 1",
          style: { color: "gray", weight: 1.5,  dashArray: "1, 2", dashOffset: "2" }
        });

        admn1.addTo(map);
	  
    // Add base map layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; CartoDB'
    }).addTo(map);

    var admn2 = L.esri
        .featureLayer({
          url: "https://codgis.itos.uga.edu/arcgis/rest/services/COD_External/SDN_EN/MapServer/2",
          where: "ADMLEVEL = 2",
          //style: { color: "gray", weight: 1,  dashArray: "2, 3", dashOffset: "2" }
          style: { color: "gray", weight: 0.25 }
        });

        admn2.addTo(map);
    
   */
    // Add administrative boundary layer (country borders)
    var admn0 = L.esri.featureLayer({
      url: "https://codgis.itos.uga.edu/arcgis/rest/services/COD_External/SDN_EN/MapServer/2",
      where: "ADMLEVEL = 0",
      style: { color: "gray", weight: 2, dashArray: "2, 3" }
    });
    admn0.addTo(map);

    // Parse CSV data containing displacement flow information
    Papa.parse('./data/data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: function(results) {
        // Convert CSV data into GeoJSON format
        var geoJsonFeatureCollection = {
          type: 'FeatureCollection',
          features: results.data.map(function(datum) {
@@ -163,147 +121,55 @@
          })
        };

        // Create flow map layer
        var oneToManyFlowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: {
              x: 's_lon',
              y: 's_lat'
            },
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: {
              x: 'e_lon',
              y: 'e_lat'
            }
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: function(geoJsonFeature) {
            if (geoJsonFeature.properties.isOrigin) {
              return {
                radius: 6,
                weight: 1,
                color: 'rgb(17, 142, 170)',
                fillColor: 'rgba(0, 51, 160)',
                fillOpacity: 0.8
              };
              return { radius: 6, weight: 1, color: 'rgb(17, 142, 170)', fillColor: 'rgba(0, 51, 160)', fillOpacity: 0.8 };
            } else {
              return {
                radius: 6,
                weight: 1,
                color: 'rgb(195, 255, 62)',
                fillColor: 'rgb(255, 103, 31)',
                fillOpacity: 0.7
              };
              return { radius: 6, weight: 1, color: 'rgb(195, 255, 62)', fillColor: 'rgb(255, 103, 31)', fillOpacity: 0.7 };
            }
          },
          // Define path styles based on flow volume
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [{
              classMinValue: 0,
              classMaxValue: 80000,
              symbol: {
                strokeStyle: '#ffb81c',
                lineWidth: 0.5,
                lineCap: 'round',
                shadowColor: '#fee8c8',
                shadowBlur: 2.0
              }
            }, {
              classMinValue: 80001,
              classMaxValue: 160000,
              symbol: {
                strokeStyle: '#ff671f',
                lineWidth: 1.5,
                lineCap: 'round',
                shadowColor: '#fdbb84',
                shadowBlur: 2.0
              }
            }, {
              classMinValue: 160001,
              classMaxValue: 10000000,
              symbol: {
                strokeStyle: '#d22630',
                lineWidth: 3,
                lineCap: 'round',
                shadowColor: '#e34a33',
                shadowBlur: 2.0
              }
            }],
            defaultSymbol: {
              strokeStyle: '#e7e1ef',
              lineWidth: 0.5,
              lineCap: 'round',
              shadowColor: '#e7e1ef',
              shadowBlur: 1.5
            },
            classBreakInfos: [
              { classMinValue: 0, classMaxValue: 80000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5 } },
              { classMinValue: 80001, classMaxValue: 160000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5 } },
              { classMinValue: 160001, classMaxValue: 10000000, symbol: { strokeStyle: '#d22630', lineWidth: 3 } }
            ]
          },
          pathDisplayMode: 'continuous',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 2000,
          onEachFeature: TooltipName,
        }).addTo(map);
                
        //create tooltip function on hover
        function TooltipName(feature, layer){
        layer.on('mouseover', function (e) {
        this.openPopup();
        });
        layer.on('mouseout', function (e) {
        this.closePopup();
        });
        if (layer._radius===6){
          layer.bindTooltip("State of Displacement: "+feature.properties.s_State );
        }else {
          layer.bindTooltip("State of Return: "+feature.properties.e_locality);

        // Function to show tooltips on hover
        function TooltipName(feature, layer) {
          layer.on('mouseover', function () { this.openPopup(); });
          layer.on('mouseout', function () { this.closePopup(); });
          layer.bindTooltip(feature.properties.isOrigin ? "State of Displacement: " + feature.properties.s_State : "State of Return: " + feature.properties.e_locality);
        }
       
        };
        

        // since this demo is using the optional "pathDisplayMode" as "selection",
        // it is up to the developer to wire up a click or mouseover listener
        // and then call the "selectFeaturesForPathDisplay()" method to inform the layer
        // which Bezier paths need to be drawn
        oneToManyFlowmapLayer.on('mouseover', function(e) {
          if (e.sharedOriginFeatures.length) {
            oneToManyFlowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            oneToManyFlowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // immediately select an origin point for Bezier path display,
        // instead of waiting for the first user click event to fire
 
 
        oneToManyFlowmapLayer.selectFeaturesForPathDisplayById('s_state_id', "SD02", true, 'SELECTION_NEW');
      }
    });
 
    	//Adding Legend to the map
	var legend = L.control({position: 'bottomleft'});
	legend.onAdd = function (map) {
    var legend = L.DomUtil.create('div', 'legend');
	legend.innerHTML = 
  '<div style="width:17px;height:17px;background:rgba(255, 103, 31, 0.8) ;float:left;margin-right:10px;border-radius:30px"></div>'+ '<span style="float:left;margin-top:1px; font-weight:bold"> State of Displacement </span>'+'<br/>'+'<br/>'+
  '<div style="width:17px;height:17px;background:rgba(0, 51, 160, 0.8) ;float:left;margin-right:10px;border-radius:30px"></div>'+ '<span style="float:left;margin-top:1px; font-weight:bold"> State of Return  </span>'+'<br/>'+'<br/>'+
  '<span style="font-size: 14px">Displacement flow:</span>'+'<br/>'+
	'<div style="width:70px;height:3px;background:#ffb81c ;float:left;margin-right:10px;margin-top:10px"></div><span style="float:left; font-weight:bold"> < 80,000</span>'+'<br/>'+
	'<div style="width:70px;height:4px;background:#ff671f ;float:left;margin-right:10px;;margin-top:10px"></div><span style="float:left; font-weight:bold">80,001 - 160,000</span>'+'<br/>'+
	'<div style="width:70px;height:7px;background:#e34a33 ;float:left;margin-right:10px;;margin-top:10px"></div><span style="float:left; font-weight:bold"> > 160,000</span>'+'<br/>'
    return legend;
	};
	legend.addTo(map);

    // Add legend to the map
    var legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<span>Legend:</span><br>';
      return div;
    };
    legend.addTo(map);
  </script>

</body>

</html>
</body>

</html>
