<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        #map-container {
            flex: 1;
            height: 100vh;
        }
        
        .info-panel {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            font-size: 14px;
            line-height: 1.4;
        }
        
        .info-panel h4 {
            margin: 0 0 5px;
            color: #08306B;
        }
        
        .info-panel b {
            font-weight: 600;
        }
        
        .color-key {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-left: 5px;
            vertical-align: middle;
            border: 1px solid #ddd;
        }
        
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            line-height: 1.5;
        }
        
        .legend h4 {
            margin: 0 0 5px;
            color: #08306B;
        }
        
        .legend i {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 25px;
            width: 70%;
            max-width: 800px;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-close {
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .state-stats {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .stat-item {
            flex: 1;
            min-width: 120px;
            text-align: center;
            margin: 10px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2171B5;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .state-details h3 {
            color: #08306B;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        
        .state-details ul {
            padding-left: 20px;
        }
        
        .state-details li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            #map-container {
                order: 2;
                height: 60vh;
            }
            
            .modal-content {
                width: 90%;
                margin: 10% auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="map-container"></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Embedded IDP data
        const idpData = {
            "SD01": {
                stateName: "North Darfur",
                idps: 1750000,
                population: 3200000,
                localities: 18,
                locations: 350
            },
            "SD02": {
                stateName: "South Darfur",
                idps: 1200000,
                population: 5800000,
                localities: 22,
                locations: 420
            },
            "SD03": {
                stateName: "Central Darfur",
                idps: 850000,
                population: 2100000,
                localities: 15,
                locations: 280
            },
            "SD04": {
                stateName: "Khartoum",
                idps: 2300000,
                population: 8500000,
                localities: 7,
                locations: 150
            },
            "SD05": {
                stateName: "White Nile",
                idps: 650000,
                population: 3000000,
                localities: 12,
                locations: 180
            },
            "SD06": {
                stateName: "North Kordofan",
                idps: 420000,
                population: 3200000,
                localities: 10,
                locations: 160
            },
            "SD07": {
                stateName: "South Kordofan",
                idps: 380000,
                population: 2800000,
                localities: 8,
                locations: 140
            },
            "SD08": {
                stateName: "West Darfur",
                idps: 720000,
                population: 2500000,
                localities: 14,
                locations: 210
            },
            "SD09": {
                stateName: "East Darfur",
                idps: 290000,
                population: 1800000,
                localities: 9,
                locations: 120
            },
            "SD10": {
                stateName: "Blue Nile",
                idps: 180000,
                population: 1200000,
                localities: 6,
                locations: 90
            },
            "SD11": {
                stateName: "Gedaref",
                idps: 95000,
                population: 2300000,
                localities: 5,
                locations: 70
            },
            "SD12": {
                stateName: "Kassala",
                idps: 120000,
                population: 2100000,
                localities: 6,
                locations: 80
            },
            "SD13": {
                stateName: "Red Sea",
                idps: 85000,
                population: 1800000,
                localities: 4,
                locations: 60
            },
            "SD14": {
                stateName: "River Nile",
                idps: 65000,
                population: 1500000,
                localities: 3,
                locations: 50
            },
            "SD15": {
                stateName: "Sennar",
                idps: 110000,
                population: 2200000,
                localities: 5,
                locations: 75
            }
        };

        // Add percentage displaced to each state
        for (const stateCode in idpData) {
            idpData[stateCode].percentageDisplaced = 
                ((idpData[stateCode].idps / idpData[stateCode].population) * 100).toFixed(2);
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeIDPMap(idpData);
        });

        /**
         * Initialize the main IDP map showing total IDPs by state
         */
        function initializeIDPMap(idpData) {
            // Create the map instance
            const idpMap = L.map('map-container', {
                center: [15.5, 30.5], // Centered on Sudan
                zoom: 5.5,
                minZoom: 5,
                maxZoom: 10,
                zoomControl: false,
                attributionControl: true
            });

            // Add controls
            L.control.zoom({ position: 'topright' }).addTo(idpMap);
            L.control.scale({ position: 'bottomright', imperial: false }).addTo(idpMap);

            // Add base maps
            const lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(idpMap);

            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            // Layer control
            L.control.layers({
                "Light": lightLayer,
                "Satellite": satelliteLayer
            }, null, { position: 'topright', collapsed: true }).addTo(idpMap);

            // Color scale for IDP visualization
            function getColor(d) {
                return d > 1500000 ? '#08306B' :
                       d > 1000000 ? '#2171B5' :
                       d > 500000  ? '#6BAED6' :
                       d > 250000  ? '#BDD7E7' :
                                     '#EFF3FF';
            }

            // Style for state boundaries
            function style(feature) {
                const stateCode = feature.properties.admin1Code;
                const idpCount = idpData[stateCode]?.idps || 0;
                
                return {
                    weight: 1.5,
                    opacity: 1,
                    color: '#FFFFFF',
                    dashArray: '',
                    fillOpacity: 0.7,
                    fillColor: getColor(idpCount)
                };
            }

            // Highlight feature on hover
            function highlightFeature(e) {
                const layer = e.target;
                layer.setStyle({
                    weight: 3,
                    color: '#666',
                    dashArray: '',
                    fillOpacity: 0.9
                });
                layer.bringToFront();
                updateInfoPanel(layer.feature);
            }

            // Reset highlight
            function resetHighlight(e) {
                geojsonLayer.resetStyle(e.target);
                infoPanel.update();
            }

            // Zoom to feature on click
            function zoomToFeature(e) {
                idpMap.fitBounds(e.target.getBounds());
                showStateDetails(e.target.feature);
            }

            // Add interactions to each feature
            function onEachFeature(feature, layer) {
                layer.on({
                    mouseover: highlightFeature,
                    mouseout: resetHighlight,
                    click: zoomToFeature
                });
            }

            // Create info panel
            const infoPanel = L.control({position: 'topleft'});
            infoPanel.onAdd = function(map) {
                this._div = L.DomUtil.create('div', 'info-panel');
                this.update();
                return this._div;
            };
            infoPanel.update = function(feature) {
                const stateCode = feature ? feature.properties.admin1Code : null;
                const stateData = stateCode ? idpData[stateCode] : null;
                const stateName = feature ? feature.properties.admin1Name : '';
                
                this._div.innerHTML = '<h4>Sudan IDP Distribution</h4>' +
                    (feature ?
                        `<b>${stateName}</b><br />` +
                        (stateData?.idps ? stateData.idps.toLocaleString() + ' IDPs' : 'Data not available') +
                        `<div class="color-key" style="background: ${getColor(stateData?.idps || 0)};"></div>`
                        : 'Hover over a state');
            };
            infoPanel.addTo(idpMap);

            // Update info panel
            function updateInfoPanel(feature) {
                infoPanel.update(feature);
            }

            // Show detailed state information
            function showStateDetails(feature) {
                const stateCode = feature.properties.admin1Code;
                const stateData = idpData[stateCode] || {};
                const stateName = feature.properties.admin1Name;
                const idpCount = stateData.idps || 0;
                const percentageDisplaced = stateData.percentageDisplaced || 0;
                
                // Create or update modal
                let modal = document.getElementById('state-details-modal');
                
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'state-details-modal';
                    modal.className = 'modal';
                    document.body.appendChild(modal);
                    
                    const closeBtn = document.createElement('span');
                    closeBtn.className = 'modal-close';
                    closeBtn.innerHTML = '&times;';
                    closeBtn.onclick = function() {
                        modal.style.display = 'none';
                    };
                    modal.appendChild(closeBtn);
                    
                    const content = document.createElement('div');
                    content.className = 'modal-content';
                    modal.appendChild(content);
                }
                
                const content = modal.querySelector('.modal-content');
                
                // Create modal content with all data fields
                content.innerHTML = `
                    <h2>${stateName} (${stateCode})</h2>
                    <div class="state-stats">
                        <div class="stat-item">
                            <div class="stat-value">${idpCount.toLocaleString()}</div>
                            <div class="stat-label">Internally Displaced Persons</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stateData.localities?.toLocaleString() || 'N/A'}</div>
                            <div class="stat-label">Number of Localities</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stateData.locations?.toLocaleString() || 'N/A'}</div>
                            <div class="stat-label">Number of Locations</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${stateData.population?.toLocaleString() || 'N/A'}</div>
                            <div class="stat-label">Total Population</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">${percentageDisplaced}%</div>
                            <div class="stat-label">Percentage Displaced</div>
                        </div>
                    </div>
                    <div class="state-details">
                        <h3>Displacement Context</h3>
                        <p>${getStateDescription(stateName, stateData)}</p>
                        <h3>Key Challenges</h3>
                        <ul>
                            ${getStateChallenges(stateName, stateData).map(challenge => `<li>${challenge}</li>`).join('')}
                        </ul>
                    </div>
                `;
                
                // Show the modal
                modal.style.display = 'block';
            }

            function getStateDescription(stateName, stateData) {
                const descriptions = {
                    "North Darfur": `North Darfur has experienced significant displacement with ${stateData.idps?.toLocaleString() || 'many'} IDPs, representing about ${stateData.percentageDisplaced || 'a significant portion'}% of the population. The region continues to face challenges due to ongoing conflict and intercommunal violence.`,
                    "South Darfur": `South Darfur has one of the highest displacement figures in Sudan with ${stateData.idps?.toLocaleString() || 'many'} IDPs (${stateData.percentageDisplaced || 'a significant portion'}% of the population). Displacement is driven by both conflict and environmental factors.`,
                    "Central Darfur": `Central Darfur hosts ${stateData.idps?.toLocaleString() || 'many'} IDPs across ${stateData.locations || 'numerous'} locations. The displacement situation is characterized by periodic flare-ups of violence and limited humanitarian access.`,
                    "Khartoum": `Despite being the capital, Khartoum has seen displacement of ${stateData.idps?.toLocaleString() || 'many'} people due to urban conflict and economic factors. This represents ${stateData.percentageDisplaced || 'a portion'}% of the capital's population.`,
                    "White Nile": `White Nile hosts ${stateData.idps?.toLocaleString() || 'many'} IDPs across ${stateData.locations || 'numerous'} locations, as well as refugees from neighboring countries. The state faces challenges in providing services to both displaced and host communities.`
                };
                
                if (!descriptions[stateName] && stateData) {
                    return `${stateName} currently hosts ${stateData.idps?.toLocaleString() || 'an undetermined number of'} internally displaced persons across ${stateData.locations || 'various'} locations. This represents approximately ${stateData.percentageDisplaced || 'a portion'}% of the state's total population. Displacement in this area has been affected by various factors including conflict, economic conditions, and access to resources.`;
                }
                
                return descriptions[stateName] || `The displacement situation in ${stateName} has been affected by various factors including conflict, economic conditions, and access to resources.`;
            }

            function getStateChallenges(stateName, stateData) {
                const challenges = {
                    "North Darfur": [
                        "Ongoing conflict and insecurity limiting humanitarian access",
                        `High concentration of IDPs (${stateData.percentageDisplaced}% of population)`,
                        `Limited resources across ${stateData.localities} localities`,
                        "Environmental degradation affecting livelihoods"
                    ],
                    "South Darfur": [
                        "Protection concerns for vulnerable populations",
                        `Managing displacement across ${stateData.locations} locations`,
                        "Food insecurity and malnutrition",
                        "Water scarcity and sanitation challenges"
                    ],
                    "Khartoum": [
                        "Urban displacement challenges in densely populated areas",
                        "High cost of living affecting displaced populations",
                        "Limited shelter options",
                        "Strained urban services and infrastructure"
                    ]
                };
                
                if (!challenges[stateName] && stateData) {
                    const generatedChallenges = [
                        `Managing displacement across ${stateData.locations || 'multiple'} locations`,
                        `Coordinating response across ${stateData.localities || 'several'} localities`,
                        "Access to clean water and sanitation",
                        "Food security concerns",
                        "Limited healthcare facilities"
                    ];
                    
                    if (stateData.percentageDisplaced > 20) {
                        generatedChallenges.unshift(`High displacement ratio (${stateData.percentageDisplaced}% of population)`);
                    }
                    
                    return generatedChallenges;
                }
                
                return challenges[stateName] || [
                    "Access to clean water and sanitation",
                    "Food security concerns",
                    "Limited healthcare facilities",
                    "Protection issues for vulnerable populations"
                ];
            }

            // Sample GeoJSON data for Sudan states (simplified)
            const sudanGeoJSON = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD01",
                            "admin1Name": "North Darfur"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[25,16], [25,17], [26,17], [26,16], [25,16]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD02",
                            "admin1Name": "South Darfur"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[24,11], [24,12], [25,12], [25,11], [24,11]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD03",
                            "admin1Name": "Central Darfur"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[23,12], [23,13], [24,13], [24,12], [23,12]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD04",
                            "admin1Name": "Khartoum"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[32,15], [32,16], [33,16], [33,15], [32,15]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD05",
                            "admin1Name": "White Nile"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[31,13], [31,14], [32,14], [32,13], [31,13]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD06",
                            "admin1Name": "North Kordofan"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[28,12], [28,13], [29,13], [29,12], [28,12]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD07",
                            "admin1Name": "South Kordofan"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[29,10], [29,11], [30,11], [30,10], [29,10]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD08",
                            "admin1Name": "West Darfur"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[22,12], [22,13], [23,13], [23,12], [22,12]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD09",
                            "admin1Name": "East Darfur"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[26,10], [26,11], [27,11], [27,10], [26,10]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD10",
                            "admin1Name": "Blue Nile"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[34,10], [34,11], [35,11], [35,10], [34,10]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD11",
                            "admin1Name": "Gedaref"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[35,13], [35,14], [36,14], [36,13], [35,13]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD12",
                            "admin1Name": "Kassala"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[36,15], [36,16], [37,16], [37,15], [36,15]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD13",
                            "admin1Name": "Red Sea"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[36,18], [36,19], [37,19], [37,18], [36,18]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD14",
                            "admin1Name": "River Nile"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[33,17], [33,18], [34,18], [34,17], [33,17]]]
                        }
                    },
                    {
                        "type": "Feature",
                        "properties": {
                            "admin1Code": "SD15",
                            "admin1Name": "Sennar"
                        },
                        "geometry": {
                            "type": "Polygon",
                            "coordinates": [[[33,12], [33,13], [34,13], [34,12], [33,12]]]
                        }
                    }
                ]
            };

            // Create GeoJSON layer with the sample data
            const geojsonLayer = L.geoJson(sudanGeoJSON, {
                style: style,
                onEachFeature: onEachFeature
            }).addTo(idpMap);

            // Fit bounds to the GeoJSON data
            idpMap.fitBounds(geojsonLayer.getBounds());

            // Add legend
            const legend = L.control({position: 'bottomleft'});
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'info legend');
                const grades = [0, 250000, 500000, 1000000, 1500000];
                
                div.innerHTML = '<h4>IDP Count</h4>';
                for (let i = 0; i < grades.length; i++) {
                    div.innerHTML +=
                        '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                        grades[i].toLocaleString() + (grades[i + 1] ? 'â€“' + grades[i + 1].toLocaleString() + '<br>' : '+');
                }
                return div;
            };
            legend.addTo(idpMap);
        }
    </script>
</body>
</html>
