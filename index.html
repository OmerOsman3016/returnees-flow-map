<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Meta tags for character encoding, viewport settings, and page description -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  <title>Sudan | Displacement Tracking Matrix - Returnees Flow</title>

  <!-- External CSS libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />

  <!-- Internal CSS styles -->
  <style>
    /* General body styling */
    body {
      margin: 20px;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #8099d0;
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.6;
      letter-spacing: 0.5px;
      font-size: 16px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    *, *::before, *::after {
      box-sizing: inherit;
    }

    a {
      color: #0033A0;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    a:hover {
      color: #ff671f;
    }

    /* Custom scrollbar */
    body::-webkit-scrollbar {
      width: 10px;
    }

    body::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    body::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 5px;
    }

    body::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* Link styling */
    a {
      color: white;
      text-decoration: none;
    }

    /* Title container styling */
    #title-container {
      display: flex;
      align-items: center;
      background-color: #0033A0;
      padding: 10px 20px;
      color: white;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap;
    }

    /* Image styling within the title container */
    .title-image {
      width: 170px;
      height: 90px;
      margin-right: 20px;
      border-radius: 5px;
    }

    /* Title text styling */
    #title {
      flex: 1;
      text-align: left;
    }

    /* Main title styling */
    #title h1 {
      margin: 0;
      font-size: 30px;
      font-weight: bold;
      border-bottom: 3px solid white;
      padding-bottom: 5px;
      display: inline-block;
    }

    /* Subtitle styling */
    #title h2 {
      margin: 0;
      font-size: 24px;
      font-weight: normal;
      color: #f0f0f0;
    }

    /* Content container styling */
    .content-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    /* Timeline and map container styling */
    #timeline-map-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
      min-width: 300px;
    }

    /* Timeline container styling */
    #timeline-container {
      background-color: #fff;
      border: 2px solid #0033A0;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      height: 400px;
    }

    /* Timeline heading styling */
    #timeline-container h2 {
      margin-top: 0;
      color: #0033A0;
      font-size: 20px;
      margin-bottom: 15px;
      font-weight: bold;
      text-align: center;
      border-bottom: 2px solid #0033A0;
      padding-bottom: 10px;
    }

    /* Flexbox container for maps */
    .maps-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    /* Map containers */
    #map-container-2, #map-container, #map-container-3, #map-container-4 {
      flex: 1;
      background-color: #fff;
      border: 2px solid #0033A0;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Map styling */
    #map2, #map, #map3, #map4 {
      width: 100%;
      height: 80vh;
      border-radius: 8px;
    }

    /* Map title styling */
    #map-title, #map-title-2, #map-title-3, #map-title-4 {
      margin: 0;
      color: #0033A0;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      border-bottom: 2px solid #0033A0;
      padding-bottom: 10px;
      margin-bottom: 10px;
    }

    /* Footer styling */
    footer {
      background-color: #0033A0;
      color: #FFFFFF;
      text-align: center;
      padding: 10px;
      margin-top: 20px;
      font-size: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      background: linear-gradient(145deg, #0033A0, #002366);
    }

    /* Dashboard Cards Styling */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .dashboard-card {
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 10px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .dashboard-card h2 {
      margin-top: 0;
      font-size: 1.5em;
      color: #333;
    }

    .dashboard-card p {
      color: #666;
    }

   /* Chart container styling */
#chart-container {
  background-color: #fff;
  border: 2px solid #0033A0;
  border-radius: 8px;
  padding: 20px; /* Padding for all sides */
  padding-top: 30px; /* Extra padding at the top */
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  width: 100%; /* Reduced width */
  height: 50vh; /* Reduced height */
  display: flex;
  flex-direction: column;
  gap: 10px; /* Reduced gap */
  margin: 20px auto; /* Added margin-top and centered the container */
}

/* Chart heading styling */
#chart-container h2 {
  margin-top: 0; /* Reset margin-top for the heading */
  color: #0033A0;
  font-size: 20px;
  margin-bottom: 15px;
  font-weight: bold;
  text-align: center;
  border-bottom: 2px solid #0033A0;
  padding-bottom: 10px;
}

/* Chart canvas styling */
#displacementChart {
  width: 100% !important;
  height: 80% !important; /* Adjusted height to fit smaller container */
}

/* Responsive design for smaller screens */
@media (max-width: 768px) {
  #title-container {
    flex-direction: column;
    align-items: flex-start;
  }

  .content-container {
    flex-direction: column;
  }
}

      #map2, #map, #map3, #map4 {
        height: 90vh;
      }
    }
  </style>
</head>

<body>
  <!-- Title container with logo, title, and info card -->
  <div id="title-container">
    <img src="./data/DTM.jpg" alt="IOM Logo" class="title-image">
    <div id="title">
      <h1>SUDAN | DISPLACEMENT TRACKING MATRIX - SUDAN MOBILITY </h1>
      <h2><strong>MONITORING SNAPSHOT OVERVIEW</strong></h2>
    </div>
  </div>

  <!-- Dashboard Cards Section -->
  <div class="dashboard-cards">
    <div class="dashboard-card" style="background-color: #0033A0; color: #fff;">
      <h2>2,000,000 </h2>
      <p>Internally Displaced Persons HH</p>
    </div>
    <div class="dashboard-card" style="background-color: #0033A0; color: #fff;">
      <h2>2,000,000</h2>
      <p>This is the content of card 2.</p>
    </div>
    <div class="dashboard-card" style="background-color: #ff671f; color: #fff;">
      <h2>2,000,000</h2>
      <p>This is the content of card 3.</p>
    </div>
    <div class="dashboard-card" style="background-color: #ff671f; color: #fff;">
      <h2>2,000,000</h2>
      <p>This is the content of card 4.</p>
    </div>
  </div>

 

  <!-- Maps Container for map3 and map4 -->
  <div class="maps-container">
    <div id="map-container-3">
      <h2 id="map-title-3">Total Number of IDPs by State (Admin1)</h2>
      <div id="map3"></div>
    </div>
    <div id="map-container-4">
      <h2 id="map-title-4">Total Number of Returnees by State (Admin1)</h2>
      <div id="map4"></div>
    </div>
  </div>

  <!-- Maps Container for map1 and map2 -->
  <div class="maps-container">
    <div id="map-container-2">
      <h2 id="map-title">Returnee Movements Across Sudan</h2>
      <div id="map"></div>
    </div>
    <div id="map-container">
      <h2 id="map-title-2">Second Map: Returnee Movements Across Sudan</h2>
      <div id="map2"></div>
    </div>
  </div>

  <!-- Timeline and Map Container -->
  <div id="timeline-map-container">
    <!-- Timeline Graph Container -->
    <div id="timeline-container">
      <h2>Returnees Over Time (October 2024 - June 2025)</h2>
      <canvas id="timelineChart"></canvas>
    </div>
  </div>
   <!-- Chart Container -->
  <div id="chart-container">
    <h2>Number of Population Affected by Displacement</h2>
    <canvas id="displacementChart"></canvas>
  </div>

  <!-- Add image above the footer -->
  <img src="./data/doner.png" alt="Donor Logo" style="width: 100%; height: auto; display: block; margin: 0 auto;">

  <footer>
    <p>&copy; 2025 International Organization for Migration | IOM, UN Migration. Sudan | Displacement Tracking Matrix</p>
    <div class="footer-links">
      <a href="https://dtm.iom.int/sudan" target="_blank">Visit IOM Sudan Website</a> |
      <a href="https://displacement.iom.int/" target="_blank">DTM Global Website</a> |
    </div>
    <div class="footer-info">
      <p>For more information, please contact <a href="mailto:dtmsudan@iom.int">dtmsudan@iom.int</a>.</p>
    </div>
  </footer>

  <!-- External Scripts -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>

  <script>
    // Initialize the first map
    const map = L.map('map').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the first map
    const cartoDBLight1 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap1 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery1 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner1 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the first map
    cartoDBLight1.addTo(map);

    // Add layer control to the first map
    const baseLayers1 = {
      "CartoDB Light": cartoDBLight1,
      "OpenStreetMap": openStreetMap1,
      "Esri World Imagery": esriWorldImagery1,
      "Stamen Toner": stamenToner1
    };

    L.control.layers(baseLayers1).addTo(map);

    // Parse CSV data and create flow map layer for the first map
    Papa.parse('./data/data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        flowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => {
            const baseRadius = 6;
            const maxRadius = 20;
            const volume = feature.properties.e_Volume || 0;

            const radius = feature.properties.isOrigin
              ? baseRadius
              : Math.min(baseRadius + (volume / 5000), maxRadius);

            return {
              radius: radius,
              weight: 1,
              color: feature.properties.isOrigin ? 'rgb(17, 142, 170)' : 'rgb(195, 255, 62)',
              fillColor: feature.properties.isOrigin ? 'rgba(0, 51, 160)' : 'rgb(255, 103, 31)',
              fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
            };
          },
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
            ],
            defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: addTooltip
        }).addTo(map);

        // Add tooltip and popup to features
        function addTooltip(feature, layer) {
          const tooltipContent = feature.properties.isOrigin
            ? `State of Displacement: ${feature.properties.s_State}`
            : `State of Return: ${feature.properties.e_locality}`;

          layer.bindTooltip(tooltipContent);
          layer.on('mouseover', () => layer.openTooltip());
          layer.on('mouseout', () => layer.closeTooltip());

          // Add popup
          const popupContent = feature.properties.isOrigin
            ? `<b>State of Displacement:</b> ${feature.properties.s_State}`
            : `<b>State of Return:</b> ${feature.properties.e_locality}`;

          layer.bindPopup(popupContent);
        }

        // Highlight paths on mouseover
        flowmapLayer.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      }
    });

    // Add legend to the first map
    const legend = L.control({ position: 'bottomleft' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px">Returnee Flow Volume:</span><br/>
        <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> < 10000</span><br/>
        <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold">10,001 - 20,000</span><br/>
        <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> > 20,000</span><br/>
      `;
      return div;
    };
    legend.addTo(map);

    // Initialize the second map
    const map2 = L.map('map2').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the second map
    const cartoDBLight2 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap2 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery2 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner2 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the second map
    cartoDBLight2.addTo(map2);

    // Add layer control to the second map
    const baseLayers2 = {
      "CartoDB Light": cartoDBLight2,
      "OpenStreetMap": openStreetMap2,
      "Esri World Imagery": esriWorldImagery2,
      "Stamen Toner": stamenToner2
    };

    L.control.layers(baseLayers2).addTo(map2);

    // Parse CSV data and create flow map layer for the second map
    Papa.parse('./data/data_idps.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection2 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        const flowmapLayer2 = L.canvasFlowmapLayer(geoJsonFeatureCollection2, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => {
            const baseRadius = 12;
            const maxRadius = 6;
            const volume = feature.properties.e_Volume || 0;

            const radius = feature.properties.isOrigin
              ? baseRadius
              : Math.min(baseRadius + (volume / 5000), maxRadius);

            return {
              radius: radius,
              weight: 1,
              color: feature.properties.isOrigin ? 'rgb(195, 255, 62)' : 'rgb(17, 142, 170)',
              fillColor: feature.properties.isOrigin ? 'rgb(255, 103, 31)' : 'rgba(0, 51, 160)',
              fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
            };
          },
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
            ],
            defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: addTooltip
        }).addTo(map2);

        // Add tooltip and popup to features
        function addTooltip(feature, layer) {
          const tooltipContent = feature.properties.isOrigin
            ? `State of Displacement: ${feature.properties.s_State}`
            : `State of Return: ${feature.properties.e_locality}`;

          layer.bindTooltip(tooltipContent);
          layer.on('mouseover', () => layer.openTooltip());
          layer.on('mouseout', () => layer.closeTooltip());

          // Add popup
          const popupContent = feature.properties.isOrigin
            ? `<b>State of Displacement:</b> ${feature.properties.s_State}`
            : `<b>State of Return:</b> ${feature.properties.e_locality}`;

          layer.bindPopup(popupContent);
        }

        // Highlight paths on mouseover
        flowmapLayer2.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer2.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      }
    });

    // Add legend to the second map
    const legend2 = L.control({ position: 'bottomleft' });
    legend2.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px">Returnee Flow Volume:</span><br/>
        <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> < 10000</span><br/>
        <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold">10,001 - 20,000</span><br/>
        <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> > 20,000</span><br/>
      `;
      return div;
    };
    legend2.addTo(map2);

    // Initialize the third map
    const map3 = L.map('map3').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the third map
    const cartoDBLight3 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap3 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery3 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner3 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the third map
    cartoDBLight3.addTo(map3);

    // Add layer control to the third map
    const baseLayers3 = {
      "CartoDB Light": cartoDBLight3,
      "OpenStreetMap": openStreetMap3,
      "Esri World Imagery": esriWorldImagery3,
      "Stamen Toner": stamenToner3
    };

    L.control.layers(baseLayers3).addTo(map3);

    // Parse CSV data and create animated markers for the third map
    Papa.parse('./data/total_idps.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection3 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.lon, datum.lat] },
            properties: datum
          }))
        };

        // Find the maximum total_idps value for normalization
        const maxTotalIdps = Math.max(...results.data.map(d => d.total_idps));

        // Function to animate circle markers
        function animateCircleMarker(marker, baseRadius) {
          const tween = new TWEEN.Tween({ radius: baseRadius })
            .to({ radius: baseRadius * 1.5 }, 1000) // Animate to 1.5x the base radius
            .easing(TWEEN.Easing.Sinusoidal.InOut) // Smooth easing
            .yoyo(true) // Reverse the animation
            .repeat(Infinity) // Repeat indefinitely
            .onUpdate(({ radius }) => {
              marker.setRadius(radius); // Update the marker's radius
            })
            .start(); // Start the animation
        }

        // Add animated markers to the third map
        L.geoJSON(geoJsonFeatureCollection3, {
          pointToLayer: (feature, latlng) => {
            // Normalize the total_idps value to determine the base radius
            const baseRadius = 8 + (feature.properties.total_idps / maxTotalIdps) * 20;

            // Create a circle marker
            const marker = L.circleMarker(latlng, {
              radius: baseRadius, // Initial radius
              fillColor: '#0033A0', // Blue color for IDPs
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });

            // Animate the marker
            animateCircleMarker(marker, baseRadius);

            return marker;
          },
          onEachFeature: (feature, layer) => {
            const popupContent = `
              <b>State:</b> ${feature.properties.state}<br/>
              <b>Total IDPs:</b> ${feature.properties.total_idps.toLocaleString()}
            `;
            layer.bindPopup(popupContent);

            // Add tooltip
            const tooltipContent = `<b>${feature.properties.state}</b><br/>
              <b>Total IDPs:</b> ${feature.properties.total_idps.toLocaleString()}`;
            layer.bindTooltip(tooltipContent);
          }
        }).addTo(map3);
      }
    });

    // Update Tween.js animations on each frame
    function animate() {
      requestAnimationFrame(animate);
      TWEEN.update();
    }
    animate(); // Start the animation loop

    // Add legend to the third map
    const legend3 = L.control({ position: 'bottomleft' });
    legend3.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px; font-weight:bold;">Total IDPs by State:</span><br/>
        <div style="display: flex; align-items: center; margin-top: 10px;">
          <div style="width: 10px; height: 10px; background: #0033A0; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">Small Circle: < 10,000 IDPs</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 20px; height: 20px; background: #0033A0; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">Medium Circle: 10,000 - 50,000 IDPs</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 30px; height: 30px; background: #0033A0; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">Large Circle: > 50,000 IDPs</span>
        </div>
      `;
      return div;
    };
    legend3.addTo(map3);

    // Initialize Timeline Graph
    const ctx = document.getElementById('timelineChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
    gradient.addColorStop(0, 'rgba(0, 51, 160, 0.8)');
    gradient.addColorStop(1, 'rgba(0, 51, 160, 0.2)');

    const timelineChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Oct-24', 'Nov-24', 'Dec-24', 'Jan-25', 'Feb-25', 'Mar-25', 'Apr-25', 'May-25', 'Jun-25'],
        datasets: [{
          label: 'Returnees Over Time',
          data: [0, 0, 53517, 32240, 282217, 9430, 0, 0, 0],
          borderColor: '#0033A0',
          backgroundColor: gradient,
          borderWidth: 3,
          fill: true,
          pointBackgroundColor: '#0033A0',
          pointBorderColor: '#fff',
          pointRadius: 5,
          pointHoverRadius: 7,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            backgroundColor: '#0033A0',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#fff',
            borderWidth: 1,
            displayColors: false
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Number of Returnees',
              color: '#0033A0',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            grid: {
              color: '#e0e0e0'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Month',
              color: '#0033A0',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            grid: {
              color: '#e0e0e0'
            }
          }
        },
        animation: {
          duration: 15000,
          easing: 'easeInOutQuart'
        }
      }
    });

    // Initialize the fourth map
    const map4 = L.map('map4').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the fourth map
    const cartoDBLight4 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap4 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery4 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner4 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the fourth map
    cartoDBLight4.addTo(map4);

    // Add layer control to the fourth map
    const baseLayers4 = {
      "CartoDB Light": cartoDBLight4,
      "OpenStreetMap": openStreetMap4,
      "Esri World Imagery": esriWorldImagery4,
      "Stamen Toner": stamenToner4
    };

    L.control.layers(baseLayers4).addTo(map4);

    // Parse CSV data and create animated markers for the fourth map
    Papa.parse('./data/total_return.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection4 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.lon, datum.lat] },
            properties: datum
          }))
        };

        // Find the maximum total_return value for normalization
        const maxTotalReturn = Math.max(...results.data.map(d => d.total_return));

        // Function to animate circle markers
        function animateCircleMarker(marker, baseRadius) {
          const tween = new TWEEN.Tween({ radius: baseRadius })
            .to({ radius: baseRadius * 1.5 }, 1000) // Animate to 1.5x the base radius
            .easing(TWEEN.Easing.Sinusoidal.InOut) // Smooth easing
            .yoyo(true) // Reverse the animation
            .repeat(Infinity) // Repeat indefinitely
            .onUpdate(({ radius }) => {
              marker.setRadius(radius); // Update the marker's radius
            })
            .start(); // Start the animation
        }

        // Add animated markers to the fourth map
        L.geoJSON(geoJsonFeatureCollection4, {
          pointToLayer: (feature, latlng) => {
            // Normalize the total_return value to determine the base radius
            const baseRadius = 8 + (feature.properties.total_return / maxTotalReturn) * 20;

            // Create a circle marker
            const marker = L.circleMarker(latlng, {
              radius: baseRadius, // Initial radius
              fillColor: 'rgba(255, 103, 31, 0.8)', // Orange color for returnees
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });

            // Animate the marker
            animateCircleMarker(marker, baseRadius);

            return marker;
          },
          onEachFeature: (feature, layer) => {
            const popupContent = `
              <b>State:</b> ${feature.properties.state}<br/>
              <b>Total Returnees:</b> ${feature.properties.total_return.toLocaleString()}
            `;
            layer.bindPopup(popupContent);

            // Add tooltip
            const tooltipContent = `<b>${feature.properties.state}</b><br/>
              <b>Total Returnees:</b> ${feature.properties.total_return.toLocaleString()}`;
            layer.bindTooltip(tooltipContent);
          }
        }).addTo(map4);
      }
    });

    // Add legend to the fourth map
    const legend4 = L.control({ position: 'bottomleft' });
    legend4.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px; font-weight:bold;">Total Returnees by State:</span><br/>
        <div style="display: flex; align-items: center; margin-top: 10px;">
          <div style="width: 10px; height: 10px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">Small Circle: < 10,000 Returnees</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 20px; height: 20px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">Medium Circle: 10,000 - 50,000 Returnees</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 30px; height: 30px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">Large Circle: > 50,000 Returnees</span>
        </div>
      `;
      return div;
    };
    legend4.addTo(map4);

    // Initialize the Displacement Chart
    const states = [
      "Aj Jazirah", "Blue Nile", "Central Darfur", "East Darfur", "Gedaref", 
      "Kassala", "Khartoum", "North Darfur", "North Kordofan", "Northern", 
      "Red Sea", "River Nile", "Sennar", "South Darfur", "South Kordofan", 
      "West Darfur", "West Kordofan", "White Nile"
    ];
    const displaced = [
      876156, 270810, 749491, 247874, 14327, 6211, 3500400, 1844175, 
      91161, 12052, 30480, 53683, 244250, 2082537, 414734, 368971, 
      314484, 179544
    ];
    const population = [
      5687557, 1344267, 1786503, 1213951, 2545604, 2811446, 9146191, 
      2775652, 2160476, 1023194, 1549857, 1651873, 2170863, 3912372, 
      2017962, 1940860, 1713462, 3046811
    ];

    // Calculate the non-displaced population
    const nonDisplaced = population.map((pop, index) => pop - displaced[index]);

    // Chart configuration
    const ctx2 = document.getElementById('displacementChart').getContext('2d');
    const displacementChart = new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: states,
        datasets: [
          {
            label: 'Non-Displaced Population',
            data: nonDisplaced,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          },
          {
            label: '# of Displaced People',
            data: displaced,
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false, // Ensure the chart fits the container
        scales: {
          x: {
            stacked: true, // Stack bars on the x-axis
          },
          y: {
            stacked: true, // Stack bars on the y-axis
            beginAtZero: true,
            title: {
              display: true,
              text: 'Population'
            }
          }
        },
        plugins: {
          legend: {
            position: 'top',
          },
          tooltip: {
            callbacks: {
              afterBody: (tooltipItems) => {
                // Get the index of the hovered item
                const index = tooltipItems[0].dataIndex;
                // Return population and percentage for the hovered state
                return [
                  `Total Population: ${population[index].toLocaleString()}`,
                  `% Displaced: ${((displaced[index] / population[index]) * 100).toFixed(2)}%`
                ];
              }
            }
          }
        }
      }
    });
  </script>
</body>

</html>
