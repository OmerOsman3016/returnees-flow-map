<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Your existing head content remains the same -->
  <!-- ... -->
</head>

<body>
  <!-- Your existing loading spinner and HTML structure remains the same -->
  <!-- ... -->

    <!-- Displacement Section -->
    <div id="displacement-section" class="maps-container">
      <div id="map-container">
        <h2>Displacement Proportions by State</h2>
        <div id="mobility-text-container">
          <p>
            This map visualizes the proportion of each state's population that has been displaced by the ongoing conflict. The pie chart markers show at a glance which states have been most severely affected, with the orange segments representing displaced populations and blue segments showing remaining residents.
          </p>
          <p>
            <strong>Key insights from the map visualization:</strong>
            <ul>
              <li><strong>North Darfur stands out</strong> with the highest displacement proportion (66%) - nearly two-thirds of its population has been forced to flee</li>
              <li><strong>South Darfur shows</strong> the largest absolute numbers (over 2 million displaced) despite being a smaller proportion (53%) of its larger population</li>
              <li><strong>Khartoum's displacement</strong> (3.5 million people) represents 38% of the state's population, visible through the relative sizes of the pie segments</li>
              <li><strong>Northern states</strong> like Northern and Red Sea show much smaller displacement proportions (1-2%), visible through their predominantly blue pie charts</li>
            </ul>
          </p>
          <p>
            <strong>How to interpret the map symbols:</strong>
            <ul>
              <li>Each pie chart is scaled to the state's total population size</li>
              <li>Orange segments show displaced populations</li>
              <li>Blue segments show non-displaced populations</li>
              <li>The percentage label in each pie shows the exact displacement proportion</li>
              <li>Larger pies indicate states with bigger total populations</li>
            </ul>
          </p>
          <p>
            The spatial distribution reveals clear patterns - states in Darfur and Khartoum show the most severe displacement, while northern and eastern states have been less affected. This visualization helps humanitarian actors quickly identify where needs are greatest and how displacement is impacting different regions proportionally.
          </p>
          <p>
            <strong>Map interaction tips:</strong>
            <ul>
              <li>Click on any pie chart to see detailed state statistics</li>
              <li>Compare states by both segment size (proportion) and overall pie size (total population)</li>
              <li>Note the concentration of large orange segments in western Sudan</li>
            </ul>
          </p>
        </div>
        <div id="map5"></div>
      </div>
    </div>

  <!-- Your existing remaining HTML content remains the same -->
  <!-- ... -->

  <!-- External Scripts -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // IDP Data
    const idpData = {
        "SD01": {
            stateName: "North Darfur",
            idps: 1786909,
            population: 2775652,
            localities: 17,
            locations: 510
        },
        "SD02": {
            stateName: "South Darfur",
            idps: 1837706,
            population: 3912372,
            localities: 21,
            locations: 156
        },
        "SD03": {
            stateName: "Central Darfur",
            idps: 929977,
            population: 1786503,
            localities: 9,
            locations: 131
        },
        "SD04": {
            stateName: "Khartoum",
            idps: 105380,
            population: 9146191,
            localities: 7,
            locations: 416
        },
        "SD05": {
            stateName: "White Nile",
            idps: 648539,
            population: 3046811,
            localities: 9,
            locations: 1309
        },
        "SD06": {
            stateName: "North Kordofan",
            idps: 199248,
            population: 2160476,
            localities: 8,
            locations: 639
        },
        "SD07": {
            stateName: "South Kordofan",
            idps: 447459,
            population: 2017962,
            localities: 14,
            locations: 497
        },
        "SD08": {
            stateName: "West Darfur",
            idps: 309227,
            population: 1940860,
            localities: 8,
            locations: 145
        },
        "SD09": {
            stateName: "East Darfur",
            idps: 793948,
            population: 1213951,
            localities: 9,
            locations: 52
        },
        "SD10": {
            stateName: "Blue Nile",
            idps: 456465,
            population: 1344267,
            localities: 7,
            locations: 240
        },
        "SD11": {
            stateName: "Gedaref",
            idps: 852626,
            population: 2545604,
            localities: 12,
            locations: 656
        },
        "SD12": {
            stateName: "Kassala",
            idps: 318415,
            population: 2811446,
            localities: 11,
            locations: 325
        },
        "SD13": {
            stateName: "Red Sea",
            idps: 244306,
            population: 1549857,
            localities: 10,
            locations: 306
        },
        "SD14": {
            stateName: "River Nile",
            idps: 935723,
            population: 1651873,
            localities: 7,
            locations: 1283
        },
        "SD15": {
            stateName: "Sennar",
            idps: 130614,
            population: 2170863,
            localities: 7,
            locations: 420
        },
        "SD16": {
            stateName: "Aj Jazirah",
            idps: 331531,
            population: 5687557,
            localities: 8,
            locations: 1870
        },
        "SD17": {
            stateName: "Northern",
            idps: 567174,
            population: 1023194,
            localities: 7,
            locations: 629
        },
        "SD18": {
            stateName: "West Kordofan",
            idps: 406093,
            population: 1713462,
            localities: 14,
            locations: 701
        }
    };

    // Add percentage displaced to each state
    for (const stateCode in idpData) {
        idpData[stateCode].percentageDisplaced = 
            ((idpData[stateCode].idps / idpData[stateCode].population) * 100).toFixed(2);
    }

    // Your existing loading animation and initialization code remains the same
    // ...

    // Initialize dashboard function
    function initializeDashboard() {
      // Your existing slideshow and other initialization code
      // ...

      // Pie Chart Map Showing Displacement Proportions
      const map5 = L.map('map5').setView([16, 30], L.Browser.mobile ? 3 : 5.5);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map5);

      // Create info panel for the pie chart map
      const infoPanel = L.control({position: 'topleft'});
      infoPanel.onAdd = function(map) {
          this._div = L.DomUtil.create('div', 'info-panel');
          this.update();
          return this._div;
      };
      infoPanel.update = function(feature) {
          const stateCode = feature ? feature.properties.admin1Code : null;
          const stateData = stateCode ? idpData[stateCode] : null;
          const stateName = feature ? feature.properties.admin1Name : '';
          
          this._div.innerHTML = '<h4>Sudan Displacement Proportions</h4>' +
              (feature ?
                  `<b>${stateName}</b><br />` +
                  (stateData?.idps ? 
                      `${stateData.idps.toLocaleString()} IDPs (${stateData.percentageDisplaced}%)` : 
                      'Data not available') +
                  `<div class="color-key" style="background: ${getColor(stateData?.idps || 0)};"></div>`
                  : 'Hover over a state');
      };
      infoPanel.addTo(map5);

      // Color scale for IDP visualization
      function getColor(d) {
          return d > 1500000 ? '#08306B' :
                 d > 1000000 ? '#2171B5' :
                 d > 500000  ? '#6BAED6' :
                 d > 250000  ? '#BDD7E7' :
                               '#EFF3FF';
      }

      // State data with coordinates (lat, lng), displaced, total population
      const stateData = [
          ["Aj Jazirah", 14.900, 33.434, idpData.SD16.idps, idpData.SD16.population],
          ["Blue Nile", 11.270, 34.390, idpData.SD10.idps, idpData.SD10.population],
          ["Central Darfur", 12.900, 23.470, idpData.SD03.idps, idpData.SD03.population],
          ["East Darfur", 11.160, 26.140, idpData.SD09.idps, idpData.SD09.population],
          ["Gedaref", 14.040, 35.380, idpData.SD11.idps, idpData.SD11.population],
          ["Kassala", 15.450, 36.400, idpData.SD12.idps, idpData.SD12.population],
          ["Khartoum", 15.501, 32.560, idpData.SD04.idps, idpData.SD04.population],
          ["North Darfur", 15.766, 27.333, idpData.SD01.idps, idpData.SD01.population],
          ["North Kordofan", 13.630, 27.930, idpData.SD06.idps, idpData.SD06.population],
          ["Northern", 19.615, 30.416, idpData.SD17.idps, idpData.SD17.population],
          ["Red Sea", 19.580, 37.130, idpData.SD13.idps, idpData.SD13.population],
          ["River Nile", 18.500, 33.800, idpData.SD14.idps, idpData.SD14.population],
          ["Sennar", 13.550, 33.600, idpData.SD15.idps, idpData.SD15.population],
          ["South Darfur", 11.783, 24.883, idpData.SD02.idps, idpData.SD02.population],
          ["South Kordofan", 11.150, 29.633, idpData.SD07.idps, idpData.SD07.population],
          ["West Darfur", 12.900, 22.466, idpData.SD08.idps, idpData.SD08.population],
          ["West Kordofan", 11.200, 28.433, idpData.SD18.idps, idpData.SD18.population],
          ["White Nile", 13.450, 32.500, idpData.SD05.idps, idpData.SD05.population]
      ];

      // Create pie chart icon function with standardized size
      function createPieChartIcon(displaced, total, sizeFactor = 1) {
        const displacedPercent = displaced / total;
        const endAngle = displacedPercent * 360;
        
        const baseRadius = 30;
        const radius = baseRadius * sizeFactor;
        
        const svg = `
          <svg width="${radius * 2}" height="${radius * 2}" viewBox="0 0 ${radius * 2} ${radius * 2}">
            <circle cx="${radius}" cy="${radius}" r="${radius}" fill="#418FDE"/>
            <path d="M${radius},${radius} L${radius},0 A${radius},${radius} 0 ${endAngle > 180 ? 1 : 0},1 
              ${radius + Math.sin((endAngle * Math.PI)/180) * radius},
              ${radius - Math.cos((endAngle * Math.PI)/180) * radius} z" 
              fill="rgba(255, 103, 31, 0.8)"/>
            <circle cx="${radius}" cy="${radius}" r="${radius * 0.6}" fill="white" opacity="0.7"/>
            <text x="${radius}" y="${radius}" text-anchor="middle" dominant-baseline="middle" 
                  font-size="${8 * sizeFactor}" font-weight="bold" fill="#82C4FF">
              ${Math.round(displacedPercent * 100)}%
            </text>
          </svg>
        `;

        return L.divIcon({
          html: svg,
          iconSize: [radius * 2, radius * 2],
          className: 'pie-chart-marker'
        });
      }

      // Create a layer group for the pie chart markers
      const pieMarkersLayer = L.layerGroup().addTo(map5);
      
      // Store references to all pie chart markers
      const pieMarkers = [];

      // Add markers with standardized pie charts
      stateData.forEach(state => {
        const [name, lat, lng, displaced, total] = state;
        const stateCode = Object.keys(idpData).find(key => idpData[key].stateName === name);
        const stateInfo = idpData[stateCode];
        
        const marker = L.marker([lat, lng], {
          icon: createPieChartIcon(displaced, total, 1.0)
        }).addTo(pieMarkersLayer).bindPopup(`
          <b>${name}</b><br>
          Total Population: ${total.toLocaleString()}<br>
          Displaced: ${displaced.toLocaleString()} (${((displaced/total)*100).toFixed(1)}%)<br>
          Non-Displaced: ${(total - displaced).toLocaleString()}<br>
          Localities: ${stateInfo?.localities || 'N/A'}<br>
          Locations: ${stateInfo?.locations || 'N/A'}
        `);
        
        pieMarkers.push({
          name: name,
          lat: lat,
          lng: lng,
          displaced: displaced,
          total: total,
          marker: marker
        });
      });

      // Function to update pie chart sizes
      function updatePieChartSizes(size) {
        const sizeFactors = {
          small: 0.7,
          medium: 1.0,
          large: 1.3
        };
        
        const factor = sizeFactors[size];
        
        pieMarkers.forEach(pieMarker => {
          pieMarker.marker.setIcon(createPieChartIcon(pieMarker.displaced, pieMarker.total, factor));
        });
      }

      // Enhanced legend control for pie chart map
      const legend5 = L.control({position: 'bottomright'});
      legend5.onAdd = () => {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <h4>Displacement Proportion</h4>
          <div class="legend-checkbox">
            <input type="checkbox" id="displaced-checkbox" checked>
            <label for="displaced-checkbox">Displaced Population</label>
          </div>
          <div class="legend-checkbox">
            <input type="checkbox" id="remaining-checkbox" checked>
            <label for="remaining-checkbox">Remaining Population</label>
          </div>
          <div class="marker-size-controls">
            <div class="marker-size-label">Marker Size</div>
            <div class="marker-size-buttons">
              <button id="size-small">Small</button>
              <button id="size-medium" class="active">Medium</button>
              <button id="size-large">Large</button>
            </div>
            <div class="marker-size-label">Represents total state population</div>
          </div>
        `;
        
        // Add functionality to checkboxes
        const displacedCheckbox = div.querySelector('#displaced-checkbox');
        const remainingCheckbox = div.querySelector('#remaining-checkbox');
        
        displacedCheckbox.addEventListener('change', function() {
          const opacity = this.checked ? 1 : 0;
          pieMarkers.forEach(pieMarker => {
            const icon = pieMarker.marker.getIcon();
            const newHtml = icon.options.html.replace(/fill="rgba\(255, 103, 31, [\d.]+\)"/g, 
                                            `fill="rgba(255, 103, 31, ${opacity})"`);
            icon.options.html = newHtml;
            pieMarker.marker.setIcon(icon);
          });
        });
        
        remainingCheckbox.addEventListener('change', function() {
          const opacity = this.checked ? 1 : 0;
          pieMarkers.forEach(pieMarker => {
            const icon = pieMarker.marker.getIcon();
            const newHtml = icon.options.html.replace(/fill="#418FDE"/g, 
                                            `fill="rgba(65, 143, 222, ${opacity})"`);
            icon.options.html = newHtml;
            pieMarker.marker.setIcon(icon);
          });
        });
        
        // Add functionality to size buttons
        const sizeButtons = div.querySelectorAll('.marker-size-buttons button');
        sizeButtons.forEach(button => {
          button.addEventListener('click', function() {
            sizeButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const size = this.id.split('-')[1];
            updatePieChartSizes(size);
          });
        });
        
        return div;
      };
      legend5.addTo(map5);

      // Sample GeoJSON data for hover functionality
      const sudanGeoJSON = {
          "type": "FeatureCollection",
          "features": Object.keys(idpData).map(code => ({
              "type": "Feature",
              "properties": {
                  "admin1Code": code,
                  "admin1Name": idpData[code].stateName
              },
              "geometry": {
                  "type": "Polygon",
                  "coordinates": [[[0,0],[0,1],[1,1],[1,0],[0,0]]] // Simplified geometry
              }
          }))
      };

      // Add GeoJSON layer for hover functionality
      const geojsonLayer = L.geoJson(sudanGeoJSON, {
          style: {
              weight: 1,
              opacity: 0.7,
              color: 'white',
              fillOpacity: 0
          },
          onEachFeature: function(feature, layer) {
              layer.on({
                  mouseover: function(e) {
                      infoPanel.update(feature);
                  },
                  mouseout: function() {
                      infoPanel.update();
                  }
              });
          }
      }).addTo(map5);

      // Your existing remaining JavaScript code
      // ...
    }

    // Call initializeDashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      initializeDashboard();
    });
  </script>
</body>
</html>
