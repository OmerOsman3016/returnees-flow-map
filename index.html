<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="description" content="Sudan | Displacement Tracking Matrix-Returnees Flow" />
  <title>Sudan | Displacement Tracking Matrix - Returnees Flow</title>

  <!-- External CSS libraries -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.css" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <style>
    /* General body styling */
    body {
      margin: 20px;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #FFFFFF;
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.6;
      letter-spacing: 0.5px;
      font-size: 16px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      opacity: 0;
      animation: fadeIn 1.5s ease-in-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    *, *::before, *::after { box-sizing: inherit; }

    a {
      color: #0033A0;
      text-decoration: none;
      transition: color 0.3s ease;
    }

    a:hover { color: #0056b3; }

    /* Custom scrollbar */
    body::-webkit-scrollbar { width: 10px; }
    body::-webkit-scrollbar-track { background: #f1f1f1; }
    body::-webkit-scrollbar-thumb { background: #888; border-radius: 5px; }
    body::-webkit-scrollbar-thumb:hover { background: #555; }

    /* Title container styling */
    #title-container {
      display: flex;
      align-items: center;
      background-color: #418FDE;
      padding: 10px 20px;
      color: white;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      flex-wrap: wrap;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.2s;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .title-image {
      width: 220px;
      height: 90px;
      margin-right: 5px;
      border-radius: 5px;
    }

    #title {
      flex: 1;
      text-align: left;
    }

    #title h1 {
      margin: 0;
      font-size: 30px;
      font-weight: bold;
      border-bottom: 3px solid white;
      padding-bottom: 5px;
      display: inline-block;
    }

    #title h2 {
      margin: 0;
      font-size: 24px;
      font-weight: normal;
      color: #f0f0f0;
    }

    /* Consistent title styling for all sections */
    h2 {
      color: #84adec;
      font-size: 20px;
      font-weight: bold;
      text-align: left;
      border-bottom: 2px solid #418FDE;
      margin-bottom: 15px;
    }

    /* Description container styling */
    #description-container {
      display: flex;
      background-color: #ffffff;
      border: 1px solid #d9e0f1;
      border-radius: 8px;
      padding: 10px 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-family: Arial, sans-serif;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.4s;
    }

    #description-container p {
      font-size: 14px;
      line-height: 1.6;
      color: #555;
      margin-bottom: 15px;
    }

    #description-container strong { color: #333; font-weight: 600; }
    #description-container .data-point { color: #418FDE; font-weight: 600; }

    /* Dashboard Cards Styling */
    .dashboard-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.6s;
    }

    .dashboard-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 10px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      height: 100px;
      background: #fff;
      opacity: 0;
      transform: scale(0.9);
      animation: cardEntrance 0.5s ease-in-out forwards;
    }

    @keyframes cardEntrance {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .dashboard-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); }

    .card-content { flex: 1; }
    .card-content h2 { margin: 0; font-size: 2em; color: #ffffff; }
    .card-content p { margin: 4px 0 0; color: #ffffff; font-size: 1em; }
    .card-image { display: flex; align-items: center; justify-content: flex-end; width: 60px; margin-left: 10px; }
    .card-icon { width: 40px; height: 40px; }

    /* Staggered delays for dashboard cards */
    .dashboard-card:nth-child(1) { animation-delay: 1s; }
    .dashboard-card:nth-child(2) { animation-delay: 2s; }
    .dashboard-card:nth-child(3) { animation-delay: 3s; }
    .dashboard-card:nth-child(4) { animation-delay: 4s; }
    .dashboard-card:nth-child(5) { animation-delay: 5s; }

    /* Parent Container for Text and Map */
    .idps-frame-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.8s;
    }

    /* Text Container for Total Number of IDPs by STATE */
    #idps-text-container {
      flex: 1;
      background-color: #ffffff;
      border: 1px solid #d9e0f1;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #idps-text-container p {
      font-size: 14px;
      line-height: 1.6;
      color: #555;
      margin-bottom: 15px;
    }

    #idps-text-container ul {
      list-style-type: disc;
      margin-left: 20px;
      color: #555;
    }

    #idps-text-container ul li {
      margin-bottom: 5px;
    }

    #idps-text-container strong {
      color: #333;
      font-weight: 600;
    }

    /* Map Container for Total Number of IDPs by STATE */
    #map-container-3 {
      flex: 2;
      background-color: #ffffff;
      border: 1px solid #d9e0f1;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #map3 {
      width: 100%;
      height: 80vh;
      border-radius: 8px;
    }

    /* Maps container styling */
    .maps-container {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 0.8s;
    }

    #map-container, #map-container-2, #map-container-4 {
      flex: 1;
      background-color: #ffffff;
      border: 1px solid #d9e0f1;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #map, #map2, #map4 {
      width: 100%;
      height: 80vh;
      border-radius: 8px;
    }

   /* Timeline container styling */
#timeline-map-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 20px;
  min-width: 300px;
  opacity: 0;
  transform: translateY(20px);
  animation: slideUp 0.8s ease-in-out forwards;
  animation-delay: 1s;
}

#timeline-container {
  background-color: #ffffff;
  border: 1px solid #d9e0f1;
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  height: 250px; /* Reduced from 350px */
}

/* Sankey diagram container */
#sankey-container {
  background-color: #ffffff;
  border: 1px solid #d9e0f1;
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  margin-bottom: 20px;
  height: 400px;
  margin: 0 auto;
 display: block;
  transition: all 0.3s ease;
opacity: 0;
animation: fadeIn 1s ease-in-out forwards;
}

#sankey-diagram {
  width: 100%;
  height: 40%;
}
     


    #displacementChart { width: 100% !important; height: 80% !important; }

    /* Footer styling */
    footer {
      background-color: #418FDE;
      color: #FFFFFF;
      text-align: center;
      padding: 10px;
      margin-top: 20px;
      font-size: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      opacity: 0;
      transform: translateY(20px);
      animation: slideUp 0.8s ease-in-out forwards;
      animation-delay: 1.4s;
    }

    /* Mobility in Sudan Text Container */
    #mobility-text-container {
      flex: 1;
      background-color: #ffffff;
      border: 1px solid #d9e0f1;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 14px;
      line-height: 1.6;
      color: #555;
    }

    #mobility-text-container h2 {
      color: #84adec;
      font-size: 20px;
      font-weight: bold;
      text-align: left;
      border-bottom: 2px solid #418FDE;
      margin-bottom: 5px;
    }

    #mobility-text-container p {
      margin-bottom: 15px;
    }

    #mobility-text-container strong {
      color: #333;
      font-weight: 600;
    }

    #mobility-text-container .data-point {
      color: #418FDE;
      font-weight: 600;
    }

    /* Pie Chart Map Showing Displacement Proportions */
    #map5 {
      height: 600px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .legend {
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }

    /* Country Circle Map Styles */
    #country-circle-map {
      height: 600px;
      border-radius: 8px;
      margin: 20px 0;
    }

    /* Responsive design for smaller screens */
    @media (max-width: 768px) {
      #title-container { flex-direction: column; align-items: flex-start; }
      .content-container { flex-direction: column; }
      #map, #map2, #map3, #map4, #map5, #country-circle-map { height: 90vh; }

      .idps-frame-container {
        flex-direction: column;
      }

      #idps-text-container,
      #map-container-3 {
        flex: 1;
      }

      #map3 {
        height: 60vh;
      }
      
      #sankey-container {
        height: 300px;
        
      }
    }

    @media print {
      body { font-size: 12pt; color: #000; }
      .dashboard-cards, .maps-container { page-break-inside: avoid; }
      footer { display: none; }
    }
  </style>
</head>

<body>
  <!-- Title Container with Logo, Title, and Info Card -->
  <div id="title-container">
    <div id="title">
      <h1>SUDAN | DISPLACEMENT TRACKING MATRIX - SUDAN MOBILITY</h1>
      <h2><strong>Two Years of Displacement</strong></h2>
    </div>
    <!-- Add this image element to the right side of the title -->
    <img src="./data/IOM_DTM_WHITE.png" alt="IOM Logo" class="title-image">
  </div>

  <!-- Dashboard Cards Container -->
  <div class="dashboard-cards">
    <!-- Card 1: Internally Displaced Persons -->
    <div class="dashboard-card" style="background-color: #82C4FF; color: #fff;">
      <div class="card-content">
        <h2>11,585,384</h2>
        <p>Internally Displaced </p>
      </div>
      <div class="card-image">
        <img src="./data/Internally displaced.png" alt="IDP Icon" class="card-icon">
      </div>
    </div>

    <!-- Card 2: Returnees -->
    <div class="dashboard-card" style="background-color: #82C4FF; color: #fff;">
      <div class="card-content">
        <h2>396,738</h2>
        <p>Returnees</p>
      </div>
      <div class="card-image">
        <img src="./data/Returnees.png" alt="Returnee Icon" class="card-icon">
      </div>
    </div>

    <!-- Card 3: Crossing Border -->
    <div class="dashboard-card" style="background-color: #82C4FF; color: #fff;">
      <div class="card-content">
        <h2>3,934,086</h2>
        <p> Crossing Border</p>
      </div>
      <div class="card-image">
        <img src="./data/Crossing Border.png" alt="Border Crossing Icon" class="card-icon">
      </div>
    </div>

    <!-- Card 4: Migrants Affected -->
    <div class="dashboard-card" style="background-color: #82C4FF; color: #fff;">
      <div class="card-content">
        <h2>400,000</h2>
        <p>Migrants Affected</p>
      </div>
      <div class="card-image">
        <img src="./data/Migrants Affected.png" alt="Migrant Icon" class="card-icon">
      </div>
    </div>

    <!-- Card 5: Locations Covered -->
    <div class="dashboard-card" style="background-color: #82C4FF; color: #fff;">
      <div class="card-content">
        <h2>10,285</h2>
        <p>Locations Covered</p>
      </div>
      <div class="card-image">
        <img src="./data/Location.png" alt="Location Icon" class="card-icon">
      </div>
    </div>
  </div>

  <!-- IDPs Frame Container -->
  <div class="idps-frame-container">
    <!-- Text Container for Total Number of IDPs by State -->
    <div id="idps-text-container">
      <h2>CONTEXT</h2>
      <p>
        The map on the right displays the total number of Internally Displaced Persons (IDPs) by state in Sudan. The size of the circles represents the volume of IDPs in each state, with larger circles indicating higher numbers. The data highlights the significant displacement in states like <strong>South Darfur</strong> and <strong>North Darfur</strong>, which have been heavily affected by conflict.
      </p>
      <p>
        <h3>Key insights:</h3>
        <ul>
          <li><strong style="color: #FF5733;" >30%:</strong>  of a population is displaced both internally and externally</li>
          <li><strong style="color: #FF5733;">11.5 Million </strong> people have been displaced internally across all of Sudan, highlighting a severe humanitarian crisis driven by conflict, instability, and other factors.</li>
          <li><strong style="color: #FF5733;">3.9 Million </strong> people have been displaced externally from Sudan</li>
          <li><strong style="color: #FF5733;">3.63 Million</strong>  IDPs are concentrated in South Darfur and North Darfur, underscoring the immense scale of displacement and humanitarian needs in these regions.</li>
          <li><strong style="color: #FF5733;">4 Million</strong> IDPs live in camps across Sudan</li>
          <li><strong style="color: #FF5733;">7.4 Million</strong> IDPs have been displaced from Khartoum, South Darfur, and North Darfur,</li>
        </ul>
      </p>
    </div>

    <!-- Map Container for Total Number of IDPs by State -->
    <div id="map-container-3">
      <h2 id="map-title-3">Total Number of IDPs by State</h2>
      <div id="map3"></div>
    </div>
  </div>
  

  <!-- Pie Chart Map Showing Displacement Proportions -->
  <div class="maps-container">
    <div id="map-container">
      <h2>Displacement Proportions by State</h2>
      <div id="map5"></div>
    </div>
  </div>

  <!-- IDPs Pathways Across Sudan Section -->
  <div id="map-container">
    <h2 id="map-title-2">IDPs Pathways Across Sudan</h2>
    <div id="map2"></div>
  </div>
  <!-- Sankey Diagram Container -->
  <div id="sankey-container">
    <h2>Displacement Accommodation Types by State</h2>
    <div id="sankey-diagram"></div>
  </div>
 
  <!-- Country Circle Propagation Map -->
  <div class="maps-container">
    <div id="map-container">
      <h2>Displacement to Neighboring Countries</h2>
      <div id="country-circle-map"></div>
    </div>
  </div>

  <!-- Total Number of Returnees by State Section -->
  <div class="idps-frame-container">
    <!-- Map Container for Total Number of Returnees by State -->
    <div id="map-container-4">
      <h2 id="map-title-4">Total Number of Returnees by State</h2>
      <div id="map4"></div>
    </div>

    <!-- Text Container for Mobility in Sudan -->
    <div id="mobility-text-container">
      <h2>Mobility in Sudan</h2>
      <p>
        The <strong>Displacement Tracking Matrix (DTM)</strong> is a system designed to monitor displacement and population mobility. Over two years, <span class="data-point">11.6 million</span> people were displaced within Sudan due to the conflict between the Sudanese Armed Forces (SAF) and the Rapid Support Forces (RSF). Additionally, <span class="data-point">2 million</span> individuals fled to neighboring countries, making Sudan the world's largest displacement crisis.
      </p>
      <p>
        The Darfur states (Central, East, North, South, and West Darfur) have the highest numbers of internally displaced persons (IDPs). South Darfur leads with <span class="data-point">1.84 million</span> IDPs, followed by North Darfur with <span class="data-point">1.79 million</span> IDPs, reflecting decades of conflict and violence. Since December, DTM teams monitored <span class="data-point">396,738</span> individuals returning to their places of origin in Sudan, with most returnees moving to Aj Jazirah (66%), Sennar (29%), and Khartoum (5%).
      </p>
      <p>
        DTM also used <strong>Flow Monitoring</strong> to track movements across state borders. Aj Jazirah returnees were mostly from Gedaref (44%), Sennar (21%), and Kassala (11%). Sennar returnees primarily came from Gedaref (38%), Red Sea (19%), and Blue Nile (18%). Khartoum returnees mainly originated from River Nile (38%), Red Sea (34%), and White Nile (18%).
      </p>
      <p>
        These movements highlight the ongoing challenges faced by displaced populations in Sudan, as well as the efforts to track and support their return to stability. The data underscores the scale of the crisis and the need for continued humanitarian assistance.
      </p>
    </div>
  </div>

  <!-- Maps Container for Returnee Pathways -->
  <div class="maps-container">
    <div id="map-container-2">
      <h2 id="map-title">Returnee Pathways Across Sudan</h2>
      <div id="map"></div>
    </div>
  </div>

  <!-- Timeline and Map Container -->
  <div id="timeline-map-container">
    <!-- Timeline Graph Container -->
    <div id="timeline-container">
      <h2>Moblity Over Time (2023 - 2025)</h2>
      <canvas id="timelineChart"></canvas>
    </div>
  </div>

  <!-- Add image above the footer -->
  <img src="./data/doner.png" alt="Donor Logo" style="width: 100%; height: auto; display: block; margin: 0 auto;">

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 International Organization for Migration | IOM, UN Migration. Sudan | Displacement Tracking Matrix</p>
    <div class="footer-links">
      <a href="https://dtm.iom.int/sudan" target="_blank">Visit IOM Sudan Website</a> |
      <a href="https://displacement.iom.int/" target="_blank">DTM Global Website</a> |
    </div>
    <div class="footer-info">
      <p>For more information, please contact <a href="mailto:dtmsudan@iom.int">dtmsudan@iom.int</a>.</p>
    </div>
  </footer>

  <!-- External Scripts -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.10.0/mapbox-gl.js"></script>

  <script>
    // Define Mapbox custom layers
    const mapboxCustom1 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxCustom2 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxCustom3 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxCustom4 = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    // Initialize the first map
    const map = L.map('map').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the first map
    const cartoDBLight1 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap1 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery1 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner1 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    const mapboxLight = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/light-v10/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxStreets = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxSatellite = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    const mapboxOutdoors = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/outdoors-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
        attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        tileSize: 512,
        zoomOffset: -1,
        maxZoom: 18
    });

    // Add default base layer to the first map
    cartoDBLight1.addTo(map);

    // Add layer control to the first map
    const baseLayers1 = {
      "Mapbox Custom": mapboxCustom1,
      "CartoDB Light": cartoDBLight1,
      "OpenStreetMap": openStreetMap1,
      "Esri World Imagery": esriWorldImagery1,
      "Stamen Toner": stamenToner1,
      "Mapbox Light": mapboxLight,
      "Mapbox Streets": mapboxStreets,
      "Mapbox Outdoors": mapboxOutdoors,
      "Mapbox Satellite": mapboxSatellite
    };

    L.control.layers(baseLayers1).addTo(map);

    // Parse CSV data and create flow map layer for the first map
    Papa.parse('./data/data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        flowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => {
            const baseRadius = 6;
            const maxRadius = 20;
            const volume = feature.properties.e_Volume || 0;

            const radius = feature.properties.isOrigin
              ? baseRadius
              : Math.min(baseRadius + (volume / 5000), maxRadius);

            return {
              radius: radius,
              weight: 1,
              color: feature.properties.isOrigin ? '#FFFFFF' : '#FFFFFF',
              fillColor: feature.properties.isOrigin ? '#418FDE' : 'rgb(255, 103, 31)',
              fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
            };
          },
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
            ],
            defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: addTooltip
        }).addTo(map);

        // Add tooltip and popup to features
        function addTooltip(feature, layer) {
          const tooltipContent = feature.properties.isOrigin
            ? `State of Displacement: ${feature.properties.s_State}`
            : `State of Return: ${feature.properties.e_locality}`;

          layer.bindTooltip(tooltipContent);
          layer.on('mouseover', () => layer.openTooltip());
          layer.on('mouseout', () => layer.closeTooltip());

          // Add popup
          const popupContent = feature.properties.isOrigin
            ? `<b>State of Displacement:</b> ${feature.properties.s_State}`
            : `<b>State of Return:</b> ${feature.properties.e_locality}`;

          layer.bindPopup(popupContent);
        }

        // Highlight paths on mouseover
        flowmapLayer.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      }
    });

    // Add legend to the first map
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px">Returnee Flow Volume:</span><br/>
        <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> < 10000</span><br/>
        <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold">10,001 - 20,000</span><br/>
        <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> > 20,000</span><br/>
      `;
      return div;
    };
    legend.addTo(map);

    // Initialize the second map
    const map2 = L.map('map2').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the second map
    const cartoDBLight2 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap2 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery2 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner2 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the second map
    cartoDBLight2.addTo(map2);

    // Add layer control to the second map
    const baseLayers2 = {
      "Mapbox Custom": mapboxCustom2,
      "CartoDB Light": cartoDBLight2,
      "OpenStreetMap": openStreetMap2,
      "Esri World Imagery": esriWorldImagery2,
      "Stamen Toner": stamenToner2
    };

    L.control.layers(baseLayers2).addTo(map2);

    // Parse CSV data and create flow map layer for the second map
    Papa.parse('./data/data_idps.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection2 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.s_lon, datum.s_lat] },
            properties: datum
          }))
        };

        const flowmapLayer2 = L.canvasFlowmapLayer(geoJsonFeatureCollection2, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: (feature) => {
            const baseRadius = 12;
            const maxRadius = 6;
            const volume = feature.properties.e_Volume || 0;

            const radius = feature.properties.isOrigin
              ? baseRadius
              : Math.min(baseRadius + (volume / 5000), maxRadius);

            return {
              radius: radius,
              weight: 1,
              color: feature.properties.isOrigin ? '#FFFFFF' : '#FFFFFF',
              fillColor: feature.properties.isOrigin ? 'rgb(255, 103, 31)' : '#418FDE',
              fillOpacity: feature.properties.isOrigin ? 0.8 : 0.7
            };
          },
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 1, classMaxValue: 10000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5, lineCap: 'round', shadowColor: '#fee8c8', shadowBlur: 2.0 } },
              { classMinValue: 10001, classMaxValue: 20000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5, lineCap: 'round', shadowColor: '#fdbb84', shadowBlur: 2.0 } },
              { classMinValue: 20001, classMaxValue: 200000, symbol: { strokeStyle: '#d22630', lineWidth: 3, lineCap: 'round', shadowColor: '#e34a33', shadowBlur: 2.0 } }
            ],
            defaultSymbol: { strokeStyle: '#e7e1ef', lineWidth: 0.5, lineCap: 'round', shadowColor: '#e7e1ef', shadowBlur: 1.5 }
          },
          pathDisplayMode: 'all',
          animationStarted: true,
          animationEasingFamily: 'Linear',
          animationEasingType: 'None',
          animationDuration: 3000,
          onEachFeature: addTooltip
        }).addTo(map2);

        // Add tooltip and popup to features
        function addTooltip(feature, layer) {
          const tooltipContent = feature.properties.isOrigin
            ? `State of Displacement: ${feature.properties.s_State}`
            : `State of Return: ${feature.properties.e_locality}`;

          layer.bindTooltip(tooltipContent);
          layer.on('mouseover', () => layer.openTooltip());
          layer.on('mouseout', () => layer.closeTooltip());

          // Add popup
          const popupContent = feature.properties.isOrigin
            ? `<b>Displacement From:</b> ${feature.properties.s_State}`
            : `<b>Displacement To:</b> ${feature.properties.e_locality}`;

          layer.bindPopup(popupContent);
        }

        // Highlight paths on mouseover
        flowmapLayer2.on('mouseover', (e) => {
          if (e.sharedOriginFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedOriginFeatures, 'SELECTION_NEW');
          }
          if (e.sharedDestinationFeatures.length) {
            flowmapLayer2.selectFeaturesForPathDisplay(e.sharedDestinationFeatures, 'SELECTION_NEW');
          }
        });

        // Select initial feature for path display
        flowmapLayer2.selectFeaturesForPathDisplayById('s_state_id', "SD15", true, 'SELECTION_NEW');
      }
    });

    // Add legend to the second map
    const legend2 = L.control({ position: 'bottomright' });
    legend2.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px">Returnee Flow Volume:</span><br/>
        <div style="width:70px;height:3px;background:#ffb81c;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> < 10000</span><br/>
        <div style="width:70px;height:4px;background:#ff671f;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold">10,001 - 20,000</span><br/>
        <div style="width:70px;height:7px;background:#e34a33;float:left;margin-right:10px;margin-top:10px"></div>
        <span style="float:left;font-weight:bold"> > 20,000</span><br/>
      `;
      return div;
    };
    legend2.addTo(map2);

    // Initialize the third map
    const map3 = L.map('map3').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the third map
    const cartoDBLight3 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap3 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery3 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner3 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the third map
    cartoDBLight3.addTo(map3);

    // Add layer control to the third map
    const baseLayers3 = {
      "Mapbox Custom": mapboxCustom3,
      "CartoDB Light": cartoDBLight3,
      "OpenStreetMap": openStreetMap3,
      "Esri World Imagery": esriWorldImagery3,
      "Stamen Toner": stamenToner3
    };

    L.control.layers(baseLayers3).addTo(map3);

    // Parse CSV data and create animated markers for the third map
    Papa.parse('./data/total_idps.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection3 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.lon, datum.lat] },
            properties: datum
          }))
        };

        // Find the maximum total_idps value for normalization
        const maxTotalIdps = Math.max(...results.data.map(d => d.total_idps));

        // Function to animate circle markers
        function animateCircleMarker(marker, baseRadius) {
          const tween = new TWEEN.Tween({ radius: baseRadius })
            .to({ radius: baseRadius * 1.5 }, 1000) // Animate to 1.5x the base radius
            .easing(TWEEN.Easing.Sinusoidal.InOut) // Smooth easing
            .yoyo(true) // Reverse the animation
            .repeat(Infinity) // Repeat indefinitely
            .onUpdate(({ radius }) => {
              marker.setRadius(radius); // Update the marker's radius
            })
            .start(); // Start the animation
        }

        // Add animated markers to the third map
        L.geoJSON(geoJsonFeatureCollection3, {
          pointToLayer: (feature, latlng) => {
            // Normalize the total_idps value to determine the base radius
            const baseRadius = 8 + (feature.properties.total_idps / maxTotalIdps) * 20;

            // Create a circle marker
            const marker = L.circleMarker(latlng, {
              radius: baseRadius, // Initial radius
              fillColor: '#418FDE', // Blue color for IDPs
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });

            // Animate the marker
            animateCircleMarker(marker, baseRadius);

            return marker;
          },
          onEachFeature: (feature, layer) => {
            const popupContent = `
              <b>State:</b> ${feature.properties.state}<br/>
              <b>Total IDPs:</b> ${feature.properties.total_idps.toLocaleString()}
            `;
            layer.bindPopup(popupContent);

            // Add tooltip
            const tooltipContent = `<b>${feature.properties.state}</b><br/>
              <b>Total IDPs:</b> ${feature.properties.total_idps.toLocaleString()}`;
            layer.bindTooltip(tooltipContent);
          }
        }).addTo(map3);
      }
    });

    // Update Tween.js animations on each frame
    function animate() {
      requestAnimationFrame(animate);
      TWEEN.update();
    }
    animate(); // Start the animation loop

    // Add legend to the third map
    const legend3 = L.control({ position: 'bottomright' });
    legend3.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px; font-weight:bold;">Total IDPs by State:</span><br/>
        <div style="display: flex; align-items: center; margin-top: 10px;">
          <div style="width: 10px; height: 10px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">  < 500,000 IDPs</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 20px; height: 20px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;"> 500,001 - 1,000,000 IDPs</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 30px; height: 30px; background: #418FDE; border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;"> > 1,000,001 IDPs</span>
        </div>
      `;
      return div;
    };
    legend3.addTo(map3);
    // Initialize Timeline Graph
    const ctx = document.getElementById('timelineChart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
    gradient.addColorStop(0, '#FFFFFF');
    gradient.addColorStop(1, '#418FDE');

    const gradient2 = ctx.createLinearGradient(0, 0, 0, 200);
    gradient2.addColorStop(0, '#FFFFFF');
    gradient2.addColorStop(1, '#FF6384'); // Different color for the second dataset

    const timelineChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Aug-2023', 'Sep-2023', 'Oct-2023', 'Nov-2023', 'Dec-2023', 'Jan-2024', 'Feb-2024', 'Mar-2024', 'Apr-2024', 'May-2024', 'Jun-2024', 'Jul-2024', 'Aug-2024', 'Sep-2024', 'Oct-2024', 'Nov-2024', 'Dec-2024', 'Jan-2025', 'Feb-2025', 'Mar-2025'],
        datasets: [
          {
            label: 'IDPs Over Time ',
            data: [3801754, 4425083, 4856294, 5340863, 5942580, 6144363, 6397698, 6622565, 6786816, 10095054, 10540215, 10710015, 10834382, 10890722, 11018231, 11359005, 11532774,11568970,11585384,11301340],
            borderColor: '#82C4FF',
            backgroundColor: gradient,
            borderWidth: 3,
            fill: false,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#82C4FF',
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.4
          },
          {
            label: 'Returnees Over Time ',
            data: [0, 0, 0, 0, 0, 0,0, 0, 0, 0, 0, 0, 0, 0, 0, 0,0, 0, 0,396738], // Example data for the second dataset
            borderColor: '#FF671F', // Different color for the second dataset
            backgroundColor: gradient2,
            borderWidth: 3,
            fill: false,
            pointBackgroundColor: '#ffffff',
            pointBorderColor: '#FF671F',
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            backgroundColor: '#0033A0',
            titleColor: '#82C4FF',
            bodyColor: '#82C4FF',
            borderColor: '#82C4FF',
            borderWidth: 1,
            displayColors: false
          },
          legend: {
            display: true // Show legend to differentiate between datasets
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Total',
              color: '#82C4FF',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            grid: {
              color: '#e0e0e0'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Month',
              color: '#82C4FF',
              font: {
                size: 14,
                weight: 'bold'
              }
            },
            grid: {
              color: '#e0e0e0'
            }
          }
        },
        animation: {
          duration: 5000,
          easing:  'linear' ,
          delay: 300,              // 300ms delay before starting
          loop: false,             // Prevent repeating
          onProgress: (ctx) => {   // Callback during animation
            console.log(`${ctx.currentStep}/${ctx.numSteps}`);
          },
          onComplete: (ctx) => {   // Callback when done
            console.log('Animation finished!');
          }
        }
      }
    });

     
    // Initialize the fourth map
    const map4 = L.map('map4').setView([16, 30], L.Browser.mobile ? 3 : 5.5);

    // Define multiple base layers for the fourth map
    const cartoDBLight4 = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMap4 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImagery4 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenToner4 = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    // Add default base layer to the fourth map
    cartoDBLight4.addTo(map4);

    // Add layer control to the fourth map
    const baseLayers4 = {
      "Mapbox Custom": mapboxCustom4,
      "CartoDB Light": cartoDBLight4,
      "OpenStreetMap": openStreetMap4,
      "Esri World Imagery": esriWorldImagery4,
      "Stamen Toner": stamenToner4
    };

    L.control.layers(baseLayers4).addTo(map4);

    // Parse CSV data and create animated markers for the fourth map
    Papa.parse('./data/total_return.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: (results) => {
        const geoJsonFeatureCollection4 = {
          type: 'FeatureCollection',
          features: results.data.map(datum => ({
            type: 'Feature',
            geometry: { type: 'Point', coordinates: [datum.lon, datum.lat] },
            properties: datum
          }))
        };

        // Find the maximum total_return value for normalization
        const maxTotalReturn = Math.max(...results.data.map(d => d.total_return));

        // Function to animate circle markers
        function animateCircleMarker(marker, baseRadius) {
          const tween = new TWEEN.Tween({ radius: baseRadius })
            .to({ radius: baseRadius * 1.5 }, 1000) // Animate to 1.5x the base radius
            .easing(TWEEN.Easing.Sinusoidal.InOut) // Smooth easing
            .yoyo(true) // Reverse the animation
            .repeat(Infinity) // Repeat indefinitely
            .onUpdate(({ radius }) => {
              marker.setRadius(radius); // Update the marker's radius
            })
            .start(); // Start the animation
        }

        // Add animated markers to the fourth map
        L.geoJSON(geoJsonFeatureCollection4, {
          pointToLayer: (feature, latlng) => {
            // Normalize the total_return value to determine the base radius
            const baseRadius = 8 + (feature.properties.total_return / maxTotalReturn) * 20;

            // Create a circle marker
            const marker = L.circleMarker(latlng, {
              radius: baseRadius, // Initial radius
              fillColor: 'rgba(255, 103, 31, 0.8)', // Orange color for returnees
              color: '#fff',
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            });

            // Animate the marker
            animateCircleMarker(marker, baseRadius);

            return marker;
          },
          onEachFeature: (feature, layer) => {
            const popupContent = `
              <b>State:</b> ${feature.properties.state}<br/>
              <b>Total Returnees:</b> ${feature.properties.total_return.toLocaleString()}
            `;
            layer.bindPopup(popupContent);

            // Add tooltip
            const tooltipContent = `<b>${feature.properties.state}</b><br/>
              <b>Total Returnees:</b> ${feature.properties.total_return.toLocaleString()}`;
            layer.bindTooltip(tooltipContent);
          }
        }).addTo(map4);
      }
    });

    // Add legend to the fourth map
    const legend4 = L.control({ position: 'bottomright' });
    legend4.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <span style="font-size:14px; font-weight:bold;">Total Returnees by State:</span><br/>
        <div style="display: flex; align-items: center; margin-top: 10px;">
          <div style="width: 10px; height: 10px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">Small Circle: < 10,000 Returnees</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 20px; height: 20px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">Medium Circle: 10,000 - 50,000 Returnees</span>
        </div>
        <div style="display: flex; align-items: center; margin-top: 5px;">
          <div style="width: 30px; height: 30px; background: rgba(255, 103, 31, 0.8); border-radius: 50%; margin-right: 10px;"></div>
          <span style="font-size:12px;">Large Circle: > 50,000 Returnees</span>
        </div>
      `;
      return div;
    };
    legend4.addTo(map4);

    // Initialize the country circle map
      // Previous script content remains the same until the country circle map section
    // ...

    // Initialize the country circle map with layer controls
    const countryCircleMap = L.map('country-circle-map').setView([16, 30], 5);
    
    // Define multiple base layers for the country circle map
    const cartoDBLightCountry = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const openStreetMapCountry = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    });

    const esriWorldImageryCountry = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; <a href="https://www.esri.com/">Esri</a>'
    });

    const stamenTonerCountry = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner/{z}/{x}/{y}.png', {
      attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>'
    });

    const mapboxCustomCountry = L.tileLayer('https://api.mapbox.com/styles/v1/omerosman/cm8oy6is4006101si7ll3bs4h/tiles/{z}/{x}/{y}?access_token=pk.eyJ1Ijoib21lcm9zbWFuIiwiYSI6ImUxZDBkODBlNjQxMDE2M2Y3OTQ3MWIwNTJkMjgzZTI3In0.ekCHuxRflTOO0RpQ6rQR7Q', {
      attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
      tileSize: 512,
      zoomOffset: -1,
      maxZoom: 18
    });

    // Add default base layer to the country circle map
    cartoDBLightCountry.addTo(countryCircleMap);

    // Add layer control to the country circle map
    const baseLayersCountry = {
      "CartoDB Light": cartoDBLightCountry,
      "OpenStreetMap": openStreetMapCountry,
      "Esri World Imagery": esriWorldImageryCountry,
      "Stamen Toner": stamenTonerCountry,
      "Mapbox Custom": mapboxCustomCountry
    };

    L.control.layers(baseLayersCountry).addTo(countryCircleMap);

    // Country data with coordinates and volume
    const countryData = [
      {country: "Egypt", e_lat: 26.8206, e_lon: 30.8025, Volume: 1500000},
      {country: "libya", e_lat: 26.3351, e_lon: 17.2283, Volume: 105721},
      {country: "Chad", e_lat: 15.4542, e_lon: 18.7322, Volume: 767365},
      {country: "Central African Republic", e_lat: 6.6111, e_lon: 20.9394, Volume: 35376},
      {country: "South Sudan", e_lat: 6.877, e_lon: 31.307, Volume: 341909},
      {country: "Ethiopia", e_lat: 9.145, e_lon: 40.4897, Volume: 88001},
      {country: "Eritrea", e_lat: 15.1794, e_lon: 39.7823, Volume: 14141}
    ];

    // Find the maximum volume for scaling
    const maxVolume = Math.max(...countryData.map(d => d.Volume));

    // Create a layer group for the country circles
    const countryCirclesLayer = L.layerGroup().addTo(countryCircleMap);

    // Function to animate circle markers
    function animateCircleMarker(marker, baseRadius) {
      const tween = new TWEEN.Tween({ radius: baseRadius })
        .to({ radius: baseRadius * 1.5 }, 1500) // Animate to 1.5x the base radius
        .easing(TWEEN.Easing.Sinusoidal.InOut) // Smooth easing
        .yoyo(true) // Reverse the animation
        .repeat(Infinity) // Repeat indefinitely
        .onUpdate(({ radius }) => {
          marker.setRadius(radius); // Update the marker's radius
        })
        .start(); // Start the animation
    }

    // Add animated circle markers for each country to the layer group
    countryData.forEach(country => {
      // Calculate base radius based on volume (scaled to a reasonable size)
      const baseRadius = 5 + (country.Volume / maxVolume) * 30;
      
      // Create circle marker
      const circle = L.circleMarker([country.e_lat, country.e_lon], {
        radius: baseRadius,
        fillColor: '#5CB8B2',
        color: '#fff',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.7
      }).addTo(countryCirclesLayer);

      // Add animation
      animateCircleMarker(circle, baseRadius);

      // Add popup with country info
      circle.bindPopup(`
        <b>${country.country}</b><br>
        Volume: ${country.Volume.toLocaleString()}
      `);

      // Add tooltip
      circle.bindTooltip(`
        <b>${country.country}</b><br>
        Volume: ${country.Volume.toLocaleString()}
      `);
    });

    // Add overlay control for the country circles
    const overlaysCountry = {
      "Displacement Circles": countryCirclesLayer
    };

    // Add layer control with both base layers and overlays
    L.control.layers(baseLayersCountry, overlaysCountry).addTo(countryCircleMap);

    // Add legend for the country circle map
    const countryLegend = L.control({ position: 'bottomright' });
    countryLegend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>Displacement to Neighboring Countries</h4>
        <div style="display: flex; align-items: center; margin: 5px 0;">
          <svg width="20" height="20">
            <circle cx="10" cy="10" r="10" fill="#5CB8B2"/>
          </svg>
          Displaced Population
        </div>
        <p>Circle size represents relative volume</p>
      `;
      return div;
    };
    countryLegend.addTo(countryCircleMap);

    // Pie Chart Map Showing Displacement Proportions
    const map5 = L.map('map5').setView([16, 30], L.Browser.mobile ? 3 : 5.5);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map5);

    // State data with coordinates (lat, lng), displaced, total population
    const stateData = [
      ["Aj Jazirah", 14.900, 33.434, 876156, 5687557],
      ["Blue Nile", 11.270, 34.390, 270810, 1344267],
      ["Central Darfur", 12.900, 23.470, 749491, 1786503],
      ["East Darfur", 11.160, 26.140, 247874, 1213951],
      ["Gedaref", 14.040, 35.380, 14327, 2545604],
      ["Kassala", 15.450, 36.400, 6211, 2811446],
      ["Khartoum", 15.501, 32.560, 3500400, 9146191],
      ["North Darfur", 15.766, 27.333, 1844175, 2775652],
      ["North Kordofan", 13.630, 27.930, 91161, 2160476],
      ["Northern", 19.615, 30.416, 12052, 1023194],
      ["Red Sea", 19.580, 37.130, 30480, 1549857],
      ["River Nile", 18.500, 33.800, 53683, 1651873],
      ["Sennar", 13.550, 33.600, 244250, 2170863],
      ["South Darfur", 11.783, 24.883, 2082537, 3912372],
      ["South Kordofan", 11.150, 29.633, 414734, 2017962],
      ["West Darfur", 12.900, 22.466, 368971, 1940860],
      ["West Kordofan", 11.200, 28.433, 314484, 1713462],
      ["White Nile", 13.450, 32.500, 179544, 3046811]
    ];

    // Create pie chart icon function with standardized size
    function createPieChartIcon(displaced, total) {
      const displacedPercent = displaced / total;
      const endAngle = displacedPercent * 360;
      
      // Use a fixed radius for all pie charts (e.g., 16 pixels)
      const radius = 30;
      
      const svg = `
        <svg width="${radius * 2}" height="${radius * 2}" viewBox="0 0 32 32">
          <circle cx="16" cy="16" r="16" fill="#418FDE"/>
          <path d="M16,16 L16,0 A16,16 0 ${endAngle > 180 ? 1 : 0},1 
            ${16 + Math.sin((endAngle * Math.PI)/180) * 16},
            ${16 - Math.cos((endAngle * Math.PI)/180) * 16} z" 
            fill="rgba(255, 103, 31, 0.8)"/>
          <circle cx="16" cy="16" r="12" fill="white" opacity="0.7"/>
          <text x="16" y="16" text-anchor="middle" dominant-baseline="middle" 
                font-size="8" font-weight="bold" fill="#82C4FF">
            ${Math.round(displacedPercent * 100)}%
          </text>
        </svg>
      `;

      return L.divIcon({
        html: svg,
        iconSize: [radius * 2, radius * 2],
        className: 'pie-chart-marker'
      });
    }

    // Add markers with standardized pie charts
    stateData.forEach(state => {
      const [name, lat, lng, displaced, total] = state;
      
      L.marker([lat, lng], {
        icon: createPieChartIcon(displaced, total)
      }).addTo(map5).bindPopup(`
        <b>${name}</b><br>
        Total Population: ${total.toLocaleString()}<br>
        Displaced: ${displaced.toLocaleString()} (${((displaced/total)*100).toFixed(1)}%)<br>
        Non-Displaced: ${(total - displaced).toLocaleString()}
      `);
    });

    // Add legend
    const legend5 = L.control({position: 'bottomright'});
    legend5.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <h4>Displacement Proportions</h4>
        <div style="display: flex; align-items: center; margin: 5px 0;">
          <svg width="20" height="20">
            <circle cx="10" cy="10" r="10" fill="rgba(255, 103, 31, 0.8)"/>
          </svg>
          Displaced Population
        </div>
        <div style="display: flex; align-items: center; margin: 5px 0;">
          <svg width="20" height="20">
            <circle cx="10" cy="10" r="10" fill="#418FDE"/>
          </svg>
          Non-Displaced Population
        </div>
        <p>All pie charts are the same size<br>showing proportion displaced</p>
      `;
      return div;
    };
    legend5.addTo(map5);
    
    // Create Sankey diagram for displacement accommodation types
    const sankeyData = {
      // Define nodes (states and accommodation types)
      nodes: [
        // States
        { node: 0, name: "Aj Jazirah", color: "#1f77b4" },
        { node: 1, name: "Blue Nile", color: "#ff7f0e" },
        { node: 2, name: "Central Darfur", color: "#2ca02c" },
        { node: 3, name: "East Darfur", color: "#d62728" },
        { node: 4, name: "Gedaref", color: "#9467bd" },
        { node: 5, name: "Kassala", color: "#8c564b" },
        { node: 6, name: "Khartoum", color: "#e377c2" },
        { node: 7, name: "North Darfur", color: "#7f7f7f" },
        { node: 8, name: "North Kordofan", color: "#bcbd22" },
        { node: 9, name: "Northern", color: "#17becf" },
        { node: 10, name: "Red Sea", color: "#aec7e8" },
        { node: 11, name: "River Nile", color: "#ffbb78" },
        { node: 12, name: "Sennar", color: "#98df8a" },
        { node: 13, name: "South Darfur", color: "#ff9896" },
        { node: 14, name: "South Kordofan", color: "#c5b0d5" },
        { node: 15, name: "West Darfur", color: "#c49c94" },
        { node: 16, name: "West Kordofan", color: "#f7b6d2" },
        { node: 17, name: "White Nile", color: "#c7c7c7" },
        
        // Accommodation types
        { node: 18, name: "Camp (formal)", color: "#1f77b4" },
        { node: 19, name: "In Host Family/Community", color: "#ff7f0e" },
        { node: 20, name: "In Rented accommodation", color: "#2ca02c" },
        { node: 21, name: "Improvised/critical shelters", color: "#d62728" },
        { node: 22, name: "In schools or other public buildings", color: "#9467bd" },
        { node: 23, name: "Gathering sites (informal settlements)", color: "#8c564b" }
      ],
      
      // Define links (flows between states and accommodation types)
      links: [
        // Aj Jazirah
        { source: 0, target: 18, value: 32814 },
        { source: 0, target: 19, value: 84 },
        { source: 0, target: 20, value: 40 },
        { source: 0, target: 21, value: 31427 },
        { source: 0, target: 22, value: 1971 },
        
        // Blue Nile
        { source: 1, target: 18, value: 64938 },
        { source: 1, target: 19, value: 5711 },
        { source: 1, target: 20, value: 1829 },
        { source: 1, target: 21, value: 4929 },
        { source: 1, target: 22, value: 13809 },
        
        // Central Darfur
        { source: 2, target: 18, value: 33425 },
        { source: 2, target: 19, value: 100 },
        { source: 2, target: 20, value: 3300 },
        { source: 2, target: 21, value: 18353 },
        { source: 2, target: 22, value: 75715 },
        
        // East Darfur
        { source: 3, target: 18, value: 106249 },
        { source: 3, target: 19, value: 2436 },
        { source: 3, target: 20, value: 3100 },
        { source: 3, target: 21, value: 20128 },
        { source: 3, target: 22, value: 8424 },
        
        // Gedaref
        { source: 4, target: 18, value: 134735 },
        { source: 4, target: 19, value: 21466 },
        { source: 4, target: 20, value: 1128 },
        { source: 4, target: 21, value: 12626 },
        { source: 4, target: 22, value: 1564 },
        
        // Kassala
        { source: 5, target: 18, value: 42519 },
        { source: 5, target: 19, value: 8299 },
        { source: 5, target: 21, value: 13056 },
        { source: 5, target: 22, value: 766 },
        
        // Khartoum
        { source: 6, target: 18, value: 17406 },
        { source: 6, target: 19, value: 1722 },
        { source: 6, target: 20, value: 559 },
        { source: 6, target: 21, value: 1243 },
        { source: 6, target: 22, value: 283 },
        
        // North Darfur
        { source: 7, target: 18, value: 103599 },
        { source: 7, target: 19, value: 2541 },
        { source: 7, target: 20, value: 5909 },
        { source: 7, target: 21, value: 20560 },
        { source: 7, target: 22, value: 92791 },
        
        // North Kordofan
        { source: 8, target: 18, value: 31273 },
        { source: 8, target: 19, value: 1183 },
        { source: 8, target: 20, value: 262 },
        { source: 8, target: 21, value: 1606 },
        { source: 8, target: 22, value: 3972 },
        
        // Northern
        { source: 9, target: 18, value: 91951 },
        { source: 9, target: 19, value: 16084 },
        { source: 9, target: 20, value: 3144 },
        { source: 9, target: 21, value: 3405 },
        { source: 9, target: 22, value: 2179 },
        
        // Red Sea
        { source: 10, target: 18, value: 17088 },
        { source: 10, target: 19, value: 20061 },
        { source: 10, target: 20, value: 2783 },
        { source: 10, target: 21, value: 8351 },
        { source: 10, target: 22, value: 2476 },
        
        // River Nile
        { source: 11, target: 18, value: 119057 },
        { source: 11, target: 19, value: 42179 },
        { source: 11, target: 20, value: 2065 },
        { source: 11, target: 21, value: 8107 },
        { source: 11, target: 22, value: 14744 },
        
        // Sennar
        { source: 12, target: 18, value: 23015 },
        { source: 12, target: 19, value: 404 },
        { source: 12, target: 21, value: 1027 },
        { source: 12, target: 22, value: 1796 },
        
        // South Darfur
        { source: 13, target: 18, value: 89699 },
        { source: 13, target: 19, value: 1513 },
        { source: 13, target: 20, value: 6014 },
        { source: 13, target: 21, value: 26293 },
        { source: 13, target: 22, value: 73581 },
        
        // South Kordofan
        { source: 14, target: 18, value: 44687 },
        { source: 14, target: 19, value: 1500 },
        { source: 14, target: 20, value: 247 },
        { source: 14, target: 21, value: 7803 },
        { source: 14, target: 22, value: 30135 },
        
        // West Darfur
        { source: 15, target: 18, value: 13293 },
        { source: 15, target: 19, value: 826 },
        { source: 15, target: 20, value: 25097 },
        { source: 15, target: 21, value: 1353 },
        { source: 15, target: 22, value: 9580 },
        
        // West Kordofan
        { source: 16, target: 18, value: 42604 },
        { source: 16, target: 19, value: 280 },
        { source: 16, target: 20, value: 280 },
        { source: 16, target: 21, value: 5548 },
        { source: 16, target: 22, value: 26432 },
        
        // White Nile
        { source: 17, target: 18, value: 68912 },
        { source: 17, target: 19, value: 10703 },
        { source: 17, target: 20, value: 482 },
        { source: 17, target: 21, value: 20989 },
        { source: 17, target: 22, value: 25114 }
      ]
    };

    // Create the Sankey diagram
    const sankeyLayout = {
      
      font: {
        size: 12,
        color: "#333"
      },
      margin: {
        t: 50,
        l: 50,
        r: 50,
        b: 50
      },
      height: 650,
      width: 1000
    };

    Plotly.newPlot('sankey-diagram', [{
      type: "sankey",
      orientation: "h",
      node: {
        pad: 15,
        thickness: 30,
        line: {
          color: "black",
          width: 0.5
        },
        label: sankeyData.nodes.map(node => node.name),
        color: sankeyData.nodes.map(node => node.color)
      },
      link: {
        source: sankeyData.links.map(link => link.source),
        target: sankeyData.links.map(link => link.target),
        value: sankeyData.links.map(link => link.value),
        color: sankeyData.links.map(link => {
          // Use the source node color for the link
          const sourceNode = sankeyData.nodes.find(node => node.node === link.source);
          return sourceNode ? sourceNode.color + "80" : "#aaa"; // Add transparency
        })
      }
    }], sankeyLayout);
  </script>
</body>
</html>
