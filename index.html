  <!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="description" content="Flow Map" />

  <style>
    /* Apply space around the page */
    body {
      margin: 20px;
      padding: 0;
      font-family: Arial, sans-serif;
    }

    /* Title Styling */
    #title {
      text-align: center;
      padding: 20px;
      background-color: #f0f0f0;
      margin-bottom: 20px;
    }

    #title h1 {
      margin: 0;
      font-size: 24px;
      color: #2a9d8f;
    }

    /* Map Container Styling */
    #map {
      height: calc(100vh - 120px);
    }

    /* Card Styling */
    #displacementCard {
      position: absolute;
      bottom: 50px;
      right: 20px;
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
    }

    /* Ensure full-page map */
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      right: 0;
      left: 0;
    }
  </style>

  <!-- Load Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>

<body>
  <!-- Map container -->
  <div id="map"></div>

  <!-- Load LeafletJS -->
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <!-- Load Esri Leaflet for Esri basemap -->
  <script src="https://unpkg.com/esri-leaflet@3.0.0/dist/esri-leaflet.js"></script>
  <!-- Load Tween.js for animation -->
  <script src="https://unpkg.com/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>
  <!-- Load CanvasFlowMapLayer for flow visualization -->
  <script src="./src/CanvasFlowmapLayer.js"></script>
  <!-- Load PapaParse for CSV data parsing -->
  <script src="https://unpkg.com/papaparse@5.3.0/papaparse.min.js"></script>

  <script>
    // Initialize the map
    var map = L.map('map');

    // Set map view based on device type
    if (L.Browser.mobile) {
      map.setView([16, 32], 3);
    } else {
      map.setView([16, 31], 6);
    }

    // Add base map layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; CartoDB'
    }).addTo(map);

    // Add administrative boundary layer (country borders)
    var admn0 = L.esri.featureLayer({
      url: "https://codgis.itos.uga.edu/arcgis/rest/services/COD_External/SDN_EN/MapServer/2",
      where: "ADMLEVEL = 0",
      style: { color: "gray", weight: 2, dashArray: "2, 3" }
    });
    admn0.addTo(map);

    // Parse CSV data containing displacement flow information
    Papa.parse('./data/data.csv', {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: function(results) {
        // Convert CSV data into GeoJSON format
        var geoJsonFeatureCollection = {
          type: 'FeatureCollection',
          features: results.data.map(function(datum) {
            return {
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: [datum.s_lon, datum.s_lat]
              },
              properties: datum
            }
          })
        };

        // Create flow map layer
        var oneToManyFlowmapLayer = L.canvasFlowmapLayer(geoJsonFeatureCollection, {
          originAndDestinationFieldIds: {
            originUniqueIdField: 's_state_id',
            originGeometry: { x: 's_lon', y: 's_lat' },
            destinationUniqueIdField: 'e_locality_id',
            destinationGeometry: { x: 'e_lon', y: 'e_lat' }
          },
          style: function(geoJsonFeature) {
            if (geoJsonFeature.properties.isOrigin) {
              return { radius: 6, weight: 1, color: 'rgb(17, 142, 170)', fillColor: 'rgba(0, 51, 160)', fillOpacity: 0.8 };
            } else {
              return { radius: 6, weight: 1, color: 'rgb(195, 255, 62)', fillColor: 'rgb(255, 103, 31)', fillOpacity: 0.7 };
            }
          },
          // Define path styles based on flow volume
          canvasBezierStyle: {
            type: 'classBreaks',
            field: 'e_Volume',
            classBreakInfos: [
              { classMinValue: 0, classMaxValue: 80000, symbol: { strokeStyle: '#ffb81c', lineWidth: 0.5 } },
              { classMinValue: 80001, classMaxValue: 160000, symbol: { strokeStyle: '#ff671f', lineWidth: 1.5 } },
              { classMinValue: 160001, classMaxValue: 10000000, symbol: { strokeStyle: '#d22630', lineWidth: 3 } }
            ]
          },
          pathDisplayMode: 'continuous',
          animationStarted: true,
          animationDuration: 2000,
          onEachFeature: TooltipName,
        }).addTo(map);

        // Function to show tooltips on hover
        function TooltipName(feature, layer) {
          layer.on('mouseover', function () { this.openPopup(); });
          layer.on('mouseout', function () { this.closePopup(); });
          layer.bindTooltip(feature.properties.isOrigin ? "State of Displacement: " + feature.properties.s_State : "State of Return: " + feature.properties.e_locality);
        }
      }
    });

    // Add legend to the map
    var legend = L.control({ position: 'bottomleft' });
    legend.onAdd = function (map) {
      var div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<span>Legend:</span><br>';
      return div;
    };
    legend.addTo(map);
  </script>
</body>

</html>
